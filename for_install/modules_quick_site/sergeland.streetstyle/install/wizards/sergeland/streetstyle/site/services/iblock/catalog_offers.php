<?if(!defined("B_PROLOG_INCLUDED")||B_PROLOG_INCLUDED!==true)die();if(!CModule::IncludeModule("iblock"))return;if(!CModule::IncludeModule("catalog"))return;$useSKUPrice=$wizard->GetVar("useSKUPrice")=="Y"?true:false;if(!$useSKUPrice||$_SESSION["CATALOG_PRODUCT_ID"]<1)return;@copy(WIZARD_ABSOLUTE_PATH."/site/services/iblock/xml/".LANGUAGE_ID."/catalog_sku_tpl.xml",WIZARD_ABSOLUTE_PATH."/site/services/iblock/xml/".LANGUAGE_ID."/catalog_sku.xml");CWizardUtil::ReplaceMacros(WIZARD_ABSOLUTE_PATH."/site/services/iblock/xml/".LANGUAGE_ID."/catalog_sku.xml",Array("CATALOG_XML_ID"=>htmlspecialchars("catalog-streetstyle-".ToLower(WIZARD_SITE_ID)),));$iblockXMLFile=WIZARD_SERVICE_RELATIVE_PATH."/xml/".LANGUAGE_ID."/catalog_sku.xml";$iblockXMLFilePrices=WIZARD_SERVICE_RELATIVE_PATH."/xml/".LANGUAGE_ID."/catalog_prices_sku.xml";$iblockType="offers";$iblockID=$wizard->GetVar("catalogPriceID");$rsIBlockFur=CIBlock::GetList(array(),array("ID"=>$_SESSION["CATALOG_PRODUCT_ID"]));if($arIBlockFur=$rsIBlockFur->Fetch())
$iblockCodeFur=$arIBlockFur["ID"];else return;$permissions=Array("1"=>"X","2"=>"R");$dbGroup=CGroup::GetList($by="",$order="",Array("STRING_ID"=>"sale_administrator"));if($arGroup=$dbGroup->Fetch())
$permissions[$arGroup["ID"]]='W';$dbGroup=CGroup::GetList($by="",$order="",Array("STRING_ID"=>"content_editor"));if($arGroup=$dbGroup->Fetch())
$permissions[$arGroup["ID"]]='W';$iblockID=WizardServices_SERGELAND::ImportIBlockFromXML($iblockXMLFile,$iblockType,$iblockID,WIZARD_SITE_ID,$permissions,WIZARD_INSTALL_DEMO_DATA);if($iblockID<1)
return;WizardServices_SERGELAND::ImportIBlockFromXML($iblockXMLFilePrices,false,$iblockID,WIZARD_SITE_ID,$permissions,WIZARD_INSTALL_DEMO_DATA);$arPropsToDelete=array("CML2_BAR_CODE","CML2_ARTICLE","CML2_ATTRIBUTES","CML2_TRAITS","CML2_BASE_UNIT","CML2_TAXES","MORE_PHOTO","FILES","CML2_MANUFACTURER",);foreach($arPropsToDelete as $code)
{$dbProperty=CIBlockProperty::GetList(Array(),Array("IBLOCK_ID"=>$iblockID,"CODE"=>$code));if($arProperty=$dbProperty->GetNext())
CIBlockProperty::Delete($arProperty["ID"]);}
$iblock=new CIBlock;$arFields=Array("ACTIVE"=>"Y","FIELDS"=>array('IBLOCK_SECTION'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'ACTIVE'=>array('IS_REQUIRED'=>'Y','DEFAULT_VALUE'=>'Y',),'ACTIVE_FROM'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'ACTIVE_TO'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'SORT'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'NAME'=>array('IS_REQUIRED'=>'Y','DEFAULT_VALUE'=>'',),'PREVIEW_PICTURE'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>array('FROM_DETAIL'=>'N','DELETE_WITH_DETAIL'=>'N','UPDATE_WITH_DETAIL'=>'N','SCALE'=>'N','WIDTH'=>'','HEIGHT'=>'','IGNORE_ERRORS'=>'N','METHOD'=>'resample','COMPRESSION'=>95,),),'PREVIEW_TEXT_TYPE'=>array('IS_REQUIRED'=>'Y','DEFAULT_VALUE'=>'text',),'PREVIEW_TEXT'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'DETAIL_PICTURE'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>array('SCALE'=>'N','WIDTH'=>'','HEIGHT'=>'','IGNORE_ERRORS'=>'N','METHOD'=>'resample','COMPRESSION'=>95,),),'DETAIL_TEXT_TYPE'=>array('IS_REQUIRED'=>'Y','DEFAULT_VALUE'=>'text',),'DETAIL_TEXT'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'XML_ID'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'CODE'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>array('UNIQUE'=>'Y','TRANSLITERATION'=>'Y','TRANS_LEN'=>100,'TRANS_CASE'=>'L','TRANS_SPACE'=>'-','TRANS_OTHER'=>'-','TRANS_EAT'=>'Y','USE_GOOGLE'=>'Y',),),'TAGS'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'SECTION_NAME'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'SECTION_PICTURE'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>array('FROM_DETAIL'=>'N','SCALE'=>'N','WIDTH'=>'','HEIGHT'=>'','IGNORE_ERRORS'=>'N','METHOD'=>'resample','COMPRESSION'=>95,'DELETE_WITH_DETAIL'=>'N','UPDATE_WITH_DETAIL'=>'N',),),'SECTION_DESCRIPTION_TYPE'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'text',),'SECTION_DESCRIPTION'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'SECTION_DETAIL_PICTURE'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>array('SCALE'=>'N','WIDTH'=>'','HEIGHT'=>'','IGNORE_ERRORS'=>'N','METHOD'=>'resample','COMPRESSION'=>95,),),'SECTION_XML_ID'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>'',),'SECTION_CODE'=>array('IS_REQUIRED'=>'N','DEFAULT_VALUE'=>array('UNIQUE'=>'Y','TRANSLITERATION'=>'Y','TRANS_LEN'=>100,'TRANS_CASE'=>'L','TRANS_SPACE'=>'-','TRANS_OTHER'=>'-','TRANS_EAT'=>'Y','USE_GOOGLE'=>'Y',),),),);$iblock->Update($iblockID,$arFields);$dbSite=CSite::GetByID(WIZARD_SITE_ID);if($arSite=$dbSite->Fetch())
$lang=$arSite["LANGUAGE_ID"];if(strlen($lang)<=0)
$lang="ru";WizardServices::IncludeServiceLang("catalog_offers.php",$lang);$ID_SKU=CCatalog::LinkSKUIBlock($iblockCodeFur,$iblockID);if($ID_SKU)
{$el=new CIBlockProperty();if(!$el->Update($ID_SKU,array("NAME"=>GetMessage("WZD_OPTION_CATALOG_1"),"USER_TYPE"=>"SKU","IS_REQUIRED"=>"Y","USER_TYPE_SETTINGS"=>array("SHOW_ADD"=>"N","IBLOCK_MESS"=>"N","VIEW"=>"E","MAX_WIDTH"=>0,"MIN_HEIGHT"=>24,"MAX_HEIGHT"=>1000,"BAN_SYM"=>",;","REP_SYM"=>"","OTHER_REP_SYM"=>"",),"HINT"=>GetMessage("WZD_OPTION_CATALOG_2"),)))die($el->LAST_ERROR);}
$arCatalog=CCatalog::GetByID($iblockID);if($arCatalog)
CCatalog::Update($iblockID,array('PRODUCT_IBLOCK_ID'=>$iblockCodeFur,'SKU_PROPERTY_ID'=>$ID_SKU));else
CCatalog::Add(array('IBLOCK_ID'=>$iblockID,'PRODUCT_IBLOCK_ID'=>$iblockCodeFur,'SKU_PROPERTY_ID'=>$ID_SKU));$arProperty=Array();$dbProperty=CIBlockProperty::GetList(Array(),Array("IBLOCK_ID"=>$iblockID));while($arProp=$dbProperty->Fetch())
$arProperty[$arProp["CODE"]]=$arProp["ID"];CUserOptions::SetOption("form","form_element_".$iblockID,array('tabs'=>'edit1--#--'.GetMessage("WZD_OPTION_CATALOG_3").'--,'.'--ACTIVE--#--'.GetMessage("WZD_OPTION_CATALOG_4").'--,'.'--NAME--#--'.GetMessage("WZD_OPTION_CATALOG_5").'--,'.'--PROPERTY_'.$arProperty["CML2_LINK"].'--#--'.GetMessage("WZD_OPTION_CATALOG_6").'--,'.'--PROPERTY_'.$arProperty["COLOR"].'--#--'.GetMessage("WZD_OPTION_CATALOG_7").'--,'.'--PROPERTY_'.$arProperty["SIZE"].'--#--'.GetMessage("WZD_OPTION_CATALOG_8").'--,'.'--PROPERTY_'.$arProperty["ARTNUMBER"].'--#--'.GetMessage("WZD_OPTION_CATALOG_9").'--,'.'--CATALOG--#--'.GetMessage("WZD_OPTION_CATALOG_10").'--;'.'--cedit1--#--'.GetMessage("WZD_OPTION_CATALOG_11").'--,'.'--XML_ID--#--'.GetMessage("WZD_OPTION_CATALOG_12").'--;'.'--',));CUserOptions::SetOption("form","form_subelement_".$iblockID,array('tabs'=>'sub_edit1--#--'.GetMessage("WZD_OPTION_CATALOG_13").'--,'.'--SUB_ACTIVE--#--'.GetMessage("WZD_OPTION_CATALOG_14").'--,'.'--SUB_NAME--#--'.GetMessage("WZD_OPTION_CATALOG_15").'--,'.'--PROPERTY_'.$arProperty["COLOR"].'--#--'.GetMessage("WZD_OPTION_CATALOG_16").'--,'.'--PROPERTY_'.$arProperty["SIZE"].'--#--'.GetMessage("WZD_OPTION_CATALOG_17").'--,'.'--PROPERTY_'.$arProperty["ARTNUMBER"].'--#--'.GetMessage("WZD_OPTION_CATALOG_18").'--,'.'--CATALOG--#--'.GetMessage("WZD_OPTION_CATALOG_19").'--;'.'--',));$res=CIBlock::GetByID($iblockID);$ar_res=$res->GetNext();$iblockType=$ar_res["IBLOCK_TYPE_ID"];$dbPriceType=CCatalogGroup::GetList(array(),array("BASE"=>"Y"));$arPriceType=$dbPriceType->Fetch();CUserOptions::SetOption("list","tbl_iblock_list_".md5($iblockType.".".$iblockID),array('columns'=>'NAME,'.'PROPERTY_'.$arProperty["CML2_LINK"].','.'CATALOG_GROUP_'.$arPriceType["ID"].','.'ACTIVE,'.'ID','by'=>'PROPERTY_'.$arProperty["CML2_LINK"],'order'=>'asc','page_size'=>'20',));COption::SetOptionInt("streetstyle","catalogPriceID",$iblockID,false,WIZARD_SITE_ID);WizardServices::ReplaceMacrosRecursive(WIZARD_SITE_PATH."/catalog/",array("LINK_IBLOCK_TYPE"=>$iblockType,"LINK_IBLOCK_ID"=>$iblockID));WizardServices::ReplaceMacrosRecursive(WIZARD_SITE_PATH."/actions/",array("LINK_IBLOCK_TYPE"=>$iblockType,"LINK_IBLOCK_ID"=>$iblockID));WizardServices::ReplaceMacrosRecursive(WIZARD_SITE_PATH."/new/",array("LINK_IBLOCK_TYPE"=>$iblockType,"LINK_IBLOCK_ID"=>$iblockID));WizardServices::ReplaceMacrosRecursive(WIZARD_SITE_PATH."/sale/",array("LINK_IBLOCK_TYPE"=>$iblockType,"LINK_IBLOCK_ID"=>$iblockID));?>