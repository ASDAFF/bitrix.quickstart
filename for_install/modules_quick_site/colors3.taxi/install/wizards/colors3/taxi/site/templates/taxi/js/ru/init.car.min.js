jQuery(document).ready(function(b){var a=function(d,e,f){var c="/include/street_search.php";b.ajax({url:c,type:"get",dataType:"json",data:{term:d,city_from:b("#FIELD_CITY_OTKUDA").val(),city_to:b("#FIELD_CITY_KUDA").val(),type_field:e.inputField},success:function(g){f(g)}})};b.widget("ThreeColors.geo_autocomplete",{_init:function(){this.options._cache={};this.element.autocomplete(this.options)._renderItem=function(d,c){return b("<li></li>").data("item.autocomplete",c).append(this.options.getItemHTML(c)).appendTo(d)}},options:{minLength:3,delay:300,inputType:"street",source:function(d,e){var i=this.options.city.val()||window.city;var f=this.options.house.val()||"";var g=this.options.housing.val()||"";if(this.options.inputType==="street"&&i.length>0){d.term=i+", "+d.term}else{if(this.options.inputType==="locality"){d.term="Россия, "+d.term}else{if(this.options.inputType==="city"){d.term="Россия, город"+d.term}}}if(d.term in this.options._cache){e(this.options._cache[d.term])}else{var c=this;var h=d.term;if(window.autocomplete){taxi.suggestCaller.search(h,function(j){if(!j){return}c.options._cache[d.term]=j.variants;e(j.variants)})}else{a(d.term,this.options,function(j){c.options._cache[d.term]=j;e(j)})}}},getItemHTML:function(c){return c.label.replace(/,/gi,",<br/>")}}});b(".control-group input").keypress(function(c){var g=b(this);var f=1000;var e=g.closest(".CITY_OTKUDA-group").length>0||g.closest(".FROM_HOUSE-group").length>0;if(c.keyCode===13){c.stopPropagation();c.preventDefault();taxi.updateRoute(e)}else{g.data("locked",true);g.data("pushed",true);function d(h){setTimeout(function(){if(h.data("pushed")&&!h.data("locked")){taxi.updateRoute(e);h.data("pushed",false);h.data("locked",false)}else{if(h.data("pushed")&&h.data("locked")){h.data("locked",false);d(h)}}},f)}d(g)}});b("#map").each(function(){var l=b("#FIELD_FROM");var m=b("#FIELD_FROM_HOUSE");var n=b("#FIELD_FROM_HOUSING");var h=b("#FIELD_CITY_OTKUDA");var i=b(".FROM_HOUSE-group");var e=b("#FIELD_TO");var c=b("#FIELD_TO_HOUSE");var d=b("#FIELD_TO_HOUSING");var j=b("#FIELD_CITY_KUDA");var s=b(".TO_HOUSE-group");function f(v){if(typeof(v.city)!=="undefined"&&v.city!==null&&v.city!==window.city){var w=v.city}else{var w=window.city}return(w)?w:""}function k(v,w){if(!v){return}w=w||"";if(!v.changed){v.value=v.street;v.changed=true}if(w.indexOf("value")<0){l.val(v.value)}if(w.indexOf("city")<0){h.val(v.city)}if(w.indexOf("house")<0){m.val(v.house)}if(w.indexOf("housing")<0){n.val(v.housing)}return v}function q(v,w){if(!v){return}w=w||"";if(!v.changed){v.value=v.street;v.changed=true}if(w.indexOf("value")<0){e.val(v.value)}if(w.indexOf("city")<0){j.val(v.city)}if(w.indexOf("house")<0){c.val(v.house)}if(w.indexOf("housing")<0){d.val(v.housing)}return v}function o(){if(!l.val()){h.val(window.city)}else{i.show()}if(!e.val()){j.val(window.city)}else{s.show()}}function p(){taxi.callCost=function(x){var w=b("#tariff_travel option:selected").data("mileage");var v=b("#tariff_travel option:selected").data("landing");var y=b("#tariff_travel option:selected").data("included");var B=b("#tariff_travel option:selected").data("minpricecity");var A=0;var z=0;b(".dop_input:checked").each(function(){z+=Math.round(b(this).data("cost"))});if((x/1000)>y){A=v+(x/1000-y)*w}else{A=v}if(B>A){A=B}return A+z};taxi.init({mapcontainer:"map",map:window.geoservice,googlemaptoken:"",geocoder:window.geoservice,city:window.city,startInput:k,endInput:q,region:"ru",routeinfo:function(v){var w=v.length;var x=v.time;var y=taxi.callCost(w);b("#list").html('<div class="control-group rez"><label class="control-label"><span class="rect"></span></label><div class="controls"><p>Ехать '+Math.round(w/1000)+" км</p><p>С учетом пробок "+Math.round(x/60)+' мин.</p><p>Примерная стоимость <span id="cost_order" style="color: white;">'+Math.round(y)+'</span> руб.</p><span id="range_travel" style="display: none;">'+Math.round(w/1000)+"</span></div></div>")}});b("#tariff_travel").on("change",function(){var v=taxi.callCost(0);b("#cost_order").text(v)});b(".dop_input").on("change",function(){var v=parseInt(b("#cost_order").text());if(b(this).is(":checked")){b("#cost_order").text(v+Math.round(b(this).data("cost")))}else{b("#cost_order").text(v-Math.round(b(this).data("cost")))}})}function u(){b.each([h,j],function(){b(this).on("blur",function(){var v=b(this);if(b.trim(v.val()).length===0){v.val(window.city)}})})}function g(){if(geo_position_js.init()){var v=b("#find-me");peloader=b("<img>").attr("src","/preloader.gif").css({margin:"7px 5px 0 -24px","float":"right"});v.html('<img src="target.png" />').css({cursor:"pointer",color:"#08c"}).before(peloader.hide()).on("click",function(w){v.hide();w.preventDefault();peloader.show();i.show();geo_position_js.getCurrentPosition(function(x){taxi.mypos(x,function(){peloader.hide();v.show()})},function(){})})}}p();o();u();g();function t(x){x.cityInput.geo_autocomplete({city:x.cityInput,house:x.houseInput,housing:x.housingInput,inputType:"locality",close:function(z,A){var B=(x.wayPointIndex==0);taxi.updateRoute(B);var y=x.cityInput.val()+"";y=y.replace(/,.*$/g,"");x.cityInput.val(y)}});x.streetInput.geo_autocomplete({city:x.cityInput,house:x.houseInput,housing:x.housingInput,inputType:"street",close:function(z,A){var B=(x.wayPointIndex==0);taxi.updateRoute(B);var y=x.streetInput.val()+"";y=y.replace(/,.*$/g,"");x.streetInput.val(y)}}).on("focus",function(){x.hiddenControls.show()}).on("blur",function(){if(!b(this).val()){x.taxiSetPointFunction(null);x.hiddenControls.hide().find("input").each(function(){b(this).val("")})}else{x.hiddenControls.show()}});var v=function(){var z=x.cityInput.val()||window.city;var y=z+", "+x.streetInput.val()+", "+x.houseInput.val()+((x.housingInput.val())?" к "+x.housingInput.val():"");taxi.geocoder(y,1,function(A){if(A.length===0||(!A[0].street&&!A[0].city)){return}taxi.wayPointsData[x.wayPointIndex]=A[0].label;x.taxiSetPointFunction(A[0],"value,city,house,housing")})};b.each([x.houseInput,x.housingInput],function(){b(this).on("focus",function(){b(this).data("val",b(this).val())}).on("blur",function(){x.houseInput.val(x.houseInput.val().replace("a","а").replace("b","б"))})});var w={updateFunction:v};return w}var r=t({hiddenControls:i,streetInput:l,cityInput:h,houseInput:m,housingInput:n,taxiSetPointFunction:taxi.startpoint,wayPointIndex:0});taxi.updateFromFunction=r.updateFunction;var r=t({hiddenControls:s,streetInput:e,cityInput:j,houseInput:c,housingInput:d,taxiSetPointFunction:taxi.endpoint,wayPointIndex:1});taxi.updateToFunction=r.updateFunction;taxi.updateRoute=function(v){if(v){taxi.updateFromFunction()}else{taxi.updateToFunction()}}})});