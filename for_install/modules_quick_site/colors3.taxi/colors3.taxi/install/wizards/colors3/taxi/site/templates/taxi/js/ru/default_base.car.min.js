window.taxi=new function(){var a=this;a.points=[null,null];a.city="";a.geocoder=function(){};a.map=function(){};a.routeinfo=function(){};a.geocoders=new Collection();a.maps=new Collection();a.selectGeocoder=function(b){a.geocoder=a.geocoders.get(b).fn;return a};a.setCity=function(b){a.city=b;return a};a.startInput=function(b){if(typeof(b)==="function"){a.startInput=b}return a.startInput};a.endInput=function(b){if(typeof(b)==="function"){a.endInput=b}return a.endInput};return{maps:function(){return a.maps},map:function(){return a.maps.first()},startpoint:function(b,c){if(typeof(b)==="object"){a.points[0]=b;a.map.setPoints(a.points);c=c||"";a.startInput(b,c)}return a.points[0]},findpoints:function(){return a.points},endpoint:function(b,c){if(typeof(b)==="object"){a.points[1]=b;a.map.setPoints(a.points);c=c||"";a.endInput(b,c)}return a.points[1]},addGeocoder:function(b,c){a.geocoders.add({name:b,fn:c});return a},geocoder:function(c,b,d){return a.geocoder.find(c,b,d)},mypos:function(b,c){return a.map.mypos(b,c)},addMap:function(b,c){a.maps.add({name:b,fn:c});return a},selectMap:function(b){a.map=a.maps.get(b).fn;var c=this;a.map.init({geocoder:a.geocoder.find,city:a.city,mapcontainer:a.mapcontainer,points:a.points,startpoint:function(d){c.startpoint(d)},endpoint:function(d){c.endpoint(d)},startInput:function(d){a.startInput(d)},endInput:function(d){a.endInput(d)},routeinfo:function(d){a.routeinfo(d)}});return a},init:function(b){a.routeinfo=b.routeinfo;a.startInput=b.startInput;a.endInput=b.endInput;a.setCity(b.city);a.selectGeocoder(b.geocoder);a.mapcontainer=b.mapcontainer;this.selectMap(b.map)},wayPointsData:[]}};var taxi=window.taxi;taxi.addMap("yandex",new function(){if(typeof(ymaps)==="undefined"||ymaps===null){return}var b=this;b.route=null;b.point_source=null;b.mypos=null;b.points=null;b.lastRoute=null;function c(){b.geocoder(b.city,1,function(h){var i=h[0].point;b.map=new ymaps.Map(b.mapcontainer,{center:[i[0],i[1]],zoom:11,behaviors:["default","scrollZoom","multiTouch"]});b.map.controls.add("zoomControl").add("typeSelector")});var g=window.source+"";if(g.length>0){ymaps.geocode(window.order_city+","+window.source,{results:1}).then(function(h){var i=h.geoObjects.get(0);b.map.geoObjects.add(new ymaps.Placemark(i.geometry.getCoordinates(),{balloonContentBody:"Адрес посадки",hintContent:"Адрес посадки"},{}))})}if(window.order&&parseInt(window.crew,10)>0){var f=window.crew}else{var f=false}setInterval(function(){e(b,f)},12000)}function e(g,f){$.ajax({url:"/include/ajax_cars_info.php",type:"GET",data:{crew_id:f},success:function(k){var j=[];for(var h in b.points){if(b.points[h]==null){continue}a(b.points[h])}for(var i in k){var l=k[i];if(l.gos_number==null){l.gos_number="---"}if(l.status=="waiting"){j[l.crew_code]=new ymaps.Placemark([l.lat,l.lon],{balloonContentBody:l.name_car+" <em>"+l.color_car.toLowerCase()+"</em>",balloonContentFooter:"Позывной: "+l.crew_code+"<br />Гос.номер: "+l.gos_number,hintContent:l.name_car+" <em>"+l.color_car.toLowerCase()+"</em>"},{iconImageHref:"/ico-taxi.png",iconImageSize:[41,36]});j[l.crew_code].crew_code=l.crew_code;d(j[l.crew_code],l.crew_id)}else{j[l.crew_code]=new ymaps.Placemark([l.lat,l.lon],{hintContent:l.name_car+" <em>"+l.color_car.toLowerCase()+"</em>"},{iconImageHref:"/ico-taxi-red.png",iconImageSize:[41,36]});j[l.crew_code].crew_code=l.crew_code}g.map.geoObjects.add(j[l.crew_code])}b.points=j},dataType:"json"})}function a(f){b.map.geoObjects.remove(f)}function d(g,f){g.events.add("click",function(h){$("#FIELD_TYPE_AUTO").val("Хочу заказать машину с позывным: "+g.crew_code)})}return{name:"yandex",init:function(f){jQuery.extend(b,f);ymaps.ready(c)},createroute:function(){if(b.route){b.map.geoObjects.remove(b.route)}if(b.mypos){b.map.geoObjects.remove(b.mypos)}b.mypos=null;b.route=null;b.source_pos=null;if(!b.points[0]||typeof(b.points[0].length)==="number"){return}if(!b.points[1]||typeof(b.points[1].length)==="number"&&b.points[0]){b.mypos=new ymaps.Placemark(b.points[0].point,{},{draggable:true});b.mypos.events.add("dragend",function(){b.geocoder(b.mypos.geometry.getCoordinates(),1,function(i){if(i){b.startpoint(i[0]);b.points[0].point=b.mypos.geometry.getCoordinates()}})});b.map.geoObjects.add(b.mypos);b.map.setCenter(b.points[0].point);return}var f=[];for(var h=0,g=b.points.length;h<g;h++){f[h]=b.points[h].point}ymaps.route(f,{mapStateAutoApply:true}).then(function(j){if(b.lastRoute){b.map.geoObjects.remove(b.lastRoute)}b.route=j;b.editor=b.route.editor;b.editor.start({addWayPoints:false});var i;b.editor.events.add("routeupdate",function(){if(b.route){b.routeinfo({length:b.route.getLength(),time:b.route.getJamsTime()})}}).add("waypointdragstart",function(l){var k=l.get("wayPoint");i=parseInt(k.properties.get("iconContent"),10)-1}).add("waypointdragend",function(l){if(typeof(i)==="number"){var k=l.get("wayPoint");b.geocoder(k.geometry.getCoordinates(),1,function(m){if(m.length>0){switch(i){case 0:b.startpoint(m[0]);break;case 1:b.endpoint(m[0]);break}taxi.wayPointsData[i]=m[0].label}else{taxi.wayPointsData[i]=i+1+"";b.updateWayPointsText()}})}});b.route.getPaths().options.set({strokeColor:"0000ffee",opacity:0.9});b.editor.events.fire("routeupdate");b.lastRoute=b.route;b.map.geoObjects.add(b.route);b.updateWayPointsText=function(){b.route.getWayPoints().each(function(n,l){if(taxi.wayPointsData.length>l){var k=taxi.wayPointsData[l]}else{var k=""}var o=n.geometry.getCoordinates();var m=o[0]+", "+o[1];n.properties.set("balloonContentBody","<p>"+k+'</p><span style="font-size: small">('+m+")</span>")})};b.updateWayPointsText()})},setPoints:function(f){b.points=f;this.createroute()},mypos:function(f,h){var g=[f.coords.latitude,f.coords.longitude];b.geocoder(g,1,function(i){h();if(!i||i.length===0||i[0].length===0){return}b.startpoint(i[0]);ymaps.getZoomRange("yandex#map",i[0].point).then(function(j){b.map.setZoom(j[1]-1)})})}}});taxi.addGeocoder("yandex",new function(){if(typeof(ymaps)==="undefined"||ymaps===null){return}return{name:"yandex",find:function(c,a,d){a=a||1;var b=[];ymapsGeocoderOptions={strictBounds:false,results:a};ymaps.geocode(c,ymapsGeocoderOptions).then(function(e){e.geoObjects.each(function(u){function j(y){var w=false;var h=["metaDataProperty.GeocoderMetaData.AddressDetails.Country.AdministrativeArea.Locality","metaDataProperty.GeocoderMetaData.AddressDetails.Country.Locality","metaDataProperty.GeocoderMetaData.AddressDetails.Country.AdministrativeArea.AdministrativeAreaName.Locality","metaDataProperty.GeocoderMetaData.AddressDetails.Country.AddressLine","metaDataProperty.GeocoderMetaData.AddressDetails.Country.AdministrativeArea.SubAdministrativeArea.SubAdministrativeAreaName"];var z=y.geometry.getCoordinates();var s=z[0]+", "+z[1];for(var x in h){w=y.properties.get(h[x]);if(w){if(typeof(w)==="string"){w.LocalityName=w;w.PseudoStreet=s}return w}}w=s;return w}var l=j(u);if(!l){return}var t="";var g=typeof(l)==="string"?l:"";var f,k;f=k="";var i=l.LocalityName||"";if(l.Thoroughfare){g=l.Thoroughfare.ThoroughfareName||l.Thoroughfare.Premise.PremiseName||l.PseudoStreet;if(l.Thoroughfare.Premise){if(l.Thoroughfare.Premise.PremiseNumber){f=l.Thoroughfare.Premise.PremiseNumber;k=f.match(/[к][0-9]+$/i);if(k!==null){k=k[0].match(/[+0-9]+$/i)[0];f=f.match(/^[0-9\/]+/i)[0]}}}}else{if(l.DependentLocality){t=l.DependentLocality.DependentLocalityName;if(l.DependentLocality.Thoroughfare){g=l.DependentLocality.Thoroughfare.ThoroughfareName}}else{if(l.Premise){g=l.Premise.PremiseName}}}var o=(i)?i:"";var n=(t)?", "+t:"";var v=(g)?((i)?", "+g:g):"";var m=(f)?" "+f:"";var r=(k)?" корпус "+k:"";var p=o+n+v+m+r;var q=g;b.push({point:u.geometry.getCoordinates(),street:g,city:i,label:p,house:f,housing:k,value:q})});if(typeof(d)==="function"){d(b)}},function(){})}}});taxi.addMap("google",new function(){if(typeof(google)==="undefined"||google===null){return}var a=this;a.directionsService=null;a.route=null;a.mypos=null;return{name:"google",init:function(b){jQuery.extend(a,b);a.geocoder(a.city,1,function(c){var d=c[0].point;a.map=new google.maps.Map(document.getElementById(a.mapcontainer),{zoom:11,center:new google.maps.LatLng(d[0],d[1]),mapTypeId:google.maps.MapTypeId.ROADMAP})});a.directionsService=new google.maps.DirectionsService();a.route=new google.maps.DirectionsRenderer({draggable:false});a.mypos=new google.maps.Marker()},createroute:function(){a.route.setMap(null);a.mypos.setMap(null);if(!a.points[0]||typeof(a.points[0].length)==="number"){return}if(!a.points[1]||typeof(a.points[1].length)==="number"&&a.points[0]){var e=a.points[0].point;e=new google.maps.LatLng(e[0],e[1]);a.mypos=new google.maps.Marker({map:a.map,draggable:true,position:e});a.mypos.setMap(a.map);a.map.setCenter(e);google.maps.event.addListener(a.mypos,"dragend",function(){var f=a.mypos.getPosition();f=[f.lat(),f.lng()];a.geocoder(f,1,function(g){if(g){a.startpoint(g[0])}})});return}a.route.setMap(a.map);var d=a.points[0].point;d=new google.maps.LatLng(d[0],d[1]);var b=a.points[1].point;b=new google.maps.LatLng(b[0],b[1]);var c={origin:d,destination:b,travelMode:google.maps.TravelMode.DRIVING};a.directionsService.route(c,function(f,g){if(g===google.maps.DirectionsStatus.OK){a.route.setDirections(f)}});google.maps.event.addListener(a.route,"directions_changed",function(){var f=a.route.directions.routes[0].legs[0];a.routeinfo({length:f.distance.value,time:f.duration.value});return})},setPoints:function(b){a.points=b;this.createroute()},mypos:function(b,d){var c=[b.coords.latitude,b.coords.longitude];a.geocoder(c,1,function(f){d();if(!f){return}a.startpoint(f[0]);var h=f[0].point;var g=new google.maps.LatLng(h[0],h[1]);var e=new google.maps.MaxZoomService();e.getMaxZoomAtLatLng(g,function(i){if(i.status===google.maps.MaxZoomStatus.OK){a.map.setZoom(i.zoom-3)}});a.map.setCenter(g)})}}});taxi.addGeocoder("google",new function(){if(typeof(google)==="undefined"||google===null){return}var a=new google.maps.Geocoder();return{name:"google",find:function(f,b,g){b=b||1;if(typeof(f)==="object"){f={latLng:new google.maps.LatLng(f[0],f[1])}}else{if(typeof(f)==="string"){f={address:f}}}function e(h,k){for(var j=h.length-1;j>=0;j--){if(jQuery.inArray(k,h[j].types)!==-1){return h[j].long_name}}return""}var c=[];var d={region:"ru"};jQuery.extend(d,f);a.geocode(d,function(i,h){if(h===google.maps.GeocoderStatus.OK){jQuery.each(i,function(n,y){var l,k,w;l=k=w="";var j,m;j=m="";l=e(y.address_components,"locality");k=e(y.address_components,"route");if(!k){k=e(y.address_components,"point_of_interest")}if(!k){k=e(y.address_components,"establishment")}if(!k){w=e(y.address_components,"administrative_area_level_2")}j=e(y.address_components,"street_number");m=j.match(/[к][0-9]+$/i);if(m!==null){m=m[0].match(/[+0-9]+$/i)[0];j=j.match(/^[0-9\/]+/i)[0]}var r=(l)?l:"";var q=(w)?", "+w:"";var x=(k)?((l)?", "+k:k):"";var o=(j)?" "+j:"";var v=(m)?" корпус "+m:"";var t=r+q+x+o+v;var u=k;var p=y.geometry.location;c.push({point:[p.lat(),p.lng()],city:l,street:k,label:t,house:j,housing:m,value:u})});if(typeof(g)==="function"){g(c)}}})}}});var SuggestCaller=function(){var a=this;a._lastResponse=null;a.callback=function(){};a.createResponseObject=function(f){if(f.length<3){console.log("Error in parsing suggest response!");return false}var c=[];for(var e in f[1]){var g=f[1][e];c.push({type:g[0],label:g[1],fullLabel:g[2],systemData:g[3]})}var d={part:f[0],variants:c};return d};window.function_Sj2dk83xZi450_callback=function(d){var c=a.createResponseObject(d);a._lastResponse=c;a.callback(c)};var b=function(){return{callback:"function_Sj2dk83xZi450_callback",part:"",lang:"ru-RU",search_type:"all",ll:"64.22769438476561,62.20712366243136",spn:"82.61718750000001,32.68027802373878",fullpath:"1",v:"5"}};a.optionsObject=new b();a.internalGetRequest=function(){var d=a.optionsObject;if(d.part&&d.part.length>1){var c="http://suggest-maps.yandex.ru/suggest-geo";$.ajax({url:c,type:"get",data:d,dataType:"jsonp",jsonp:"jsonp",crossDomain:true,success:function(e){console.log(e)}})}else{return false}};return{part:"",callback:function(c){},search_type:"all",ll:"64.22769438476561,62.20712366243136",spn:"82.61718750000001,32.68027802373878",search:function(c,d){if(typeof(d)!=="function"){console.log("Bad suggest function callback type! This type must be function(responseObject)!")}this.part=c;this.callback=d;a.callback=d;a.optionsObject.part=this.part;a.optionsObject.search_type=this.search_type;a.optionsObject.ll=this.ll;a.optionsObject.spn=this.spn;return a.internalGetRequest()},getLastResponse:function(){return a._lastResponse}}};taxi.suggestCaller=new SuggestCaller();