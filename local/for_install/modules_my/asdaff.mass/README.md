# Массовые операции с элементами инфоблоков 
**Описание**


Модуль позволяет выполнять определенный набор действий с элементами инфоблока. Модуль содержит мощный функционал фильтра, который позволит отбирать элементы по всевозможным параметрам, по многим типам условий (равно X, содержит X, начинается с X, оканчивается на X, задано, не задано, больше X, больше или равно X, и др. - в зависимости от типа поля/свойства). 

В дополнение к фильтру имеется возможность выбрать необходимые разделы с элементами. 

На данный момент модуль включает в себя 16 плагинов, решающих следующие задачи: 
массовая генерация символьного кода из любого подходящего поля/свойства инфоблока с расширенными параметрами; 
массовые наценки и скидки: модуль позволяет изменять цены (как цены торгового каталога, так и закупочные, так и просто цены в свойстве инфоблока) как с процентным указанием (+5%, -10%), так и с фиксированным значением (+200, -100); 
массовое заполнение значений товаров (поля и свойства инфоблока, цены, остатки, габариты, и другие параметры товаров), 
массовое копирование цен из одного поля/свойства в другое, с помощью этого можно перенести цены в любых сочетаниях: напр., из свойства инфоблока в цены торгового каталога, и наоборот, или из розничной цены в оптовую, и др.; 
массовое уменьшение изображений - пригодится, когда в инфоблоках заданы слишком большие изображения ("картинка для анонса", "детальная картинка", свойства инфоблока типа "файл") - модуль их всех уменьшит до заданного размера по заданному режиму; 
массовое копирование изображений - копирует картинку из одного поля/свойства в другое, в любых сочетаниях: пригодится, например, когда нужно массово создать картинки для анонса из подробных картинок; 
массовое удаление элементов легко выполнит всю работу по удалению элементов инфоблока, 
создание наборов и комплектов, 
пересохранение элементов (для применения обработчиков), 
сложная обработка изображений модулем «Обработчик изображений» (ресайз, повороты, обрезки, эффекты, скругления, текст на фото, ватермарк, отражения, рамки и прочее), 
и многое другое. 

Как пользоваться: 
на странице модуля выберите инфоблок (и при необходимости - один или более раздел), 
составьте фильтр (поочередно выбирая поле/свойство, затем тип проверки и затем значение для проверки, и после этого нажимая кнопку «Добавить»), 
в группе «Действие» выберите нужное действие (напр., «Генерация символьного кода», или «Пересчет цен - наценки и скидки»), 
укажите необходимые настройки, 
нажмите кнопку «Выполнить действия» и дожидайтесь окончания процесса. 
Вы можете создать свой плагин для выполнения своей индивидуальной задачи. Создание простейшего плагина (напр., плагин замены названий товаров) у программиста займет около одного часа.  

---
_Как создать свой плагин для модуля?_
Создать свой плагин просто!
Для начала рассмотрите код нескольких плагинов (они находятся в директории /bitrix/modules/webdebug.antirutin/include/actions/). Плагин это отдельный класс, наследуемый от класса CWDA_Plugin. В одном файле может быть создано сколько угодно плагинов, но мы рекомендуем в одном файле хранить один плагин.

У класса должно быть свое уникальное имя, начинающееся с "CWDA_" (это обязательно, т.к. по этому коду идет поиск плагинов). Также в классе задаются три константы: GROUP, CODE, NAME - группа плагина, его код (заглавные символы и символ подчеркивания) и название. В качестве группы могут задаваться следующие варианты: GENERAL (Общее), IMAGES (Изображения), PRICES (Цены), OTHERS (Другое). Также в модуле доступен обработчик OnGetActionsGroup для добавления собственных групп.

Класс должен иметь следующие обязательные функции (методы):

Process($ItemID, $arElement, $Params) - метод, выполняющий всю полезную работу плагина, $ItemID - ID элемента инфоблока, $arElement - массив его полей (в т.ч. свойства), $Params - настройки плагина.
AddHeadData - метод для добавления всех необходимых данных (стили, скрипты) на страницу. Для каждого плагина этот метод выполняется при инициализации. Т.е. подключенные скрипты и стили находятся на странице, даже если выбран другой плагин.
ShowSettings($IBlockID) - метод для показа формы настроек плагина, $IBlockID - текущий выбранный инфоблок.

Дополнительные (не обязательные методы):

GetDescription - метод для получения текстового описания плагина,
GetMessage($Code, $ConvertCharset=false) - метод для работы со внутренними языковыми фразами (об этом далее), $Code - символьный код языковой фразы, $ConvertCharset - флаг необходимости смены кодировки.

Т.к. файл плагина общий для всех кодировок (windows-1251 и UTF-8), то необходимо придерживаться следующих правил: во-первых, кодировка плагина должна быть UTF-8. И во-вторых, внутри модуля необходимо пользоваться методом GetMessage() плагина, в котором должна быть автоматический выбор кодировки в зависимости от текущей кодировки сайта - пример можно посмотреть почти в любом из плагинов.

Добавить свой плагин в модуль можно через обработку события модуля (путь к плагину может быть любым):

```php
AddEventHandler('webdebug.antirutin','OnGetActionsList','AntirutinAddMyPlugin');
function AntirutinAddMyPlugin(){
	require_once($_SERVER['DOCUMENT_ROOT'].'/bitrix/php_interface/antirutin_plugins/MyPlugin.php');
}
```
Также можно добавить плагин, просто подключив его в файле init.php.

Другие особенности:
любая синтаксическая ошибка в коде плагина блокирует работу с модулем,
названия классов плагинов не должны пересекаться,
доступны следующие события JS: onWdaAfterIBlockChange (при смене инфоблока, доступна переменная WdaCurrentAction, содержащая имя текущего плагина), onWdaAfterActionChange (при смене плагина, доступна переменная WdaCurrentAction, содержащая имя текущего плагина), onWdaBeforeSubmit (перед запуском процесса, установив внутри обработчика WdaCanSubmit=false можно отменить запуск процесса),
следует помнить, что плагин может выполняться как на странице сайта, так и из планировщика, это накладывает некоторые ограничения, например, при работе из планирощика недоступны сессии и параметр $_SESSION,
при выборке элементов используется ID, т.е. элементы сортируются в порядке ID, данный способ сортировки изменить не получится.
Интересные идеи для плагинов.
Мы разработали уже около десятка плагинов на заказ (примерно половина из них - бесплатно*), среди них есть несколько интересных:
плагин для генерации карточек товара в формате PDF и сохранение сгенерированных файлов в свойство товара,
парсинг информации об автомобилях из drom.ru.
Также много интересных идей для плагинов, многие из которых мы со временем воплотим в жизнь: 
публикация выбранных товаров в соц. сети,
копирование элементов в другие инфоблоки,
и много других идей попроще.  

_Как работать с модулем?_
Алгоритм работы простой:

выбрать инфоблок, на котором нужно проводить операции, затем (при необходимости) выбрать нужные разделы (для выбора нескольких разделов нажать и удерживать клавишу Ctrl и мышкой выбирать разделы),

далее, укажите условия отбора элементов инфоблока для выполнения операции, зеленая фигура с числом указывает на количество найденных по фильтру элементов,

затем, выберите нужное действие (напр., «Генерация символьного кода») и укажите все необходимые параметры,

нажмите кнопку «Выполнить действия». 

_Как использовать профили?_
Профиль (с точки зрения данного модуля) - это сохраненная совокупность настроек формы для выполнения какого-либо конкретного действия модуля.

Профиль создается просто: выберите инфоблок (и при необходимости - разделы), укажите данные для фильтрации, выберите нужное действие, введите настройки выбранного действия, и в нижней правой части формы нажмите «Сохранить профиль», введите название профиля. Все! Профиль сохранен.

Теперь Вы можете использовать сохраненный профиль для быстрого загрузки формы (в панели кнопок над формой нажмите «Использовать профиль» - и выберите нужный профиль). Форма будет загружена из сохраненных настроек.

Список сохраненных профилей доступен на странице управления профилями (ссылка для перехода на указанную страницу доступна в панели кнопок над формой).

Также, сохраненный профиль Вы можете использовать для автоматической загрузки планировщиков или из командной строки. Т.к. нюансов здесь много, то настройку задания лучше поручить специалисту (в случае наличия активной лицензии модуля у Вас на сайте можете обратиться к нам за бесплатной настройкой одного задания - потребуется доступ в панель настройки планировщика Cron).

В каждом задании в качестве аргумента параметра «profile» обязательно должен быть указан ID сохраненного профиля. На одно задание - один профиль. Другое не поддерживается.

Например, задание может выглядеть так:

/usr/bin/php -f /home/bitrix/www/bitrix/modules/webdebug.antirutin/cron.php profile=1

В случае, если настройки кодировки для планировщика не совпадают с настройками кодировки для сайта, под формой настроек будет выведено соответствующее уведомление. В этом случае необходимо в папке модуля создать файл php.ini с указанием необходимых настроек (исправляющих проблемы с кодировкой) и в команде его указать примерно так:

/usr/bin/php -c /home/bitrix/www/bitrix/modules/webdebug.antirutin/php.ini -f /home/bitrix/www/bitrix/modules/webdebug.antirutin/cron.php profile=1

Имейте ввиду, что указанные пути приведены для основного сайта виртуальной машины Битрикс, т.е. когда сайт лежит в папке /home/bitrix/www/, для всех остальных случаев команда будет другой, и если Вы просто укажете эту команду - она не будет работать! 

_Как во все описания товара добавить текст в конце?_
Для решения данной задачи можете воспользоваться плагином "Замена в тексте". Сначала отметьте галочку "Использовать регулярные выражения". Затем в поле "Что ищем" укажите "#^(.*?)$#" - это регулярное выражение обозначает найти все от начала и о конца. Далее, в поле "На что заменяем" укажите "$1<br/>Текст в конце". Здесь "$1" - это весь уже имеющийся текст (т.е. подменяется на текущее значение поля), а все остальное - это то, чем нужно дополнить поле. 

_Где найти лог?_
Если в файл /bitrix/php_interface/dbconn.php задана константа LOG_FILENAME - то это и будет лог. Иначе ищите лог в корне сайта (вид log_***************.log).

_Как протестировать работу модуля на одном товаре?_
Для того, чтобы протестировать работу модуля на одном товаре, в фильтре необходимо добавить фильтрацию так, чтобы был найден только один товар. Лучший способ это сделать - фильтр по ID (если настроены другие фильтры, нужно все их отменить, кликнув на каждом из них). В форме редактирования товара посмотрите его ID, а затем на странице модуля «Антирутин» добавьте фильтр по ID в секции «Фильтр»:

выберите ID в выпадающем списке «Поля инфоблока» - «ID»,
в следующем списке выберите «равно»,
в поле для ввода скопируйте ID из формы редактирования товара,
нажмите кнопку «Добавить».
При этом в поле с примененными фильтрами, с правого края, в зеленом овале должна появиться цифра «1» - что означает, что найден один товар. Обработка будет применяться только к выбранному товару. 

**Примеры настройки**

У меня есть свойство инфоблока с ценой (напр., 190.00), мне нужно убрать копейки из цены.
Если нужно удалить именно .00, то делаем так:

1) выбираем необходимый инфоблок

2) выбираем действие "Замена в тексте"

3) "Поле или свойство" - выбираем свойство с текстовой ценой

4) "Что ищем" - указываем .00

5) "На что заменяем" - оставляем пустым

6) Выполняем!


Если же необходимо убрать копейки (т.е. кроме вариантов 10.00 есть например и 10.50, 20.48 и т.д.) 

то делаем так же шаги 1-3, затем:

4) Отмечаем галочку "Использовать регулярные выражения"

5) "Что ищем" - копируем это:

#(\d)\.(\d{1,2})#

6) "На что заменяем" - копируем это:

$1

7) Выполняем!