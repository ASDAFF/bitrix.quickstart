var esolIXModuleName="esol.importxml";var esolIXModuleFilePrefix="esol_import_xml";var EIXPreview={Init:function(){eval("var params = "+$('#esol_ix_xml_wrap input[name="settings_json"]').val()+";");eval("var extraparams = "+$('#esol_ix_xml_wrap input[name="extrasettings_json"]').val()+";");$('#esol_ix_xml_wrap input[name="settings_json"]').remove();$('#esol_ix_xml_wrap input[name="extrasettings_json"]').remove();$('#esol_ix_xml_wrap input[name="defaultsettings_json"]').remove();if(params.GROUPS){for(var i in params.GROUPS){this.currentTag=this.GetTagByXPath(params.GROUPS[i]);if(this.currentTag){this.SetBaseElement(i)}}}if(params.FIELDS){var val,xpath,arVals,valObj,option;var selectNames=["section_fields","subsection_fields","element_fields","property_fields"];for(var j=0;j<selectNames.length;j++){var select=$('#esol_ix_xml_wrap select[name="'+selectNames[j]+'"]');for(var i in params.FIELDS){arVals=params.FIELDS[i].split(";");xpath=arVals[0];val=arVals[1];valObj=this.GetValObjByXPath(xpath);if(valObj!=false){option=select.find('option[value="'+val+'"]');if(option.length>0){this.SetFieldValue(valObj,option[0],i,(typeof extraparams=="object"?extraparams[i]:""))}}}}}},ShowBaseElements:function(b){this.currentTag=$(b).closest(".esol_ix_xml_struct_item");var a=[];a.push({TEXT:BX.message("ESOL_IX_GROUP_ELEMENT"),ONCLICK:'EIXPreview.SetBaseElement("ELEMENT")'});BX.adminShowMenu(b,a,{active_class:"bx-adm-scale-menu-butt-active"})},SetBaseElement:function(b){if(b){var c=this;this.UnsetBaseElement(b);$(this.currentTag).closest(".esol_ix_xml_struct_item").attr("data-base-element",b.toLowerCase());$(this.currentTag).find("> .esol_ix_group_value").html('<input type="hidden" name="SETTINGS[GROUPS]['+b+']" value=""><span>'+BX.message("ESOL_IX_GROUP_"+b)+'<a href="javascript:void(0)" onclick="return EIXPreview.UnsetBaseElement(\''+b+'\')" class="esol_ix_group_value_close" title="'+BX.message("ESOL_IX_REMOVE_FIELD")+'"></a></span>');$('#esol_ix_xml_wrap input[name="SETTINGS[GROUPS]['+b+']"]').val(this.GetXPathByTag(this.currentTag));var a=$(this.currentTag).find(".esol_ix_str_value");a.addClass("esol_ix_str_value_active");a.find(".esol_ix_str_value_val").bind("click",function(){c.ShowElementFields(this)});$(this.currentTag).find(".esol_ix_str_value[data-attr]").bind("contextmenu",function(d){return c.ShowAttrActions(d,this)})}},UnsetBaseElement:function(b){if(b){var c=$('#esol_ix_xml_wrap input[name="SETTINGS[GROUPS]['+b+']"]');if(c.length>0){c.closest(".esol_ix_xml_struct_item").removeAttr("data-base-element");var a=c.closest(".esol_ix_xml_struct_item").find(".esol_ix_str_value");a.find(".esol_ix_str_value_field .esol_ix_str_value_close").trigger("click");a.removeClass("esol_ix_str_value_active");a.find(".esol_ix_str_value_val").unbind("click").unbind("contextmenu");c.closest(".esol_ix_group_value").html("")}}},GetXPathByTag:function(a){if($(a).attr("data-attr")){var b="@"+$(a).attr("data-attr")}else{var b=$(a).attr("data-name")}while((a=$(a).parent())&&a.hasClass("esol_ix_xml_struct_item")){b=$(a).attr("data-name")+"/"+b}return b},GetXPathByVal:function(b){var a=this.GetXPathByTag(b.closest(".esol_ix_xml_struct_item"));if(b.attr("data-attr")){a+="/@"+b.attr("data-attr")}return a},GetTagByXPath:function(b){var a=b.split("/");var d=$("#esol_ix_xml_wrap .esol_ix_xml_struct");var c=0;while(c<a.length&&(d=d.find('> .esol_ix_xml_struct_item[data-name="'+a[c]+'"]'))&&d.length>0){c++}if(c<a.length){return false}return d},GetValObjByXPath:function(d){var c="";var b=d.split("/");if(b[b.length-1].substr(0,1)=="@"){c=b.pop().substr(1);d=b.join("/")}var a=this.GetTagByXPath(d);if(a==false){return false}var e=a.find("> .esol_ix_str_value"+(c.length>0?'[data-attr="'+c+'"]':":not([data-attr])"));return e},ShowElementFields:function(valObj,event){var obj=this;valObj=$(valObj);var copySettings=((typeof event=="object")&&(event.ctrlKey||event.shiftKey));var fieldsCode=valObj.closest(".esol_ix_xml_struct_item[data-base-element]").attr("data-base-element");var pSelect=$('#esol_ix_xml_wrap select[name="'+fieldsCode+'_fields"]');var select=$(pSelect).clone();var options=select[0].options;var oldValue=this.GetFieldValue(valObj);for(var i=0;i<options.length;i++){if(oldValue==options.item(i).value){options.item(i).selected=true}}var chosenId="esolix_select_chosen";$("#"+chosenId).remove();var offset=valObj.offset();var div=$("<div></div>");div.attr("id",chosenId);div.css({position:"absolute",left:offset.left,top:offset.top});div.append(select);$("body").append(div);select.chosen({search_contains:true});select.bind("change",function(){var option=options.item(select[0].selectedIndex);var settings=false;if(copySettings){settings=valObj.prev(".esol_ix_str_value_field").find(".esol_ix_str_value_settings input").val();if(settings.length>0){eval("settings = "+settings+";")}}if(typeof settings=="object"){obj.SetFieldValue(valObj,option,false,settings)}else{obj.SetFieldValue(valObj,option)}select.chosen("destroy");$("#"+chosenId).remove()});$("body").one("click",function(e){e.stopPropagation();return false});var chosenDiv=select.next(".chosen-container")[0];$("a:eq(0)",chosenDiv).trigger("mousedown");var lastClassName=chosenDiv.className;var interval=setInterval(function(){var className=chosenDiv.className;if(className!==lastClassName){select.trigger("change");lastClassName=className;clearInterval(interval)}},30)},ShowAttrActions:function(d,a){return;this.currentAttr=$(a);var c=$(a).prev(".esol_ix_str_value_cm");if(c.length==0){$(a).before('<a href="javascript:void(0)" class="esol_ix_str_value_cm"></a>');c=$(a).prev(".esol_ix_str_value_cm");var b=[];b.push({TEXT:BX.message("ESOL_IX_SHOW_ALL_ATTRIBUTES"),ONCLICK:"EIXPreview.SetGroupTags()"});BX.adminShowMenu(c[0],b,{active_class:"bx-adm-scale-menu-butt-active"})}else{BX.fireEvent(c[0],"click")}return false},SetGroupTags:function(){var a=this.GetXPathByTag(this.currentAttr);var b=$(this.currentAttr).closest("form").serialize()+"&ACTION=GET_GROUP_TAGS";$.post(window.location.href,b,function(c){alert(c)})},GetFieldValue:function(b){var a=b.find('input[name^="SETTINGS[FIELDS]["]');if(a.length>0){var c=a.val().split(";");if(c.length==2){return c[1]}}return""},SetFieldValue:function(a,f,g,n){a=$(a);var l=a.closest(".esol_ix_str_value");if((typeof f=="object")&&f.value){var c="";var b=$(f).closest("optgroup");if(b.length>0){c=b.attr("label");if(c.length>0){c+=" - "}}c+=f.text;var j=this.GetXPathByVal(l);if(a.hasClass("esol_ix_str_value_field")){var p=a;if(!g&&g!==0){var o=$('input[name^="SETTINGS[FIELDS]["]',p);if(o.length>0){g=o.attr("name").replace(/^.*\[(\d+)\]$/,"$1")}}}else{var e=this;var k=l.find(".esol_ix_str_value_val");if(!k.hasClass("esol_ix_str_value_val_selected")){k.addClass("esol_ix_str_value_val_selected").unbind("click");var m=$('<a href="javascript:void(0)" class="esol_ix_str_value_add" title="'+BX.message("ESOL_IX_ADD_FIELD")+"\r\n\r\n"+BX.message("ESOL_IX_ADD_FIELD_COPY_SETTING")+'"></a>');m.bind("click",function(i){return EIXPreview.ShowElementFields(this,i)});l.append(m)}if(!g&&g!==0){var h=$('#esol_ix_xml_wrap input[name^="SETTINGS[FIELDS]["]');var d=0;while($('#esol_ix_xml_wrap input[name="SETTINGS[FIELDS]['+d+']"]').length>0){d++}g=d}var p=$('<span class="esol_ix_str_value_field"><input type="hidden" name="SETTINGS[FIELDS]['+g+']" value=""><span></span><a href="javascript:void(0)" onclick="return EIXPreview.ShowFieldSettings(event, this)" class="esol_ix_str_value_settings" id="field_settings_'+g+'" title="'+BX.message("ESOL_IX_FIELD_SETTINGS")+'"><input name="EXTRASETTINGS['+g+']" value="" type="hidden"></a><a href="javascript:void(0)" onclick="return EIXPreview.DeleteFieldValue(event, this)" class="esol_ix_str_value_close" title="'+BX.message("ESOL_IX_REMOVE_FIELD")+'"></a></span>');p.insertBefore(l.find(".esol_ix_str_value_add"));if(typeof n=="object"){p.find(".esol_ix_str_value_settings input").val(JSON.stringify(n))}else{p.find(".esol_ix_str_value_settings").addClass("inactive")}p.bind("click",function(){e.ShowElementFields(this)})}if(f.value=="VARIABLE"){c+=" {"+g+"}"}p.find("span").html(c);p.find('input[name^="SETTINGS[FIELDS]["]').val(j+";"+f.value)}else{if(a.hasClass("esol_ix_str_value_field")){a.find("a.esol_ix_str_value_close").trigger("click")}}},DeleteFieldValue:function(d,b){d.stopPropagation();var a=$(b).closest(".esol_ix_str_value");$(b).closest(".esol_ix_str_value_field").remove();if(a.find(".esol_ix_str_value_field").length==0){var c=this;a.find(".esol_ix_str_value_val").removeClass("esol_ix_str_value_val_selected").bind("click",function(){c.ShowElementFields(this)});a.find(".esol_ix_str_value_add").remove()}return false},ShowBaseElements2:function(h){var g=$('#esol_ix_xml_wrap select[name="group"]');var i=$(g).clone();var j=i[0].options;var f="esolix_select_chosen";$("#"+f).remove();var e=$(h).offset();var a=$("<div></div>");a.attr("id",f);a.css({position:"absolute",left:e.left,top:e.top,width:300});a.append(i);$("body").append(a);i.chosen();i.bind("change",function(){var k=j.item(i[0].selectedIndex);i.chosen("destroy");$("#"+f).remove()});$("body").one("click",function(k){k.stopPropagation();return false});var d=i.next(".chosen-container")[0];$("a:eq(0)",d).trigger("mousedown");var c=d.className;var b=setInterval(function(){var k=d.className;if(k!==c){i.trigger("change");c=k;clearInterval(b)}},30)},ShowFieldSettings:function(k,d){k.stopPropagation();var q=$(d).closest(".esol_ix_str_value_field");var o=q.find(">span:eq(0)").html().replace(/\s+\{\d+\}$/,"");var g=this.GetFieldValue(q);var a=$(d).find("input[type=hidden]").attr("name");var j=a.replace(/^.*\[([^\]]*)\]$/,"$1");var b=$(d).closest("form")[0];var n=$("input",d).val();var p=$('#esol_ix_xml_wrap input[name="struct_base64"]').val();var s=$(d).closest(".esol_ix_xml_struct_item[data-base-element]").attr("data-base-element");var m={};var f=$('#esol_ix_xml_wrap input[name^="SETTINGS[GROUPS]["]');for(var h=0;h<f.length;h++){var r=f[h].name.replace(/^.*\[([^\[]*)\]$/,"$1");m[r]=f[h].value}var c={title:BX.message("ESOL_IX_POPUP_FIELD_SETTINGS_TITLE")+' "'+o+'" {'+j+"}",content_url:"/bitrix/admin/"+esolIXModuleFilePrefix+"_field_settings_hl.php?field="+g+"&field_name="+a+"&index="+j+"&PROFILE_ID="+b.PROFILE_ID.value,width:"900",height:"400",resizable:true,content_post:{POSTEXTRA:n,POSTSTRUCT:p,XPATH_LIST:m,GROUP:s.toUpperCase()}};var l=new BX.CAdminDialog(c);l.SetButtons([l.btnCancel,new BX.CWindowButton({title:BX.message("JS_CORE_WINDOW_SAVE"),id:"savebtn",name:"savebtn",className:BX.browser.IsIE()&&BX.browser.IsDoctype()&&!BX.browser.IsIE10()?"":"adm-btn-save",action:function(){this.disableUntilError();this.parentWindow.PostParameters()}})]);BX.addCustomEvent(l,"onWindowRegister",function(){$("input[type=checkbox]",this.DIV).each(function(){BX.adminFormTools.modifyCheckbox(this)});ESettings.BindConversionEvents()});l.Show();return false},SetExtraParams:function(b,a){if(typeof a=="object"){a=JSON.stringify(a)}if(a.length>0){$("#"+b).removeClass("inactive")}else{$("#"+b).addClass("inactive")}$("#"+b+" input").val(a);if(BX.WindowManager.Get()){BX.WindowManager.Get().Close()}}};var EProfile={Init:function(){var a=$("select#PROFILE_ID");if(a.length>0){if(a.val().length>0){$.post(window.location.href,{MODE:"AJAX",ACTION:"DELETE_TMP_DIRS"},function(b){})}a=a[0];if(a.value=="new"){$("#new_profile_name").css("display","")}else{$("#new_profile_name").css("display","none")}$("select.adm-detail-iblock-list").bind("change",function(){$.post(window.location.href,{MODE:"AJAX",HIGHLOADBLOCK_ID:this.value,ACTION:"GET_UID"},function(d){var c=$(d).find('select[name="fields[]"]');var b=$('select[name="SETTINGS_DEFAULT[ELEMENT_UID][]"]');c.val(b.val());c.attr("name",b.attr("name"));b.replaceWith(c)})});var a=$('select[name="SETTINGS_DEFAULT[ELEMENT_UID][]"]');$("select.kda-chosen-multi").chosen({width:"300px"});this.ToggleAdditionalSettings();$('#dataload input[type="checkbox"][data-confirm]').bind("change",function(){if(this.checked&&!confirm(this.getAttribute("data-confirm"))){this.checked=false}})}},Choose:function(a){var c=(typeof a=="object"?a.value:a);var b=window.location.search.replace(/PROFILE_ID=[^&]*&?/,"");if(b.length<2){b="?"}if(b.length>1&&b.substr(b.length-1)!="&"){b+="&"}b+="PROFILE_ID="+c;window.location.href=b},Delete:function(){var c=this;var a=$("select#PROFILE_ID");var b=a[0].options[a[0].selectedIndex];var d=b.value;$.post(window.location.href,{MODE:"AJAX",ID:d,ACTION:"DELETE_PROFILE"},function(e){c.Choose("")})},Copy:function(){var obj=this;var select=$("select#PROFILE_ID");var option=select[0].options[select[0].selectedIndex];var id=option.value;$.post(window.location.href,{MODE:"AJAX",ID:id,ACTION:"COPY_PROFILE"},function(data){eval("var res = "+data+";");obj.Choose(res.id)})},ShowRename:function(){var a=$("select#PROFILE_ID");var d=a[0].options[a[0].selectedIndex];var c=d.innerHTML;var e=$("#new_profile_name");var b=$("input[type=text]",e);b.val(c);if(!b.attr("init_btn")){b.after('&nbsp;<input type="button" onclick="EProfile.Rename();" value="OK">');b.attr("init_btn",1)}e.css("display","")},Rename:function(){var a=$("select#PROFILE_ID");var c=a[0].options[a[0].selectedIndex];var f=c.value;var e=$("#new_profile_name");var b=$("input[type=text]",e);var d=$.trim(b.val());if(d.length==0){return false}e.css("display","none");c.innerHTML=d;$.post(window.location.href,{MODE:"AJAX",ID:f,NAME:d,ACTION:"RENAME_PROFILE"},function(g){})},ShowCron:function(){var a=new BX.CAdminDialog({title:BX.message("ESOL_IX_POPUP_CRON_TITLE"),content_url:"/bitrix/admin/"+esolIXModuleFilePrefix+"_cron_settings.php?suffix=highload",width:"800",height:"350",resizable:true});a.SetButtons([a.btnCancel]);a.Show()},SaveCron:function(a){var b=$(a).closest("form");$.post(b[0].getAttribute("action"),b.serialize()+"&subaction="+a.name,function(c){$("#esol-ix-cron-result").html(c)})},RemoveProccess:function(b,c){var a={MODE:"AJAX",PROCCESS_PROFILE_ID:c,ACTION:"REMOVE_PROCESS_PROFILE"};$.ajax({type:"POST",url:window.location.href,data:a,success:function(e){var d=$(b).closest(".kda-proccess-item");if(d.parent().find(".kda-proccess-item").length<=1){d.closest(".adm-info-message-wrap").hide()}d.remove()}})},ContinueProccess:function(b,c){var a=$(b).closest("div");a.append('<form method="post" action="" style="display: none;"><input type="hidden" name="PROFILE_ID" value="'+c+'"><input type="hidden" name="STEP" value="3"><input type="hidden" name="PROCESS_CONTINUE" value="Y"><input type="hidden" name="sessid" value="'+$("#sessid").val()+'"></form>');a.find("form")[0].submit()},ToggleAdditionalSettings:function(a){if(a){a=$(a)}else{a=$(".esol_ix_head_more")}if(a.length==0){return}$(a).each(function(){var c=$(this).closest("tr");var b=$(this).hasClass("show");while((c=c.next("tr:not(.heading)"))&&c.length>0){if(b){c.hide()}else{c.show()}}if(b){$(this).removeClass("show")}else{$(this).addClass("show")}})},RadioChb:function(c,a,e){if(c.checked){if(!e||confirm(e)){var d=$(c).closest("form");if(typeof a=="object"){for(var b=0;b<a.length;b++){if(d[0][a[b]]){d[0][a[b]].checked=false}}}if(d[0][a]){d[0][a].checked=false}}else{c.checked=false}}},OpenMissignElementFields:function(e){var d=$(e).closest("form");var f=$('select[name="SETTINGS_DEFAULT[IBLOCK_ID]"]',d).val();var b=$(e).prev("input[type=hidden]");var a={title:BX.message(b.attr("id").indexOf("OFFER_")==0?"ESOL_IX_POPUP_MISSINGOFFER_FIELDS_TITLE":"ESOL_IX_POPUP_MISSINGELEM_FIELDS_TITLE"),content_url:"/bitrix/admin/"+esolIXModuleFilePrefix+"_missignelem_fields.php?IBLOCK_ID="+f+"&INPUT_ID="+b.attr("id")+"&OLDDEFAULTS="+b.val(),width:"800",height:"400",resizable:true};var c=new BX.CAdminDialog(a);c.SetButtons([c.btnCancel,new BX.CWindowButton({title:BX.message("JS_CORE_WINDOW_SAVE"),id:"savebtn",name:"savebtn",className:BX.browser.IsIE()&&BX.browser.IsDoctype()&&!BX.browser.IsIE10()?"":"adm-btn-save",action:function(){this.disableUntilError();this.parentWindow.PostParameters()}})]);BX.addCustomEvent(c,"onWindowRegister",function(){$("input[type=checkbox]",this.DIV).each(function(){BX.adminFormTools.modifyCheckbox(this)});$("select.esol-ix-chosen-multi").chosen()});c.Show();return false},ShowEmailForm:function(){var pid=$("#PROFILE_ID").val();var post="";var json=$('.esol-ix-file-choose input[name="SETTINGS_DEFAULT[EMAIL_DATA_FILE]"]').val();if(json){eval("post = {EMAIL_SETTINGS: "+json+"};")}var dialog=new BX.CAdminDialog({title:BX.message("ESOL_IX_POPUP_SOURCE_EMAIL"),content_url:"/bitrix/admin/"+esolIXModuleFilePrefix+"_source_email.php?PROFILE_ID="+pid,content_post:post,width:"900",height:"450",resizable:true});BX.addCustomEvent(dialog,"onWindowRegister",function(){});dialog.SetButtons([dialog.btnCancel,new BX.CWindowButton({title:BX.message("JS_CORE_WINDOW_SAVE"),id:"savebtn",name:"savebtn",className:BX.browser.IsIE()&&BX.browser.IsDoctype()&&!BX.browser.IsIE10()?"":"adm-btn-save",action:function(){this.disableUntilError();this.parentWindow.PostParameters()}})]);dialog.Show()},CheckEmailConnectData:function(link){var form=$(link).closest("form");var post=form.serialize()+"&action=checkconnect";$.ajax({type:"POST",url:form.attr("action"),data:post,success:function(data){eval("var res = "+data+";");if(res.result=="success"){$("#connect_result").html('<div class="success">'+BX.message("ESOL_IX_SOURCE_EMAIL_SUCCESS")+"</div>")}else{$("#connect_result").html('<div class="fail">'+BX.message("ESOL_IX_SOURCE_EMAIL_FAIL")+"</div>")}if(res.folders){var select=$('select[name="EMAIL_SETTINGS[FOLDER]"]',form);var oldVal=select.val();$("option",select).remove();for(var i in res.folders){var option=$("<option>"+res.folders[i]+"</option>");option.attr("value",i);select.append(option)}select.val(oldVal)}},error:function(){$("#connect_result").html('<div class="fail">'+BX.message("ESOL_IX_SOURCE_EMAIL_FAIL")+"</div>")},timeout:5000})},ShowFileAuthForm:function(){var pid=$("#PROFILE_ID").val();var post="";var json=$('.esol-ix-file-choose input[name="EXT_DATA_FILE"]').val();if(json&&json.substr(0,1)=="{"){eval("post = {AUTH_SETTINGS: "+json+"};")}var dialog=new BX.CAdminDialog({title:BX.message("ESOL_IX_POPUP_SOURCE_LINKAUTH"),content_url:"/bitrix/admin/"+esolIXModuleFilePrefix+"_source_linkauth.php?PROFILE_ID="+pid,content_post:post,width:"900",height:"450",resizable:true});BX.addCustomEvent(dialog,"onWindowRegister",function(){});dialog.SetButtons([dialog.btnCancel,new BX.CWindowButton({title:BX.message("JS_CORE_WINDOW_SAVE"),id:"savebtn",name:"savebtn",className:BX.browser.IsIE()&&BX.browser.IsDoctype()&&!BX.browser.IsIE10()?"":"adm-btn-save",action:function(){this.disableUntilError();this.parentWindow.PostParameters()}})]);dialog.Show()},SetLinkAuthParams:function(a){if($('.esol-ix-file-choose input[name="EXT_DATA_FILE"]').length==0){$(".esol-ix-file-choose").prepend('<input type="hidden" name="EXT_DATA_FILE" value="">')}$('.esol-ix-file-choose input[name="EXT_DATA_FILE"]').val(JSON.stringify(a));$('.esol-ix-file-choose input[name="SETTINGS_DEFAULT[EMAIL_DATA_FILE]"]').val("");BX.WindowManager.Get().Close()},LauthAddVar:function(b){var c=$(b).closest("tr").prev("tr.esol-ix-lauth-var");var a=c.clone();a.find("input").val("");c.after(a)},CheckLauthConnectData:function(link){var form=$(link).closest("form");var post=form.serialize()+"&action=checkconnect";$.ajax({type:"POST",url:form.attr("action"),data:post,success:function(data){eval("var res = "+data+";");if(res.result=="success"){$("#connect_result").html('<div class="success">'+BX.message("ESOL_IX_SOURCE_LAUTH_SUCCESS")+"</div>")}else{$("#connect_result").html('<div class="fail">'+BX.message("ESOL_IX_SOURCE_LAUTH_FAIL")+"</div>")}},error:function(){$("#connect_result").html('<div class="fail">'+BX.message("ESOL_IX_SOURCE_LAUTH_FAIL")+"</div>")},timeout:20000})},LauthLoadParams:function(link){var form=$(link).closest("form");var post=form.serialize()+"&action=loadparams";$.ajax({type:"POST",url:form.attr("action"),data:post,success:function(data){if(data.length==0){return}eval("var res = "+data+";");if(typeof res!="object"){return}var varInputs=$('input[name="vars[]"]',form);var emptyVals=true;for(var i=0;i<varInputs.length;i++){if($.trim($(varInputs[i]).val()).length>0){emptyVals=false}}if(emptyVals&&typeof res.VARS=="object"){var countVars=varInputs.length;while(countVars<res.VARS.length){$("td.esol-ix-lauth-addvar a",form).trigger("click");countVars++}varInputs=$('input[name="vars[]"]',form);for(var i=0;i<varInputs.length;i++){if(res.VARS[i]){$(varInputs[i]).val(res.VARS[i])}}}var postAuthInput=$('input[name="AUTH_SETTINGS[POSTPAGEAUTH]"]',form);if($.trim(postAuthInput.val()).length==0&&res.LOC){postAuthInput.val(res.LOC)}},timeout:8000})}};var EImport={params:{},Init:function(a,c){BX.scrollToNode($("#resblock .adm-info-message")[0]);this.wait=BX.showWait();this.post=a;if(typeof c=="object"){this.params=c}this.SendData();this.pid=a.PROFILE_ID;this.idleCounter=0;this.errorStatus=false;var b=this;setTimeout(function(){b.SetTimeout()},3000)},SetTimeout:function(){if($("#progressbar").hasClass("end")){return}var a=this;this.timer=setTimeout(function(){a.GetStatus()},2000)},GetStatus:function(){var obj=this;$.ajax({type:"GET",url:"/upload/tmp/"+esolIXModuleName+"/"+this.pid+".txt?hash="+(new Date()).getTime(),success:function(data){var finish=false;if(data&&data.substr(0,1)=="{"&&data.substr(data.length-1)=="}"){try{eval("var result = "+data+";")}catch(err){var result=false}}else{var result=false}if(typeof result=="object"){if(result.action!="finish"){obj.UpdateStatus(result)}else{obj.UpdateStatus(result,true);var finish=true}}if(!finish){obj.SetTimeout()}},error:function(){obj.SetTimeout()},timeout:5000})},UpdateStatus:function(a,b){if($("#progressbar").hasClass("end")){return}if(b&&this.timer){clearTimeout(this.timer)}if(typeof a=="object"){a.total_file_line=parseInt(a.total_file_line);if(!a.total_file_line){a.total_file_line=1}if(b&&(parseInt(a.total_read_line)<parseInt(a.total_file_line))){a.total_read_line=a.total_file_line}$("#total_line").html(a.total_line);$("#correct_line").html(a.correct_line);$("#error_line").html(a.error_line);$("#element_added_line").html(a.element_added_line);$("#element_updated_line").html(a.element_updated_line);$("#element_removed_line").html(a.element_removed_line);$("#sku_added_line").html(a.sku_added_line);$("#sku_updated_line").html(a.sku_updated_line);$("#section_added_line").html(a.section_added_line);$("#section_updated_line").html(a.section_updated_line);$("#killed_line").html(a.killed_line);$("#offer_killed_line").html(a.offer_killed_line);$("#zero_stock_line").html(a.zero_stock_line);$("#offer_zero_stock_line").html(a.offer_zero_stock_line);$("#old_removed_line").html(a.old_removed_line);$("#offer_old_removed_line").html(a.offer_old_removed_line);var c=$("#progressbar .presult span");if(a.curstep&&c.attr("data-"+a.curstep)){c.html(c.attr("data-"+a.curstep))}if(b){c.css("visibility","hidden");$("#progressbar .presult").removeClass("load");$("#progressbar").addClass("end")}var d=Math.abs(Math.round((a.total_read_line/a.total_file_line)*100));if(d>=100){d=99}if(b){d=100}$("#progressbar .presult b").html(d+"%");$("#progressbar .pline").css("width",d+"%");if(this.tmpparams&&this.tmpparams.total_read_line==a.total_read_line){this.idleCounter++}else{this.idleCounter=0}this.tmpparams=a}},SendData:function(){var a=this.post;a.ACTION="DO_IMPORT";a.stepparams=this.params;var b=this;$.ajax({type:"POST",url:window.location.href,data:a,success:function(c){b.errorStatus=false;b.OnLoad(c)},error:function(){b.errorStatus=true;$("#block_error_import").show();var c=document.getElementById("esol_ix_auto_continue_time");if(c){c.innerHTML="";b.TimeoutOnAutoConinue()}},timeout:(a.STEPS_TIME?((Math.min(3600,a.STEPS_TIME)+120)*1000):180000)})},TimeoutOnAutoConinue:function(){var obj=this;var timeBlock=document.getElementById("esol_ix_auto_continue_time");var time=timeBlock.innerHTML;if(time.length==0){timeBlock.innerHTML=30}else{time=parseInt(time)-1;timeBlock.innerHTML=time;if(time<1){$.ajax({type:"POST",url:window.location.href,data:{MODE:"AJAX",PROCCESS_PROFILE_ID:obj.pid,ACTION:"GET_PROCESS_PARAMS"},success:function(data){if(data&&data.substr(0,1)=="{"&&data.substr(data.length-1)=="}"){try{eval("var params = "+data+";")}catch(err){var params=false}if(typeof params=="object"){obj.params=params}}$("#block_error_import").hide();obj.errorStatus=false;obj.SendDataSecondary()},error:function(){timeBlock.innerHTML="";obj.TimeoutOnAutoConinue()}});return}}setTimeout(function(){obj.TimeoutOnAutoConinue()},1000)},SendDataSecondary:function(){var a=this;if(this.post.STEPS_DELAY){setTimeout(function(){a.SendData()},parseInt(this.post.STEPS_DELAY)*1000)}else{a.SendData()}},OnLoad:function(data){data=$.trim(data);var returnLabel="<!--module_return_data-->";if(data.indexOf(returnLabel)!=-1){data=$.trim(data.substr(data.indexOf(returnLabel)+returnLabel.length))}if(data.indexOf("{")!=0){this.SendDataSecondary();return true}try{eval("var result = "+data+";")}catch(err){var result=false}if(typeof result=="object"){if(result.sessid){$("#sessid").val(result.sessid)}if(typeof result.errors=="object"&&result.errors.length>0){$("#block_error").show();for(var i=0;i<result.errors.length;i++){$("#res_error").append("<div>"+result.errors[i]+"</div>")}}if(result.action=="continue"){this.UpdateStatus(result.params);this.params=result.params;this.SendDataSecondary();return true}}else{this.SendDataSecondary();return true}this.UpdateStatus(result.params,true);BX.closeWait(null,this.wait);return false}};var ESettings={AddValue:function(a){var b=$(a).prev("div").clone(true);$("input, select",b).val("").show();$(a).before(b)},OnValChange:function(a){var b=$(a).next("input");var c=$(a).val();if(c.length>0){b.hide()}else{b.show()}b.val(c)},AddMargin:function(b){var c=$(b).closest("td").find(".esol-ix-settings-margin:eq(0)");if(!c.is(":visible")){c.show()}else{var a=c.clone(true);$("select, input",a).val("");$(b).before(a)}},RemoveMargin:function(b){var a=$(b).closest("td").find(".esol-ix-settings-margin");if(a.length>1){$(b).closest(".esol-ix-settings-margin").remove()}else{$("select, input",a).val("");a.hide()}},ShowMarginTemplateBlock:function(a){$("#margin_templates_load").hide();var b=$("#margin_templates");b.toggle()},ShowMarginTemplateBlockLoad:function(a,b){$("#margin_templates").hide();var c=$("#margin_templates_load");if(b=="hide"){c.hide()}else{c.toggle()}},SaveMarginTemplate:function(a,d){var h=$(a).closest("div");var f=$("select[name=MARGIN_TEMPLATE_ID]",h).val();var c=$("input[name=MARGIN_TEMPLATE_NAME]",h).val();if(f.length==0&&c.length==0){return false}var e=BX.WindowManager.Get();var b=e.PARAMS.content_url;var g=e.GetParameters().replace(/(^|&)action=[^&]*($|&)/,"&").replace(/^&+/,"").replace(/&+$/,"");g+="&action=save_margin_template&template_id="+f+"&template_name="+c;$.post(b,g,function(j){var i=$(j);$("#margin_templates").replaceWith(i.find("#margin_templates"));$("#margin_templates_load").replaceWith(i.find("#margin_templates_load"));alert(d)});return false},LoadMarginTemplate:function(a){var g=$(a).closest("div");var e=$("select[name=MARGIN_TEMPLATE_ID]",g).val();if(e.length==0){return false}var c=BX.WindowManager.Get();var b=c.PARAMS.content_url;var f=c.GetParameters().replace(/(^|&)action=[^&]*($|&)/,"&").replace(/^&+/,"").replace(/&+$/,"");f+="&action=load_margin_template&template_id="+e;var d=this;$.post(b,f,function(i){var h=$(i);$("#settings_margins").replaceWith(h.find("#settings_margins"));d.ShowMarginTemplateBlockLoad("hide")});return false},RemoveMarginTemplate:function(a,c){var g=$(a).closest("div");var e=$("select[name=MARGIN_TEMPLATE_ID]",g).val();if(e.length==0){return false}var d=BX.WindowManager.Get();var b=d.PARAMS.content_url;var f=d.GetParameters().replace(/(^|&)action=[^&]*($|&)/,"&").replace(/^&+/,"").replace(/&+$/,"");f+="&action=delete_margin_template&template_id="+e;$.post(b,f,function(i){var h=$(i);$("#margin_templates").replaceWith(h.find("#margin_templates"));$("#margin_templates_load").replaceWith(h.find("#margin_templates_load"));alert(c)});return false},BindConversionEvents:function(){$(".esol-ix-settings-conversion").each(function(){var a=this;$("select.field_cell",a).bind("change",function(){if(this.value=="ELSE"||this.value=="LOADED"){$("select.field_when",a).hide();$("input.field_from",a).hide()}else{$("select.field_when",a).show();$("input.field_from",a).show()}}).trigger("change")})},AddConversion:function(b){var a=$(b).prev(".esol-ix-settings-conversion");if(!a.is(":visible")){a.show()}else{var c=a.clone();$("select, input",c).not(".choose_val").val("");$(b).before(c)}ESettings.BindConversionEvents()},RemoveConversion:function(a){var b=$(a).closest(".esol-ix-settings-conversion");if($(a).closest("td").find(".esol-ix-settings-conversion").length>1){b.remove()}else{$("select, input",b).not(".choose_val").val("");b.hide()}},ShowChooseVal:function(f){var g=$(f).prev("input")[0];this.focusField=g;var e=[];for(var d in admKDASettingMessages){if(d.indexOf("RATE_")==0){var a=d.substr(5);e.push({TEXT:admKDASettingMessages[d],TITLE:"#"+a+"# - "+admKDASettingMessages[d],ONCLICK:"ESettings.SetUrlVar('#"+a+"#')"})}}if(admKDASettingMessages.AVAILABLE_TAGS){var b=admKDASettingMessages.AVAILABLE_TAGS;for(var c in b){e.push({TEXT:b[c],TITLE:"{"+c+"}",ONCLICK:"ESettings.SetUrlVar('{"+c+"}')"})}}BX.adminShowMenu(f,e,"")},ShowExtraChooseVal:function(c){var d=$(c).prev("input")[0];this.focusField=d;var b=[];for(var a in admKDASettingMessages.EXTRAFIELDS){b.push({TEXT:"<b>"+admKDASettingMessages.EXTRAFIELDS[a].TITLE+"</b>",HTML:"<b>"+admKDASettingMessages.EXTRAFIELDS[a].TITLE+"</b>",TITLE:"#"+a+"# - "+admKDASettingMessages.EXTRAFIELDS[a].TITLE,ONCLICK:"javascript:void(0)"});for(var e in admKDASettingMessages.EXTRAFIELDS[a].FIELDS){b.push({TEXT:admKDASettingMessages.EXTRAFIELDS[a].FIELDS[e],TITLE:"#"+e+"# - "+admKDASettingMessages.EXTRAFIELDS[a].FIELDS[e],ONCLICK:"ESettings.SetUrlVar('#"+e+"#')"})}}BX.adminShowMenu(c,b,"")},ShowPHPExpression:function(a){var b=$(a).next(".esol-ix-settings-phpexpression");if(b.is(":visible")){b.hide()}else{b.show()}},SetUrlVar:function(f){var d=this.focusField;if(document.selection){d.focus();var e=document.selection.createRange();e.text=f}else{if(d.selectionStart||d.selectionStart=="0"){var c=d.selectionStart;var b=d.selectionEnd;var a=c+f.length;d.value=d.value.substring(0,c)+f+d.value.substring(b,d.value.length);d.setSelectionRange(a,a);d.focus()}else{d.value+=f;d.focus()}}BX.fireEvent(d,"change");d.focus()},AddDefaultProp:function(a){if(!a.value){return}var d=$(a).closest("tr");var c="DEFAULTS["+a.value+"]";if($(d).closest("table").find('input[name="'+c+'"]').length>0){return}var b=d.prev("tr.esol-ix-list-settings-defaults");var e=b.clone();e.css("display","");$(".adm-detail-content-cell-l",e).html(a.options[a.selectedIndex].innerHTML+":");$("input[type=text]",e).attr("name",c);e.insertBefore(b);$(a).val("").trigger("chosen:updated")},RemoveDefaultProp:function(a){$(a).closest("tr").remove()},RemoveLoadingRange:function(a){$(a).closest("div").remove()},AddNewLoadingRange:function(b){var c=$(b).prev("div");var a=c.clone().insertBefore(c);a.show()}};var EHelper={ShowHelp:function(a){var b=new BX.CAdminDialog({title:BX.message("ESOL_IX_POPUP_HELP_TITLE"),content_url:"/bitrix/admin/"+esolIXModuleFilePrefix+"_popup_help.php",width:"900",height:"450",resizable:true});BX.addCustomEvent(b,"onWindowRegister",function(){$("#esol-ix-help-faq > li > a").bind("click",function(){var c=$(this).next("div");if(c.is(":visible")){c.stop().slideUp()}else{c.stop().slideDown()}return false});if(a>0){$("#esol-ix-help-tabs .esol-ix-tabs-heads a:eq("+parseInt(a)+")").trigger("click")}});b.Show()},SetTab:function(f){var d=$(f).closest(".esol-ix-tabs");var e=$(".esol-ix-tabs-heads a",d);var a=$(".esol-ix-tabs-bodies > div",d);var b=0;for(var c=0;c<e.length;c++){if(e[c]==f){b=c;break}}e.removeClass("active");$(e[b]).addClass("active");a.removeClass("active");$(a[b]).addClass("active")}};$(document).ready(function(){var a=$("select:eq(0)");if(typeof a.chosen!="function"){var c=$('script[src^="/bitrix/js/main/jquery/"]').attr("src");if(c){$.getScript(c,function(){$.getScript("/bitrix/js/"+esolIXModuleName+"/chosen/chosen.jquery.min.js")})}}if($("#preview_file").length>0){var b=$("#preview_file").closest("form").serialize()+"&ACTION=SHOW_REVIEW_LIST";$.post(window.location.href,b,function(d){$("#preview_file").html(d);EIXPreview.Init()})}EProfile.Init();if($("#esol-ix-updates-message").length>0){$.post("/bitrix/admin/"+esolIXModuleFilePrefix+".php?lang="+BX.message("LANGUAGE_ID"),"MODE=AJAX&ACTION=SHOW_MODULE_MESSAGE",function(e){e=$(e);var d=$("#esol-ix-updates-message-inner",e);if(d.length>0&&d.html().length>0){$("#esol-ix-updates-message-inner").replaceWith(d);$("#esol-ix-updates-message").show()}})}});