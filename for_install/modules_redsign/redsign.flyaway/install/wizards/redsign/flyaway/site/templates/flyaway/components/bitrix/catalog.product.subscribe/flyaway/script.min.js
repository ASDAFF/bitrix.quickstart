(function(b){if(!!b.JCCatalogProductSubscribe){return}var a=function(c){a.superclass.constructor.apply(this,arguments);this.nameNode=BX.create("span",{props:{id:this.id},style:typeof(c.style)==="object"?c.style:{},text:c.text});this.buttonNode=BX.create("span",{attrs:{className:c.className},style:{marginBottom:"0",borderBottom:"0 none transparent"},children:[this.nameNode],events:this.contextEvents});if(BX.browser.IsIE()){this.buttonNode.setAttribute("hideFocus","hidefocus")}};BX.extend(a,BX.PopupWindowButton);b.JCCatalogProductSubscribe=function(c){this.buttonId=c.buttonId;this.buttonClass=c.buttonClass;this.jsObject=c.jsObject;this.ajaxUrl="/bitrix/components/bitrix/catalog.product.subscribe/ajax.php";this.alreadySubscribed=c.alreadySubscribed;this.urlListSubscriptions=c.urlListSubscriptions;this.listOldItemId={};this.elemButtonSubscribe=null;this.elemPopupWin=null;this.defaultButtonClass="bx-catalog-subscribe-button";this._elemButtonSubscribeClickHandler=BX.delegate(this.subscribe,this);this._elemHiddenClickHandler=BX.delegate(this.checkSubscribe,this);BX.ready(BX.delegate(this.init,this))};b.JCCatalogProductSubscribe.prototype.init=function(){if(!!this.buttonId){this.elemButtonSubscribe=BX(this.buttonId);this.elemHiddenSubscribe=BX(this.buttonId+"_hidden")}if(!!this.elemButtonSubscribe){BX.bind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler)}if(!!this.elemHiddenSubscribe){BX.bind(this.elemHiddenSubscribe,"click",this._elemHiddenClickHandler)}this.setButton(this.alreadySubscribed)};b.JCCatalogProductSubscribe.prototype.checkSubscribe=function(){if(!this.elemHiddenSubscribe||!this.elemButtonSubscribe){return}if(this.listOldItemId.hasOwnProperty(this.elemButtonSubscribe.dataset.item)){this.setButton(true)}else{BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),checkSubscribe:"Y",itemId:this.elemButtonSubscribe.dataset.item},onsuccess:BX.delegate(function(c){if(c.subscribe){this.setButton(true);this.listOldItemId[this.elemButtonSubscribe.dataset.item]=true}else{this.setButton(false)}},this)})}};b.JCCatalogProductSubscribe.prototype.subscribe=function(){this.elemButtonSubscribe=BX.proxy_context;if(!this.elemButtonSubscribe){return false}BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),subscribe:"Y",itemId:this.elemButtonSubscribe.dataset.item,siteId:BX.message("SITE_ID")},onsuccess:BX.delegate(function(c){if(c.success){this.createSuccessPopup(c);this.setButton(true);this.listOldItemId[this.elemButtonSubscribe.dataset.item]=true}else{if(c.contactFormSubmit){this.initPopupWindow();this.elemPopupWin.setTitleBar(BX.message("CPST_SUBSCRIBE_POPUP_TITLE"));var d=this.createContentForPopup(c);this.elemPopupWin.setContent(d);this.elemPopupWin.setButtons([new a({text:BX.message("CPST_SUBSCRIBE_BUTTON_NAME"),className:"btn btn-primary btn2",events:{click:BX.delegate(function(){if(!this.validateContactField(c.contactTypeData)){return false}BX.ajax.submitAjax(d,{method:"POST",url:this.ajaxUrl,processData:true,onsuccess:BX.delegate(function(e){e=BX.parseJSON(e,{});if(e.success){this.createSuccessPopup(e);this.setButton(true);this.listOldItemId[this.elemButtonSubscribe.dataset.item]=true}else{if(e.error){if(e.hasOwnProperty("setButton")){this.listOldItemId[this.elemButtonSubscribe.dataset.item]=true;this.setButton(true)}var f=e.message;if(e.hasOwnProperty("typeName")){f=e.message.replace("USER_CONTACT",e.typeName)}BX("bx-catalog-subscribe-form-notify").style.color="red";BX("bx-catalog-subscribe-form-notify").innerHTML=f}}},this)})},this)}})]);this.elemPopupWin.show()}else{if(c.error){if(c.hasOwnProperty("setButton")){this.listOldItemId[this.elemButtonSubscribe.dataset.item]=true;this.setButton(true)}this.showWindowWithAnswer({status:"error",message:c.message})}}}},this)})};b.JCCatalogProductSubscribe.prototype.validateContactField=function(c){var h=BX.findChildren(BX("bx-catalog-subscribe-form"),{tag:"input",attribute:{id:"userContact"}},true);if(!h.length||typeof c!=="object"){BX("bx-catalog-subscribe-form-notify").style.color="red";BX("bx-catalog-subscribe-form-notify").innerHTML=BX.message("CPST_SUBSCRIBE_VALIDATE_UNKNOW_ERROR");return false}var d,g,m,l=[],j=[];for(var e=0;e<h.length;e++){d=h[e].getAttribute("data-id");g=h[e].value;m=BX("bx-contact-use-"+d);if(m&&m.value=="N"){j.push(true);continue}if(!g.length){l.push(BX.message("CPST_SUBSCRIBE_VALIDATE_ERROR_EMPTY_FIELD").replace("#FIELD#",c[d].contactLable))}}if(h.length==j.length){BX("bx-catalog-subscribe-form-notify").style.color="red";BX("bx-catalog-subscribe-form-notify").innerHTML=BX.message("CPST_SUBSCRIBE_VALIDATE_ERROR");return false}if(l.length){BX("bx-catalog-subscribe-form-notify").style.color="red";for(var f=0;f<l.length;f++){BX("bx-catalog-subscribe-form-notify").innerHTML=l[f]}return false}return true};b.JCCatalogProductSubscribe.prototype.reloadCaptcha=function(){BX.ajax.get(this.ajaxUrl+"?reloadCaptcha=Y","",function(c){BX("captcha_sid").value=c;BX("captcha_img").src="/bitrix/tools/captcha.php?captcha_sid="+c+""})};b.JCCatalogProductSubscribe.prototype.createContentForPopup=function(f){if(!f.hasOwnProperty("contactTypeData")){return null}var i=f.contactTypeData,e=Object.keys(i).length,c="",j="N",h=document.createDocumentFragment();if(e>1){j="Y";c="display:none;";h.appendChild(BX.create("p",{text:BX.message("CPST_SUBSCRIBE_MANY_CONTACT_NOTIFY")}))}h.appendChild(BX.create("p",{props:{id:"bx-catalog-subscribe-form-notify"}}));for(var d in i){if(e>1){h.appendChild(BX.create("div",{props:{className:"bx-catalog-subscribe-form-container"},children:[BX.create("div",{props:{className:"checkbox"},children:[BX.create("lable",{props:{className:"bx-filter-param-label"},attrs:{onclick:this.jsObject+".selectContactType("+d+", event);"},children:[BX.create("input",{props:{type:"hidden",id:"bx-contact-use-"+d,name:"contact["+d+"][use]",value:"N"}}),BX.create("input",{props:{id:"bx-contact-checkbox-"+d,type:"checkbox"}}),BX.create("span",{props:{className:"bx-filter-param-text"},text:i[d].contactLable})]})]})]}))}h.appendChild(BX.create("div",{props:{id:"bx-catalog-subscribe-form-container-"+d,className:"bx-catalog-subscribe-form-container",style:c},children:[BX.create("div",{props:{className:"bx-catalog-subscribe-form-container-label"},text:BX.message("CPST_SUBSCRIBE_LABLE_CONTACT_INPUT").replace("#CONTACT#",i[d].contactLable)}),BX.create("div",{props:{className:"bx-catalog-subscribe-form-container-input"},children:[BX.create("input",{props:{id:"userContact",className:"",type:"text",name:"contact["+d+"][user]"},attrs:{"data-id":d}})]})]}))}if(f.hasOwnProperty("captchaCode")){h.appendChild(BX.create("div",{props:{className:"bx-catalog-subscribe-form-container"},children:[BX.create("span",{props:{className:"bx-catalog-subscribe-form-star-required"},text:"*"}),BX.message("CPST_ENTER_WORD_PICTURE"),BX.create("div",{props:{className:"bx-captcha"},children:[BX.create("input",{props:{type:"hidden",id:"captcha_sid",name:"captcha_sid",value:f.captchaCode}}),BX.create("img",{props:{id:"captcha_img",src:"/bitrix/tools/captcha.php?captcha_sid="+f.captchaCode+""},attrs:{width:"180",height:"40",alt:"captcha",onclick:this.jsObject+".reloadCaptcha();"}})]}),BX.create("div",{props:{className:"bx-catalog-subscribe-form-container-input"},children:[BX.create("input",{props:{id:"captcha_word",className:"",type:"text",name:"captcha_word"},attrs:{maxlength:"50"}})]})]}))}var g=BX.create("form",{props:{id:"bx-catalog-subscribe-form"},children:[BX.create("input",{props:{type:"hidden",name:"manyContact",value:j}}),BX.create("input",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("input",{props:{type:"hidden",name:"itemId",value:this.elemButtonSubscribe.dataset.item}}),BX.create("input",{props:{type:"hidden",name:"siteId",value:BX.message("SITE_ID")}}),BX.create("input",{props:{type:"hidden",name:"contactFormSubmit",value:"Y"}})]});g.appendChild(h);return g};b.JCCatalogProductSubscribe.prototype.selectContactType=function(h,g){var e=BX("bx-catalog-subscribe-form-container-"+h),d="",c=BX("bx-contact-checkbox-"+h);if(!e){return false}if(c!=g.target){if(c.checked){c.checked=false}else{c.checked=true}}if(e.currentStyle){d=e.currentStyle.display}else{if(b.getComputedStyle){var f=b.getComputedStyle(e,null);d=f.getPropertyValue("display")}}if(d==="none"){BX("bx-contact-use-"+h).value="Y";BX.style(e,"display","")}else{BX("bx-contact-use-"+h).value="N";BX.style(e,"display","none")}};b.JCCatalogProductSubscribe.prototype.createSuccessPopup=function(c){this.initPopupWindow();this.elemPopupWin.setTitleBar(BX.message("CPST_SUBSCRIBE_POPUP_TITLE"));var d=BX.create("div",{props:{className:"bx-catalog-popup-content"},children:[BX.create("p",{props:{className:"bx-catalog-popup-message"},text:c.message})]});this.elemPopupWin.setContent(d);this.elemPopupWin.show()};b.JCCatalogProductSubscribe.prototype.initPopupWindow=function(){if(!!this.elemPopupWin){return}this.elemPopupWin=BX.PopupWindowManager.create("CatalogSubscribe_"+this.buttonId,null,{autoHide:false,offsetLeft:0,offsetTop:0,overlay:true,closeByEsc:true,titleBar:true,closeIcon:true,contentColor:"white"})};b.JCCatalogProductSubscribe.prototype.setButton=function(c){this.alreadySubscribed=Boolean(c);if(this.alreadySubscribed){this.elemButtonSubscribe.className=this.defaultButtonClass;this.elemButtonSubscribe.innerHTML=BX.message("CPST_TITLE_ALREADY_SUBSCRIBED");BX.unbind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler)}else{this.elemButtonSubscribe.className=this.buttonClass+" "+this.defaultButtonClass;this.elemButtonSubscribe.innerHTML=BX.message("CPST_SUBSCRIBE_BUTTON_NAME");BX.bind(this.elemButtonSubscribe,"click",this._elemButtonSubscribeClickHandler)}};b.JCCatalogProductSubscribe.prototype.showWindowWithAnswer=function(e){e=e||{};if(!e.message){if(e.status=="success"){e.message=BX.message("CPST_STATUS_SUCCESS")}else{e.message=BX.message("CPST_STATUS_ERROR")}}var d=BX.create("div",{props:{className:"bx-catalog-subscribe-alert"},children:[BX.create("span",{props:{className:"bx-catalog-subscribe-aligner"}}),BX.create("span",{props:{className:"bx-catalog-subscribe-alert-text"},text:e.message}),BX.create("div",{props:{className:"bx-catalog-subscribe-alert-footer"}})]});var g=BX.PopupWindowManager.getCurrentPopup();if(g){g.destroy()}var c=setTimeout(function(){var h=BX.PopupWindowManager.getCurrentPopup();if(!h||h.uniquePopupId!="bx-catalog-subscribe-status-action"){return}h.close();h.destroy()},3500);var f=BX.PopupWindowManager.create("bx-catalog-subscribe-status-action",null,{content:d,onPopupClose:function(){this.destroy();clearTimeout(c)},autoHide:true,zIndex:2000,className:"bx-catalog-subscribe-alert-popup"});f.show();BX("bx-catalog-subscribe-status-action").onmouseover=function(h){clearTimeout(c)};BX("bx-catalog-subscribe-status-action").onmouseout=function(h){c=setTimeout(function(){var i=BX.PopupWindowManager.getCurrentPopup();if(!i||i.uniquePopupId!="bx-catalog-subscribe-status-action"){return}i.close();i.destroy()},3500)}}})(window);