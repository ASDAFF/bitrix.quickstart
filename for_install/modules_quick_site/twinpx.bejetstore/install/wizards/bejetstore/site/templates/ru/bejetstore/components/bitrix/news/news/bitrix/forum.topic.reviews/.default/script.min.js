(function(a){a.FTRList=function(c){this.id="FTRList"+c.form.id;this.mess={};this.form=c.form;if(!!c.id){for(var b=0;b<c.id.length;b++){this.bind(c.id[b])}}this.params={preorder:(c.preorder=="Y"),pageNumber:c.pageNumber,pageCount:c.pageCount};BX.addCustomEvent(this.form,"onAdd",BX.delegate(this.add,this));BX.addCustomEvent(this.form,"onRequest",BX.delegate(function(){if(typeof this.params.pageNumber!="undefined"){var e=BX.findChild(this.form,{attr:{name:"pageNumber"}});if(!e){e=BX.create("input",{props:{type:"hidden",name:"pageNumber"}});this.form.appendChild(e)}e.value=this.params.pageNumber}if(typeof this.params.pageCount!="undefined"){var d=BX.findChild(this.form,{attr:{name:"pageCount"}});if(!d){d=BX.create("input",{props:{type:"hidden",name:"pageCount"}});this.form.appendChild(d)}d.value=this.params.pageCount}},this));BX.addCustomEvent(this.form,"onResponse",BX.delegate(function(){var d=BX.findChild(this.form,{attr:{name:"pageNumber"}},true);if(d){BX.remove(d)}},this))};a.FTRList.prototype={add:function(d,n){var c=BX(this.form.id+"container"),h,j={className:/reviews-reply-form|reviews-collapse/},b=a.fTextToNode(n.message);if(!c){c=BX.create("div",{attrs:{id:this.form.id+"container"},props:{className:"reviews-block-container reviews-reviews-block-container"},children:[BX.create("div",{props:{className:"reviews-block-outer"},children:[BX.create("div",{props:{className:"reviews-block-inner"}})]})]});a.fReplaceOrInsertNode(c,null,BX.findChild(document,j,true).parentNode,j);c=BX(this.form.id+"container")}h=(c?BX.findChild(c,{className:"reviews-block-inner"},true):null);if(b&&h){if(!!n.allMessages){a.fReplaceOrInsertNode(b,h,BX.findChild(document,j,true).parentNode,j);if(!!n.navigation&&!!n.pageNumber){var e=a.fTextToNode(n.navigation),f,g=(e?BX.findChildren(c.parentNode,{className:"reviews-navigation-box"},true):null);if(e){if(!g){c.parentNode.insertBefore(BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-top"}}),c);var m=c;do{m=m.nextSibling}while(m&&m.nodeType!=1);var l=BX.create("div",{props:{className:"reviews-navigation-box reviews-navigation-bottom"}});if(m){c.parentNode.insertBefore(l,m)}else{c.parentNode.appendChild(l)}g=BX.findChildren(c.parentNode,{className:"reviews-navigation-box"},true)}for(f=0;f<g.length;f++){g[f].innerHTML=e.innerHTML}}this.params.pageNumber=n.pageNumber;this.params.pageCount=n.pageCount}if(n.messagesID&&typeof n.messagesID=="object"){for(var k=0;k<n.messagesID.length;k++){if(n.messagesID[k]!=d){this.bind(n.messagesID[k])}}}}else{if(typeof n.message!="undefined"){if(this.params.preorder){h.appendChild(b)}else{h.insertBefore(b,h.firstChild)}}}a.fRunScripts(n.message);this.bind(d)}},bind:function(h){var g=BX("message"+h);if(!!g){this.mess["m"+h]={node:g,author:{id:g.getAttribute("bx-author-id"),name:g.getAttribute("bx-author-name")}};var f=BX.findChildren(g,{tagName:"A",className:"reviews-button-small"},true),e=BX.delegate(function(){var i=BX.proxy_context;this.act(i.getAttribute("bx-act"),h)},this),c=BX.delegate(function(){this.act("reply",h)},this),b=BX.delegate(function(){this.act("quote",h)},this);if(!!f&&f.length>0){for(var d=0;d<f.length;d++){if(f[d].getAttribute("bx-act")=="moderate"||f[d].getAttribute("bx-act")=="del"){BX.adjust(f[d],{events:{click:e},attrs:{"bx-href":f[d].getAttribute("href"),href:"javascript:void(0);"}})}else{if(!!this.form){if(f[d].getAttribute("bx-act")=="reply"){BX.bind(f[d],"click",c)}else{if(f[d].getAttribute("bx-act")=="quote"){BX.bind(f[d],"mousedown",b)}}}}}}}},act:function(g,d){if(!d||!this.mess["m"+d]){BX.DoNothing()}else{if(g=="quote"){var k=a.GetSelection();if(document.getSelection){k=k.replace(/\r\n\r\n/gi,"_newstringhere_").replace(/\r\n/gi," ");k=k.replace(/  /gi,"").replace(/_newstringhere_/gi,"\r\n\r\n")}if(k===""&&d>0&&BX("message_text_"+d,true)){var m=BX("message_text_"+d,true);if(typeof(m)=="object"&&m){k=m.innerHTML}}k=k.replace(/[\n|\r]*<br(\s)*(\/)*>/gi,"\n");var c=function(s,r){var n=" ";var p=/showWMVPlayer.*?bx_wmv_player.*?file:[\s'"]*([^"']*).*?width:[\s'"]*([^"']*).*?height:[\s'"]*([^'"]*).*?/gi;var q=p.exec(r);if(q){n="[VIDEO WIDTH="+q[2]+" HEIGHT="+q[3]+"]"+q[1]+"[/VIDEO]"}if(n==" "){var o=/bxPlayerOnload[\s\S]*?[\s'"]*file[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*height[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*width[\s'"]*:[\s'"]*([^"']*)/gi;q=o.exec(r);if(q){n="[VIDEO WIDTH="+q[3]+" HEIGHT="+q[2]+"]"+q[1]+"[/VIDEO]"}}return n};k=k.replace(/<script[^>]*>/gi,"\001").replace(/<\/script[^>]*>/gi,"\002");k=k.replace(/\001([^\002]*)\002/gi,c);k=k.replace(/<noscript[^>]*>/gi,"\003").replace(/<\/noscript[^>]*>/gi,"\004");k=k.replace(/\003([^\004]*)\004/gi," ");k=k.replace(/<table class\=[\"]*forum-quote[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"\001");k=k.replace(/<table class\=[\"]*forum-code[\"]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"\002");k=k.replace(/<table class\=[\"]*data-table[\"]*>[^<]*<tbody>/gi,"\004");k=k.replace(/<\/td>[^<]*<\/tr>(<\/tbody>)*<\/table>/gi,"\003");k=k.replace(/[\r|\n]{2,}([\001|\002])/gi,"\n$1");var l=0;while(l++<50&&(k.search(/\002([^\002\003]*)\003/gi)>=0||k.search(/\001([^\001\003]*)\003/gi)>=0)){k=k.replace(/\002([^\002\003]*)\003/gi,"[CODE]$1[/CODE]").replace(/\001([^\001\003]*)\003/gi,"[QUOTE]$1[/QUOTE]")}var e=function(r,n,q){var t=new RegExp("\004([^\004\003]*)("+n+")([^\004\003]*)\003","i");var p=new RegExp("((?:\004)(?:[^\004\003]*))("+n+")((?:[^\004\003]*)(?:\003))","i");var o=0;while((o++<300)&&(r.search(t)>=0)){r=r.replace(p,"$1"+q+"$3")}return r};l=0;while(l++<10&&(k.search(/\004([^\004\003]*)\003/gi)>=0)){k=e(k,"<tr>","[TR]");k=e(k,"</tr>","[/TR]");k=e(k,"<td>","[TD]");k=e(k,"</td>","[/TD]");k=k.replace(/\004([^\004\003]*)\003/gi,"[TABLE]$1[/TD][/TR][/TABLE]")}if(BX.browser.IsIE()){k=k.replace(/<img(?:(?:\s+alt\s*=\s*\"?smile([^\"\s]+)\"?)|(?:\s+\w+\s*=\s*[^\s>]*))*>/gi,"$1")}else{k=k.replace(/<img.*?alt=[\"]*smile([^\"\s]+)[\"]*[^>]*>/gi,"$1")}k=k.replace(/<a[^>]+href=[\"]([^\"]+)\"[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]");k=k.replace(/<a[^>]+href=[\']([^\']+)\'[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]");k=k.replace(/<[^>]+>/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"');k=k.replace(/(smile(?=[:;8]))/g,"");k=k.replace(/\&shy;/gi,"");k=k.replace(/\&nbsp;/gi," ");BX.onCustomEvent(this.form,"onQuote",[{author:this.mess["m"+d]["author"],id:d,text:k}])}else{if(g=="reply"){BX.onCustomEvent(this.form,"onReply",[{author:this.mess["m"+d]["author"],id:d}])}else{if(g=="del"&&(!confirm(BX.message("f_cdm")))){BX.DoNothing()}else{if(g=="moderate"||g=="del"){var i=BX.proxy_context,b=i.getAttribute("bx-href").replace(/.AJAX_CALL=Y/g,"").replace(/.sessid=[^&]*/g,""),f=BX.findParent(i,{tag:"table"}),h=BX.create("a",{attrs:{className:"reply-action-note"}}),j=function(){BX.remove(h);BX.show(i.parentNode)};BX.hide(i.parentNode);h.innerHTML=BX.message("f_wait");i.parentNode.parentNode.appendChild(h);BX.ajax.loadJSON(b,{AJAX_CALL:"Y",sessid:BX.bitrix_sessid()},BX.delegate(function(o){if(o.status&&!!f){BX.onCustomEvent(a,"onForumCommentAJAXAction",[g]);if(g=="del"){var r=a.curpage||top.window.location.href;BX.fx.hide(f,"scroll",{time:0.15,callback_complete:BX.delegate(function(){BX.remove(f);j();var s=BX.findChild(BX(this.form.id+"container"),{"class":"reviews-post-table"},true,true);if((!s)||(s.length<1)){if(this.params.pageNumber>1){BX.reload(r)}}},this)})}else{var q=BX.hasClass(f,"reviews-post-hidden");var n=(q?BX.message("f_hide"):BX.message("f_show"));var p=BX.findChild(f,{className:"reviews-text"},true);BX.fx.hide(p,"fade",{time:0.1,callback_complete:function(){BX.toggleClass(f,"reviews-post-hidden");i.innerHTML=n;b=b.replace(new RegExp("REVIEW_ACTION="+(q?"SHOW":"HIDE")),("REVIEW_ACTION="+(q?"HIDE":"SHOW")));i.setAttribute("bx-href",b);BX.fx.show(p,"fade",{time:0.1});j();BX.style(p,"background-color",(q?"#FFFFFF":"#E5F8E3"))}})}}else{BX.addClass(h,"error");h.innerHTML='<span class="errortext">'+o.message+"</span>"}},this))}}}}}return false}};a.FTRForm=function(b){this.id="FTRForm"+b.form.id;this.form=b.form;this.editorName=b.editorName;this.editorId=b.editorId;this.editor=a[b.editorName];this.windowEvents={};if(!this.editor){this.windowEvents.LHE_OnInit=BX.delegate(function(c){if(c.id==this.editorId){this.addParsers(c);this.editor=c}},this);this.windowEvents.LHE_ConstructorInited=BX.delegate(function(c){if(c.id==this.editorId){if(!this.editor){this.addParsers(c);this.editor=c}this.editor.ucInited=true}},this);BX.addCustomEvent(a,"LHE_OnInit",this.windowEvents.LHE_OnInit);BX.addCustomEvent(a,"LHE_ConstructorInited",this.windowEvents.LHE_ConstructorInited)}else{this.addParsers(this.editor)}this.params={messageMax:64000};BX.addCustomEvent(this.form,"onQuote",BX.delegate(function(c){this.show();this.paste(c,"QUOTE")},this));BX.addCustomEvent(this.form,"onReply",BX.delegate(function(c){this.show();this.paste(c,"REPLY")},this))};a.FTRForm.prototype={addParsers:function(b){b.AddParser({name:"postuser",obj:{Parse:function(e,d,c){d=d.replace(/\[USER\s*=\s*(\d+)\]((?:\s|\S)*?)\[\/USER\]/ig,function(g,h,f){h=parseInt(h);f=BX.util.trim(f);return'<span id="'+c.SetBxTag(false,{tag:"postuser",params:{value:h}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+f+"</span>"});return d},UnParse:function(g,f,c){if(g.tag=="postuser"){var d="";for(var e=0;e<f.arNodes.length;e++){d+=c._RecursiveGetHTML(f.arNodes[e])}d=BX.util.trim(d);return"[USER="+g.params.value+"]"+d+"[/USER]"}return""}}})},validate:function(e){var c=this.form,g="",b=c.REVIEW_TEXT.value.length;if(c.BXFormSubmit_save){return true}if(c.TITLE&&(c.TITLE.value.length<2)){g+=BX.message("no_topic_name")}if(b<2){g+=BX.message("no_message")}else{if((this.params.messageMax!==0)&&(b>this.params.messageMax)){g+=BX.message("max_len").replace(/\#MAX_LENGTH\#/gi,this.params.messageMax).replace(/\#LENGTH\#/gi,b)}}if(g!==""){alert(g);return false}var d=BX.findChild(c,{attribute:{name:"send_button"}},true);if(d){d.disabled=true}var f=BX.findChild(c,{attribute:{name:"view_button"}},true);if(f){f.disabled=true}if(e=="Y"){BX.onCustomEvent(a,"onBeforeForumCommentAJAXPost",[c]);BX.onCustomEvent(this.form,"onRequest",[this,e]);setTimeout(BX.delegate(function(){BX.ajax.submit(c,BX.delegate(this.get,this))},this),50);return false}return true},get:function(){this.form.BXFormSubmit_save=null;var c=a.forumAjaxPostTmp;a.curpage=a.curpage||top.window.location.href;BX.onCustomEvent(a,"onForumCommentAJAXPost",[c,this.form]);if(typeof c=="undefined"||c.reload){BX.reload(a.curpage);return}if(c.status){if(!!c.allMessages||typeof c.message!="undefined"){BX.onCustomEvent(this.form,"onAdd",[c.messageID,c]);this.clear()}else{if(!!c.previewMessage){var j=BX.findChild(document,{className:"reviews-preview"},true),g=BX.findChild(document,{className:/reviews-reply-form|reviews-collapse/},true).parentNode,e=a.fTextToNode(c.previewMessage);a.fReplaceOrInsertNode(e,j,g,{className:/reviews-reply-form|reviews-collapse/});a.PostFormAjaxStatus("");a.fRunScripts(c.previewMessage)}}var h=(!!c.messageID?BX("message"+c.messageID):null);if(h){BX.scrollToNode(h)}}var b=this.form.getElementsByTagName("input");for(var f=0;f<b.length;f++){var d=b[f];if(d.getAttribute("type")=="submit"){d.disabled=false}}if(c.statusMessage){a.PostFormAjaxStatus(c.statusMessage)}BX.onCustomEvent(this.form,"onResponse",[c,this.form]);BX.onCustomEvent(a,"onAfterForumCommentAJAXPost",[c,this.form])},clear:function(){this.editor.ReInit("");if(this.editor.fAutosave){BX.bind(this.editor.pEditorDocument,"keydown",BX.proxy(this.editor.fAutosave.Init,this.editor.fAutosave))}if(!BX.type.isDomNode(this.form)){return}var c=BX.findChild(document,{className:"reviews-preview"},true);if(c){BX.remove(c)}var k=0,j,h,l;while((j=BX("upload_files_"+(k++)+"_"+this.form.index.value))&&!!j){if((h=BX.findChild(j,{tag:"input"}))&&!!l){l=BX.clone(h);l.value="";h.parentNode.insertBefore(l,h);h.parentNode.removeChild(h)}BX.hide(j)}var g=BX.findChild(this.form,{className:"forum-upload-file-attach"},true);if(g){BX.show(g)}var f=BX.findChild(this.form,{className:"reviews-upload-info"},true);if(f){BX.hide(f)}var m=null,d=BX.findChild(this.form,{attr:{name:"captcha_code"}},true),e=BX.findChild(this.form,{attr:{name:"captcha_word"}},true),b=BX.findChild(this.form,{className:"reviews-reply-field-captcha-image"},true);if(b){m=BX.findChild(b,{tag:"img"})}if(d&&e&&m){e.value="";BX.ajax.getCaptcha(function(i){d.value=i.captcha_sid;m.src="/bitrix/tools/captcha.php?captcha_code="+i.captcha_sid})}},show:function(){BX.onCustomEvent(this.form,"onBeforeShow",[this]);BX.show(this.form.parentNode);BX.scrollToNode(BX.findChild(this.form,{attribute:{name:"send_button"}},true));setTimeout(BX.delegate(function(){this.editor.SetFocus();BX.defer(this.editor.SetFocus,this.editor)()},this),100);BX.onCustomEvent(this.form,"onAfterShow",[this]);return false},hide:function(){BX.onCustomEvent(this.form,"onBeforeHide",[this]);BX.hide(this.form.parentNode);BX.onCustomEvent(this.form,"onAfterHide",[this]);return false},transverse:function(){if(this.form.parentNode.style.display=="none"){this.show()}else{this.hide()}return false},paste:function(e,b){BX.onCustomEvent(this.form,"onPaste",[e,b,this]);var c=(!!e.author?e.author:""),d=(!!e.text?e.text:""),f=(!!e.id?e.id:"");if(!c){c=""}else{if(this.editor.sEditorMode=="code"&&this.editor.bBBCode){if(c.id>0){c="[USER="+c.id+"]"+c.name+"[/USER]"}else{c=c.name}}else{if(this.editor.sEditorMode=="html"){c.name=c.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;");if(c.id>0){c='<span id="'+this.editor.SetBxTag(false,{tag:"postuser",params:{value:c.id}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+c.name+"</span>"}else{c="<span>"+c.name+"</span>"}}}}if(b=="QUOTE"){if(this.editor.sEditorMode=="code"&&this.editor.bBBCode){this.editor.WrapWith("[QUOTE"+(f>0?(" ID="+f):"")+"]","[/QUOTE]",(c!==""?(c+BX.message("f_author")+"\n"):"")+d)}else{if(this.editor.sEditorMode=="html"){this.editor.InsertHTML('<blockquote class="bx-quote" id="mess'+f+'">'+(c!==""?(c+BX.message("f_author")+"<br/>"):"")+this.editor.ParseContent(d,true)+"</blockquote><br/>")}}}else{d=(!!c?(c+", "):"")+this.editor.ParseContent(d,true);if(this.editor.sEditorMode=="code"&&this.editor.bBBCode){this.editor.WrapWith("","",d)}else{if(this.editor.sEditorMode=="html"){this.editor.InsertHTML(d)}}}this.editor.SetFocus();BX.defer(this.editor.SetFocus,this.editor)()}};BX.ready(function(){if(BX.browser.IsIE()){var e=BX.findChildren(document,{className:"reviews-post-table"},true),d,c,b;if(!e){return}for(d=0;d<e.length;d++){c=e[d].getElementsByTagName("*");b=c.length;while(b--){if(c[b].scrollWidth>c[b].offsetWidth){c[b].style.paddingBottom="20px";c[b].style.overflowY="hidden"}}}}});a.fTextToNode=function(c){var b=BX.create("div");b.innerHTML=c;if(b.childNodes.length>0){return b}else{return null}};a.PostFormAjaxStatus=function(c){var j=BX.findChild(document,{className:"reviews-note-box"},true,true),f;if(j){for(f=0;f<=j.length;f++){BX.remove(j[f])}}var b=BX.findChild(document,{className:"reviews-block-container"},true);if(!b){return}if(c.length<1){return}var h=a.fTextToNode(c);if(!h){return}var d=["reviews-reply-form","reviews-collapse"];var e=b;while((e=e.nextSibling)&&!!e){if(e.nodeType==1){var g=false;for(f=0;f<d.length;f++){if(BX.hasClass(e,d[f])){g=true;break}}if(g){e.parentNode.insertBefore(h,e);break}}}};a.SetReviewsAjaxPostTmp=function(b){a.forumAjaxPostTmp=b};a.fReplaceOrInsertNode=function(c,e,d,f){var b=null;if(!BX.type.isDomNode(d)){return false}if(!BX.type.isDomNode(c)&&!BX.type.isArray(c)&&c.length>0){if(!(c=a.fTextToNode(c))){return false}}if(BX.type.isDomNode(e)){d=e.parentNode;b=e.nextSibling;d.removeChild(e)}if(!b){b=BX.findChild(d,f,true)}if(b){b.parentNode.insertBefore(c,b)}else{d.appendChild(c)}return true};a.fRunScripts=function(c){var b=BX.processHTML(c,true);BX.ajax.processScripts(b.SCRIPT,true)};a.ShowLastEditReason=function(b,c){if(c){if(b){c.style.display="block"}else{c.style.display="none"}}};a.AttachFile=function(e,i,h,c){var d=null;var b=false;e=parseInt(e);i=parseInt(i);document.getElementById("upload_files_info_"+h).style.display="block";for(var f=e;f<(e+i);f++){d=document.getElementById("upload_files_"+f+"_"+h);if(!d||typeof(d)===null){break}if(d.style.display=="none"){b=true;d.style.display="block";break}}var g=(!b?true:(f>=(e+i-1)));if(g===true){c.style.display="none"}};a.GetSelection=function(){var b,c="";if(a.getSelection){b=a.getSelection();c=b.toString()}else{if(document.selection){b=document.selection;c=b.createRange().text}}return c}})(window);