var jsCIEESettings={arData:null,arDefaultFields:null,$arRows:{},obForm:null,$table:null,$info:null,init:function(b,e,c,d){BX.loadCSS("/bitrix/components/citrus/iblock.element.form/templates/.default/style.css");BX.loadScript("/bitrix/components/citrus/iblock.element.form/settings/jquery.tablednd_0_5.js");this.arData=b;this.arDefaultFields=e;this.obForm=document.forms.bx_popup_form_ciee_element_form;this.obForm.onsubmit=this.__saveChanges;this.$table=c;this.$info=d;var a=0;for(var f in this.arData){arField=this.arData[f];c.append('<tr><td class="bx-popup-label" title="'+f+'">'+this.arDefaultFields[f].ORIGINAL_TITLE+': </td><td><input type="text" size="20" value="'+BX.util.htmlspecialchars(arField.TITLE?arField.TITLE:"undefined")+'" class="title" /></td><td align="center"><input type="checkbox" value="1" class="required"'+(arField.IS_REQUIRED?' checked="checked"':"")+' /></td><td><input type="text" size="25" value="'+BX.util.htmlspecialchars(arField.TOOLTIP?arField.TOOLTIP:"")+'" class="tooltip" /></td><td align="center"><a href="javascript:void(0);" class="ciee-link-delete" onclick="jsCIEESettings.deleteField(this); return false;">'+BX.message("ciee_delete")+"</a></td></tr>");this.$arRows[f]=c.find("tr:last");if(arField.ACTIVE===false){this.$arRows[f].hide()}this.$arRows[f].data({arField:arField,field:f})}this.arData=null;this.__updateAddLink()},__getAvailableFields:function(){var b=this;var a={};this.$table.find("tr").each(function(c,d){$row=$(d);data=$row.data();if(data.field&&data.arField&&data.arField.ACTIVE===false){a[data.field]=$row}});return a},__updateAddLink:function(){var c=false,a=this.__getAvailableFields();for(var b in a){c=true;break}if(c){this.$info.html('<dl class="ciee-dropdown"><dt><a href="javascript:void(0);" class="ciee-action" onclick="jsCIEESettings.showAddFields(); return false;">'+BX.message("ciee_add_field")+'</a></dt><dd><ul style="display: none;"></ul></dd></dl>');this.$info.find(".ciee-dropdown dt a").click(function(){$(".ciee-dropdown dd ul").toggle()});$ul=$(".ciee-dropdown dd ul");for(field in a){$ul.append('<li class="'+field+'"><a href="javascript:void(0);" onclick="jsCIEESettings.addField(\''+field+'\')" class="ciee-action">'+this.arDefaultFields[field].ORIGINAL_TITLE+"</a></li>")}}else{this.$info.html("<p>"+BX.message("ciee_no_fields_to_add")+"</p>")}},showAddFields:function(){var a=this.__getAvailableFields(),b={};for(var c in a){b[c]=this.arDefaultFields[c].ORIGINAL_TITLE}console.log(b);return false},deleteField:function(a){$row=$(a).parents("tr");data=$row.data("arField");data.ACTIVE=false;$row.data("arField",data).hide();this.__updateAddLink()},addField:function(b){var a=this.__getAvailableFields();if($row=a[b]){$contentInner=this.$table.parents(".content-inner");data=$row.data("arField");data.ACTIVE=true;$row.data("arField",data).show();this.$table.append($row);this.__updateAddLink()}},__serialize:function(d){if(typeof(d)=="object"){var f="",b=0;for(var a in d){++b;f+=this.__serialize(a)+this.__serialize(d[a])}f="a:"+b+":{"+f+"}";return f}else{if(typeof(d)=="boolean"){return"b:"+(d?1:0)+";"}else{if(null==d){return"N;"}else{if(Number(d)==d&&d!=""&&d!=" "){if(Math.floor(d)==d){return"i:"+d+";"}else{return"d:"+d+";"}}else{if(typeof(d)=="string"){d=d.replace(/\r\n/g,"\n");d=d.replace(/\n/g,"###RN###");var e=0;if(window._global_BX_UTF){for(var c=0,b=d.length;c<b;c++){if(d.charCodeAt(c)>127){e++}}}return"s:"+(d.length+e)+':"'+d+'";'}}}}}},__saveChanges:function(){var a=this;this.arData={};this.$table.find("tr").each(function(b,c){$row=$(c);data=$row.data();if(data.field&&data.arField){data.arField.TITLE=$row.find(".title").val();data.arField.TOOLTIP=$row.find(".tooltip").val();data.arField.IS_REQUIRED=$row.find(".required:checked").val()!==undefined;if(data.arField.ACTIVE!==false){a.arData[data.field]=data.arField}}});window.jsCIEESettingsOpener.saveData(this.__serialize(this.arData));return false}};