BX.namespace("BX.Sale.OrderAjaxComponent.Maps");(function(){BX.Sale.OrderAjaxComponent.Maps={init:function(a){this.context=a||{};this.pickUpOptions=this.context.options.pickUpMap;this.propsOptions=this.context.options.propertyMap;this.maxWaitTimeExpired=false;return this},initializePickUpMap:function(a){if(!ymaps){return}this.pickUpMap=new ymaps.Map("pickUpMap",{center:!!a?[a.GPS_N,a.GPS_S]:[this.pickUpOptions.defaultMapPosition.lat,this.pickUpOptions.defaultMapPosition.lon],zoom:this.pickUpOptions.defaultMapPosition.zoom});this.pickUpMap.behaviors.disable("scrollZoom");this.pickUpMap.events.add("click",BX.delegate(function(){if(this.pickUpMap.balloon.isOpen()){this.pickUpMap.balloon.close()}},this))},pickUpMapFocusWaiter:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.setPickUpMapFocus()}else{setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)}},setPickUpMapFocus:function(){var a,c,b;a=this.pickUpMap.geoObjects.getBounds();if(a&&a.length){c=a[1][0]-a[0][0];b=a[1][1]-a[0][1];a[0][0]-=c/10;a[0][1]-=b/10;a[1][0]+=c/10;a[1][1]+=b/10;this.pickUpMap.setBounds(a,{checkZoomRange:true})}},showNearestPickups:function(c,a){if(!ymaps){return}var d=this.pickUpOptions.secureGeoLocation&&BX.browser.IsChrome()&&!this.context.isHttps?"yandex":"auto";var b=this.pickUpOptions.geoLocationMaxTime||5000;ymaps.geolocation.get({provider:d,timeOut:b}).then(BX.delegate(function(e){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;e.geoObjects.options.set("preset","islands#darkGreenCircleDotIcon");this.pickUpMap.geoObjects.add(e.geoObjects);c(e)}},this),BX.delegate(function(){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;a()}},this))},buildBalloons:function(b){if(!ymaps){return}var d=this;this.pickUpPointsJSON=[];for(var c=0;c<b.length;c++){var e=this.getStoreInfoHtml(b[c]);this.pickUpPointsJSON.push({type:"Feature",geometry:{type:"Point",coordinates:[b[c].GPS_N,b[c].GPS_S]},properties:{storeId:b[c].ID}});var a=new ymaps.Placemark([b[c].GPS_N,b[c].GPS_S],{hintContent:BX.util.htmlspecialchars(b[c].TITLE)+"<br />"+BX.util.htmlspecialchars(b[c].ADDRESS),storeTitle:b[c].TITLE,storeBody:e,id:b[c].ID,text:this.context.params.MESS_SELECT_PICKUP},{balloonContentLayout:ymaps.templateLayoutFactory.createClass('<h3>{{ properties.storeTitle }}</h3>{{ properties.storeBody|raw }}<br /><a class="btn btn-sm btn-default" data-store="{{ properties.id }}">{{ properties.text }}</a>',{build:function(){this.constructor.superclass.build.call(this);var f=document.querySelector("a[data-store]");if(f){BX.bind(f,"click",this.selectStoreByClick)}},clear:function(){var f=document.querySelector("a[data-store]");if(f){BX.unbind(f,"click",this.selectStoreByClick)}this.constructor.superclass.clear.call(this)},selectStoreByClick:function(g){var f=g.target||g.srcElement;if(d.pickUpMap.container.isFullscreen()){d.pickUpMap.container.exitFullscreen()}d.context.selectStore(f.getAttribute("data-store"));d.context.clickNextAction(g);d.pickUpMap.balloon.close()}})});if(BX("BUYER_STORE").value===b[c].ID){a.options.set("preset","islands#redDotIcon")}this.pickUpMap.geoObjects.add(a)}},selectBalloon:function(a){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.pickUpMap.geoObjects.each(BX.delegate(function(b){if(b.properties.get("id")){b.options.unset("preset")}if(b.properties.get("id")===a){b.options.set({preset:"islands#redDotIcon"});this.pickUpMap.panTo([b.geometry.getCoordinates()])}},this))}},pickUpFinalAction:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){var a=BX("BUYER_STORE");this.pickUpMap.geoObjects.each(function(b){if(b.properties.get("id")===a.value){b.options.set({preset:"islands#redDotIcon"})}else{if(parseInt(b.properties.get("id"))>0){b.options.unset("preset")}}})}},initializePropsMap:function(a){if(!ymaps){return}this.propsMap=new ymaps.Map("propsMap",{center:[a.lat,a.lon],zoom:a.zoom});this.propsMap.behaviors.disable("scrollZoom");this.propsMap.events.add("click",BX.delegate(function(c){var d=c.get("coords"),b;if(this.propsMap.geoObjects.getLength()===0){b=new ymaps.Placemark([d[0],d[1]],{},{draggable:true,preset:"islands#redDotIcon"});b.events.add(["parentchange","geometrychange"],function(){var f=BX("orderDescription"),j=b.geometry.getCoordinates(),h,g,i,e;if(f){h=f.value.indexOf(BX.message("SOA_MAP_COORDS")+":");if(h===-1){f.value=BX.message("SOA_MAP_COORDS")+": "+j[0]+", "+j[1]+"\r\n"+f.value}else{e=BX.message("SOA_MAP_COORDS")+": "+j[0]+", "+j[1];g=f.value.substring(0,h);i=f.value.substring(h+e.length);f.value=g+e+i}}});this.propsMap.geoObjects.add(b)}else{this.propsMap.geoObjects.get(0).geometry.setCoordinates([d[0],d[1]])}},this))},canUseRecommendList:function(){return(this.pickUpPointsJSON&&this.pickUpPointsJSON.length)},getRecommendedStoreIds:function(c){if(!c){return[]}var g=[];var f=this.pickUpPointsJSON.length<this.pickUpOptions.nearestPickUpsToShow?this.pickUpPointsJSON.length:this.pickUpOptions.nearestPickUpsToShow;this.storeQueryResult={};for(var e=0;e<f;e++){var a=ymaps.geoQuery({type:"FeatureCollection",features:this.pickUpPointsJSON});var d=a.getClosestTo(c);var b=d.properties.get("storeId");this.storeQueryResult[b]=d;g.push(b);this.pickUpPointsJSON.splice(a.indexOf(d),1)}return g},getDistance:function(b,a){if(!b||!a){return false}var c=this.storeQueryResult[a];var d=ymaps.coordSystem.geo.getDistance(b.geometry.getCoordinates(),c.geometry.getCoordinates());d=Math.round(d/100)/10;return d},propsMapFocusWaiter:function(){},getStoreInfoHtml:function(a){var b="";if(a.ADDRESS){b+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(a.ADDRESS)+"<br />"}if(a.PHONE){b+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(a.PHONE)+"<br />"}if(a.SCHEDULE){b+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(a.SCHEDULE)+"<br />"}if(a.DESCRIPTION){b+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(a.DESCRIPTION)+"<br />"}return b}}})();