<?IncludeModuleLangFile(__FILE__);class Sitemap{	public $module_id = "byteeightlab.sitemap";		function OpenSitemap($type=""){		$doc = new domDocument("1.0", "utf-8");		if($type=="index") $root = $doc->createElement("sitemapindex");		else $root = $doc->createElement("urlset");		$root->setAttribute('xmlns', 'http://www.sitemaps.org/schemas/sitemap/0.9');		$doc->appendChild($root);			return $doc;	}	function AddField(&$doc,$loc,$lastmod=false,$changefreq="daily",$priority="0.5"){		$arrchangefreq = array("always","hourly","daily","weekly","monthly","yearly","never");		$loc = trim($loc);		if($loc!=''){			if(!$lastmod) $lastmod = date("c",time()-(date("H",time())*60*60+date("i",time())*60+date("s",time())));			else $lastmod = date("c",MakeTimeStamp($lastmod));			if($doc->lastChild->localName=='sitemapindex'){				$sitemap = $doc->createElement("sitemap");					$loc = $doc->createElement("loc",$loc); 					$sitemap->appendChild($loc);					$lastmod = $doc->createElement("lastmod",$lastmod); 					$sitemap->appendChild($lastmod);				$doc->lastChild->appendChild($sitemap);					}else{				if(!isset($arrchangefreq[$changefreq])) $changefreq = "daily";				if(trim($priority)!=''){ 					$priority = number_format(floatval($priority),1,'.',''); 					if($priority>=1||$priority<=0||$priority=='') $priority = '0.5';				}else $priority = '0.5';							$url = $doc->createElement("url");					$loc = $doc->createElement("loc",$loc); 					$url->appendChild($loc);					$lastmod = $doc->createElement("lastmod",$lastmod); 					$url->appendChild($lastmod);					$changefreq = $doc->createElement("changefreq",$changefreq); 					$url->appendChild($changefreq);					$priority = $doc->createElement("priority",$priority); 					$url->appendChild($priority);								$doc->lastChild->appendChild($url);						}		}	}		function CloseSitemap(&$doc,$name){		$doc->save($_SERVER["DOCUMENT_ROOT"].$name); unset($doc);	}		function Generate(){		$URL = COption::GetOptionString($this->module_id,'URL','http://'.$_SERVER['HTTP_HOST']);		$NAME = COption::GetOptionString($this->module_id,'NAME','sitemap');		$PATH = COption::GetOptionString($this->module_id,'PATH','/');		$POSTFIX = COption::GetOptionString($this->module_id,'POSTFIX','_');			$INDEX = (COption::GetOptionString($this->module_id,'INDEX','Y')=='Y')?true:false;		$today = date("c",time()-(date("H",time())*60*60+date("i",time())*60+date("s",time())));						if($INDEX) $IndSiteMap = $this->OpenSitemap("index");		$SiteMap = $this->OpenSitemap();				$STATIC = array();		$STATIC_NUM = COption::GetOptionString($this->module_id,'STATIC_NUM',0);		for($i=0;$i<$STATIC_NUM;$i++){ $STATIC['n'.$i] = (array) json_decode(COption::GetOptionString($this->module_id,'STATIC_n'.$i,'[]')); }		foreach($STATIC as $value){ $value = (array) $value;			$this->AddField($SiteMap,$value['LOC'],$value['LASTMOD'],$value['CHANGEFREQ'],$value['PRIORITY']);						if($INDEX&&(mb_strlen($SiteMap->saveXML(),'8bit')>10000000||$SiteMap->lastChild->childNodes->length>40000)){				$SiteMapName = $PATH.$NAME.$POSTFIX.$IndSiteMap->lastChild->childNodes->length.'.xml';				$this->CloseSitemap($SiteMap,$SiteMapName);				$this->AddField($IndSiteMap,$URL.$SiteMapName);				$SiteMap = $this->OpenSitemap();			}		}					$IBLOCK = array();		$IBLOCK_NUM = COption::GetOptionString($this->module_id,'IBLOCK_NUM',0);		for($i=0;$i<$IBLOCK_NUM;$i++){ $IBLOCK['n'.$i] = (array) json_decode(COption::GetOptionString($this->module_id,'IBLOCK_n'.$i,'[]')); }		if(count($IBLOCK)>0){			CModule::IncludeModule("iblock");			foreach($IBLOCK as $value){  $value = (array) $value;								$value['LOC'] = trim(preg_replace("/[^a-zA-Z0-9_]/","",$value['LOC']));				if($value['LOC']=='') $value['LOC'] = "DETAIL_PAGE_URL";								$value['LASTMOD_CODE'] = trim(preg_replace("/[^a-zA-Z0-9_]/","",$value['LASTMOD_CODE']));				if($value['LASTMOD_CODE']=='') $value['LASTMOD_CODE'] = "DATE_ACTIVE_FROM";				if(trim($value['LASTMOD'])!='') $value['LASTMOD'] = FormatDate("d.m.Y H:i:s",MakeTimeStamp($value['LASTMOD']));				else unset($value['LASTMOD']);																$arSort = $arFilter = $arSelect = Array();								$arSelect[] = $value['LOC'];				if(!isset($value['LASTMOD'])) $arSelect[] = $value['LASTMOD_CODE'];								if(isset($value['SORT'])){					$value['SORT'] = trim(preg_replace("/[^a-zA-Z0-9_\,=]/","",$value['SORT']));					$value['SORT'] = explode(',',$value['SORT']);					foreach($value['SORT'] as $sort){						$sort = explode('=',$sort);						if(isset($sort[1])) if($sort[0]!=''&&$sort[1]!='') $arSort[$sort[0]] = $sort[1];					}				}				$arFilter['IBLOCK_ID'] = intval($value['IBLOCK']);								if(isset($value['FILTER'])){					$value['FILTER'] = trim(preg_replace("/[^a-zA-Z0-9_\,=]/","",$value['FILTER']));					$value['FILTER'] = explode(',',$value['FILTER']);					foreach($value['FILTER'] as $filter){						$filter = explode('=',$filter);						if(isset($filter[1])) if($filter[0]!=''&&$filter[1]!='') $arFilter[$filter[0]] = $filter[1];					}				}								$res = CIBlockElement::GetList($arSort,$arFilter,false,false,$arSelect);				while($ob = $res->GetNextElement()){ $arFields = $ob->GetFields();					if(!isset($value['LASTMOD'])) $LASTMOD = $arFields[$value['LASTMOD_CODE']];					else $LASTMOD = $value['LASTMOD'];					$this->AddField($SiteMap,$URL.$arFields[$value['LOC']],$LASTMOD,$value['CHANGEFREQ'],$value['PRIORITY']);					if($INDEX&&(mb_strlen($SiteMap->saveXML(),'8bit')>10000000||$SiteMap->lastChild->childNodes->length>40000)){						$SiteMapName = $PATH.$NAME.$POSTFIX.$IndSiteMap->lastChild->childNodes->length.'.xml';						$this->CloseSitemap($SiteMap,$SiteMapName);						$this->AddField($IndSiteMap,$URL.$SiteMapName);						$SiteMap = $this->OpenSitemap();					}						}			}		}				if($INDEX){			if($SiteMap->lastChild->childNodes->length>0){				$SiteMapName = $PATH.$NAME.$POSTFIX.$IndSiteMap->lastChild->childNodes->length.'.xml';				$this->CloseSitemap($SiteMap,$SiteMapName);				$this->AddField($IndSiteMap,$URL.$SiteMapName);				}			$this->CloseSitemap($IndSiteMap,$PATH.$NAME.'.xml');		}else if($SiteMap->lastChild->childNodes->length>0){			$this->CloseSitemap($SiteMap,$PATH.$NAME.'.xml');				}	}}