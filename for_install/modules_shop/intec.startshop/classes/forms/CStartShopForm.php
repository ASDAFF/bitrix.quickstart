<? $GLOBALS['_1422305212_']=Array('in_arr' .'ay','' .'is_array','i' .'s_ar' .'r' .'ay','arra' .'y_flip','intval','is_arra' .'y','is' .'_' .'array','' .'in_' .'array','is' .'_ar' .'r' .'ay','array_fli' .'p','is_array','intval','in_ar' .'ray','array_keys','array_' .'keys','i' .'n_arr' .'ay','i' .'n_a' .'rray','preg_' .'r' .'e' .'pla' .'c' .'e','array_ke' .'y' .'s','intval','intval','intv' .'al','intval','i' .'s_' .'array','' .'impl' .'o' .'de','s' .'tr' .'val','intva' .'l','impl' .'ode','ar' .'r' .'ay' .'_key_exists','intval','intval','in' .'tval'); ?><? function _1133374313($i){$a=Array('SID','LANG','SID','LANG','CODE','CODE','CODE','CODE','CODE','CODE','/^(>=|<=|=|!|>|<)/','','LANG','SID','ID','FORM','LANG','LID',"NAME",'NAME',"BUTTON",'BUTTON',"SENT",'SENT','FORM','SID','SID','USE_POST','Y','PROPERTIES','ID','CODE',', ','#','CODE','# - ','LANG','NAME',"\r\n",'STARTSHOP_FORM_');return $a[$i];} ?><? class CStartShopForm extends CStartShop implements CStartShopInterface{private static $arFieldsEditable=array('CODE','SORT','USE_POST','USE_CAPTCHA');public static function getArFieldsEditable(){return static::$arFieldsEditable;}private static $arFieldsFiltering=array('ID','CODE','SORT','USE_POST','USE_CAPTCHA');public static function getArFieldsFiltering(){return static::$arFieldsFiltering;}private static $Language;private static $Site;private static function Language(){if(!(static::$Language instanceof CStartShopDBTableModule)){static::$Language=new CStartShopDBTableModule('startshop_form_language','FORM','LID',array('NAME','BUTTON','SENT'));}return static::$Language;}private static function Site(){if(!(static::$Site instanceof CStartShopDBTableModule)){static::$Site=new CStartShopDBTableModule('startshop_form_site','FORM','SID');}return static::$Site;}public static function Add($_0){if(empty($_0['CODE']))return false;$_1=$_0[_1133374313(0)];$_2=$_0[_1133374313(1)];$_0=CStartShopUtil::ArrayFilter($_0,function($_3){return $GLOBALS['_1422305212_'][0]($_3,CStartShopForm::getArFieldsEditable());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);if(!$GLOBALS['_1422305212_'][1]($_1))$_1=array();if(!$GLOBALS['_1422305212_'][2]($_2))$_2=array();$_4=(bool)static::GetList(array(),array('CODE'=> $_0['CODE']))->Fetch();if($_4)return false;$_5=CStartShopDBQueryBX::Insert()->Into('startshop_form')->Values($_0)->Execute();if($_5){static::Site()->Set($_5,$GLOBALS['_1422305212_'][3]($_1));static::Language()->Set($_5,$_2);static::UpdateEventTypes($_5);return $_5;}return false;}public static function Update($_6,$_0){$_6=$GLOBALS['_1422305212_'][4]($_6);$_1=$_0[_1133374313(2)];$_2=$_0[_1133374313(3)];$_4=false;$_7=static::GetByID($_6)->Fetch();if(empty($_7))return false;if(!$GLOBALS['_1422305212_'][5]($_1))$_1=false;if(!$GLOBALS['_1422305212_'][6]($_2))$_2=false;if(isset($_0[_1133374313(4)])&& empty($_0[_1133374313(5)]))unset($_0[_1133374313(6)]);if(isset($_0[_1133374313(7)]))if($_0[_1133374313(8)]!= $_7[_1133374313(9)])$_4=(bool)static::GetList(array(),array('CODE'=> $_0['CODE']))->Fetch();if($_4)return false;$_0=CStartShopUtil::ArrayFilter($_0,function($_3){return $GLOBALS['_1422305212_'][7]($_3,CStartShopForm::getArFieldsEditable());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);if(!empty($_0))CStartShopDBQueryBX::Update()->Tables('startshop_form')->Values($_0)->Where(array('ID'=> $_6))->Execute();if($GLOBALS['_1422305212_'][8]($_1))static::Site()->Set($_6,$GLOBALS['_1422305212_'][9]($_1));if($GLOBALS['_1422305212_'][10]($_2))static::Language()->Set($_6,$_2);static::UpdateEventTypes($_6);return true;}public static function Delete($_6){$_6=$GLOBALS['_1422305212_'][11]($_6);CStartShopDBQueryBX::Delete()->From('startshop_form')->Where(array('ID'=> $_6))->Execute();static::Site()->Set($_6);static::Language()->Set($_6);static::DeleteEventTypes($_6);CStartShopFormProperty::DeleteByFilter(array('FORM'=> $_6));return true;}public static function DeleteByFilter($_8=array()){$_8=CStartShopUtil::ArrayFilter($_8,function($_3){return $GLOBALS['_1422305212_'][12]($_3,CStartShopForm::getArFieldsFiltering());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);$_9=$GLOBALS['_1422305212_'][13](CStartShopUtil::DBResultToArray(static::GetList(array(),$_8),'ID'));CStartShopDBQueryBX::Delete()->From('startshop_form')->Where($_8)->Execute();if(!empty($_9)){static::Site()->Set($_9);static::Language()->Set($_9);CStartShopFormProperty::DeleteByFilter(array('FORM'=> $_9));foreach($_9 as $_6)static::DeleteEventTypes($_6);return $_9;}return false;}public static function DeleteAll(){$_9=$GLOBALS['_1422305212_'][14](CStartShopUtil::DBResultToArray(static::GetList(),'ID'));foreach($_9 as $_6)static::DeleteEventTypes($_6);CStartShopDBQueryBX::Delete()->From('startshop_form')->Execute();static::Site()->Set();static::Language()->Set();CStartShopFormProperty::DeleteAll();return true;}public static function GetList($_10=array(),$_8=array()){$_11=array();$_10=CStartShopUtil::ArrayFilter($_10,function($_3){return $GLOBALS['_1422305212_'][15]($_3,CStartShopForm::getArFieldsFiltering());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);$_8=CStartShopUtil::ArrayFilter($_8,function($_3){return $GLOBALS['_1422305212_'][16]($GLOBALS['_1422305212_'][17](_1133374313(10),_1133374313(11),$_3),CStartShopForm::getArFieldsFiltering());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);$_12=CStartShopDBQueryBX::Select()->From('startshop_form')->Where($_8)->OrderBy($_10)->Execute();while($_7=$_12->Fetch()){$_7[_1133374313(12)]=array();$_7[_1133374313(13)]=array();$_11[$_7[_1133374313(14)]]=$_7;}if(!empty($_11)){$_9=$GLOBALS['_1422305212_'][18]($_11);$_13=static::Language()->Get(array('LID'=> 'ASC'),$_9);$_14=static::Site()->Get(array('LID'=> 'ASC'),$_9);while($_15=$_13->Fetch())$_11[$_15[_1133374313(15)]][_1133374313(16)][$_15[_1133374313(17)]]=array(_1133374313(18)=> $_15[_1133374313(19)],_1133374313(20)=> $_15[_1133374313(21)],_1133374313(22)=> $_15[_1133374313(23)],);while($_16=$_14->Fetch())$_11[$_16[_1133374313(24)]][_1133374313(25)][]=$_16[_1133374313(26)];}return CStartShopUtil::ArrayToDBResult($_11);}public static function GetByID($_6){return static::GetList(array(),array('ID'=> $GLOBALS['_1422305212_'][19]($_6)));}public static function CreateResult($_6,$_17,$_18=true,$_19=false,$_20=LANGUAGE_ID, $sSiteID = SITE_ID){$_6=$GLOBALS['_1422305212_'][20]($_6);$_7=static::GetByID($_6)->Fetch();if(empty($_7))return false;$_21=CStartShopFormResult::Add(array('FORM'=> $_7['ID'],'PROPERTIES'=> $_17));if($_21){if(($_7[_1133374313(27)]== _1133374313(28)|| $_19)&& $_18)static::SendEvent($_7['ID'],$_21,$_20, $sSiteID);return $_21;}return false;}public static function SendEvent($_6,$_21,$_20=LANGUAGE_ID, $sSiteID = SITE_ID){$_6=$GLOBALS['_1422305212_'][21]($_6);$_21=$GLOBALS['_1422305212_'][22]($_21);$_7=static::GetByID($_6)->Fetch();$_22=CStartShopFormResult::GetByID($_21)->Fetch();$_17=CStartShopUtil::DBResultToArray(CStartShopFormProperty::GetList(array(),array('FORM'=> $_7['ID'],'ACTIVE'=> 'Y')));if(empty($_7)|| empty($_22))return false;$_0=array();foreach($_17 as $_23){$_24=$_22[_1133374313(29)][$_23[_1133374313(30)]];$_0[$_23[_1133374313(31)]]=$GLOBALS['_1422305212_'][23]($_24)?$GLOBALS['_1422305212_'][24](_1133374313(32),$_24):$GLOBALS['_1422305212_'][25]($_24);}$_25=new CEvent();$_25->Send(static::GetEventTypesName($_7['ID']),$sSiteID,$_0,'N');unset($_25);return true;}public static function UpdateEventTypes($iFormID) { $iFormID = intval($iFormID); $arForm = static::GetByID($iFormID)->Fetch();  if (empty($arForm)) return false;  $arProperties = CStartShopUtil::DBResultToArray(CStartShopFormProperty::GetList(array(), array('FORM' => $arForm['ID'], 'ACTIVE' => 'Y'))); $arEventTypes = CStartShopUtil::DBResultToArray(self::GetEventTypes($iFormID), 'LID'); $arLanguages = CStartShopUtil::DBResultToArray(CLanguage::GetList($by = "lid", $order = "asc"), 'LID');  $oEventType = new CEventType(); $sEventName = static::GetEventTypesName($arForm['ID']);  foreach ($arLanguages as $sLanguageID => $arLanguage) { $sDescription = array();  foreach ($arProperties as $arProperty) $sDescription[] = '#'.$arProperty['CODE'].'# - '.$arProperty['LANG'][$sLanguageID]['NAME'];  $sDescription = implode("\r\n", $sDescription);  if (array_key_exists($sLanguageID, $arEventTypes)) { $arEventType = $arEventTypes[$sLanguageID]; $oEventType->Update(array('ID' => $arEventType['ID']), array( 'NAME' => $arForm['LANG'][$sLanguageID]['NAME'], 'DESCRIPTION' => $sDescription )); } else { $oEventType->Add(array( 'EVENT_NAME' =>$sEventName, 'LID' => $sLanguageID, 'NAME' => $arForm['LANG'][$sLanguageID]['NAME'], 'DESCRIPTION' => $sDescription )); } }  $sMessage = array(); foreach ($arProperties as $arProperty) $sMessage[] =$arProperty['LANG'][LANGUAGE_ID]['NAME'].'- #'.$arProperty['CODE'].'#'; $sMessage = implode("\r\n", $sMessage);  $oEventTemp = new CEventMessage(); $arEventTemp = CEventMessage::GetList($by="site_id", $order="desc", array("TYPE_ID" => $sEventName))->Fetch(); if (empty($arEventTemp)) { $arSiteID = array(); $rsSites = CSite::GetList($by="sort", $order="desc", array()); while ($arSite = $rsSites->Fetch()) { $arSiteID[] = $arSite['ID']; } $arTempParams = array( "ACTIVE" 	 => "Y", "EVENT_NAME" => $sEventName, "LID" 		 => $arSiteID, "EMAIL_FROM" => "#DEFAULT_EMAIL_FROM#", "EMAIL_TO" 	 => "#DEFAULT_EMAIL_FROM#", "SUBJECT" 	 => $arForm['LANG'][LANGUAGE_ID]['NAME'], "BODY_TYPE"  => "text", "MESSAGE" 	 => $sMessage );  $oEventTemp->Add($arTempParams);  } else { $arFields = Array( "MESSAGE" => $sMessage, ); $oEventTemp->Update($arEventTemp['ID'], $arFields); }  unset($oEventType); unset($oEventTemp); return true;}public static function DeleteEventTypes($_6){$_6=$GLOBALS['_1422305212_'][29]($_6);$_29=new CEventType();$_29->Delete(static::GetEventTypesName($_6));return true;}public static function GetEventTypes($_6){$_6=$GLOBALS['_1422305212_'][30]($_6);$_29=new CEventType();return $_29->GetList(array('EVENT_NAME'=> static::GetEventTypesName($_6)));}public static function GetEventTypesName($_6){$_6=$GLOBALS['_1422305212_'][31]($_6);return _1133374313(39) .$_6;}} ?>