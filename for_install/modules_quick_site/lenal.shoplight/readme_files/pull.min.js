(function(j){if(!j.BX){if(typeof(console)=="object"){console.log("PULL notice: bitrix core not loaded")}return}if(j.BX.PULL){if(typeof(console)=="object"){console.log("PULL notice: script is already loaded")}return}var r=j.BX,w=0,g=0,t=60,v=null,z=null,u=false,c=true,A=null,n="PULL",l=0,p=(new Date(2022,2,19)).toUTCString(),o=p,s=1,d=60,m={},E=null,h=null,b=null,D=0,y={},k=null,C="",q=false,f=false,a=0,B=false,i=false,e=false,x=0;r.PULL=function(){};r.PULL.init=function(){if(h==null){r.PULL.getChannelID("init")}else{r.PULL.updateState("init")}r.PULL.updateWatch()};r.PULL.start=function(F){B=false;if(typeof(F)=="object"&&F.MOBILE=="Y"){B=true}i=true;if(typeof(F)=="object"&&F.LOCAL_STORAGE=="N"){i=false}q=true;if(typeof(F)=="object"&&F.WEBSOCKET=="N"){q=false}r.bind(j,"offline",function(){c=false});r.bind(j,"online",function(){if(!r.PULL.tryConnect()){r.PULL.updateState("10",true)}});if(r.browser.IsFirefox()){r.bind(j,"keypress",function(G){if(G.keyCode==27){e=true}})}if(typeof(WebSocket)!="function"){q=false}if(typeof(F)=="object"&&F.CHANNEL_ID){h=F.CHANNEL_ID;A=F.PATH.replace("#DOMAIN#",location.hostname);C=F.PATH_WS.replace("#DOMAIN#",location.hostname);n=F.METHOD;l=parseInt(F.CHANNEL_DT)+parseInt(r.message("SERVER_TZ_OFFSET"))+parseInt(r.message("USER_TZ_OFFSET"));D=parseInt(F.LAST_ID)}if(!r.browser.SupportLocalStorage()){i=false}if(i){r.addCustomEvent(j,"onLocalStorageSet",r.PULL.storageSet);r.localStorage.set("pset",{CHANNEL_ID:h,LAST_ID:D,PATH:A,PATH_WS:C,TIME_LAST_GET:l,METHOD:n},5)}r.addCustomEvent("onImError",function(G){if(G=="AUTHORIZE_ERROR"){x++}});r.PULL.expireConfig();r.PULL.init()};r.PULL.expireConfig=function(){if(!h){return false}clearTimeout(b);b=setTimeout(r.PULL.expireConfig,60000);if(h&&n!="PULL"&&l+43200<Math.round(+(new Date)/1000)+parseInt(r.message("SERVER_TZ_OFFSET"))+parseInt(r.message("USER_TZ_OFFSET"))){h=null;if(k){k.close()}}};r.PULL.tryConnect=function(){if(c){return false}c=true;r.PULL.init();return true};r.PULL.getChannelID=function(G,F,H){if(!c){return false}H=H==false?false:true;F=F==true?true:false;G=typeof(G)=="undefined"?"0":G;r.ajax({url:"/bitrix/components/bitrix/pull.request/ajax.php?GET_CHANNEL&CODE="+G.toUpperCase()+(B?"&MOBILE":""),method:"POST",dataType:"json",lsId:"PULL_GET_CHANNEL",lsTimeout:1,timeout:30,data:{PULL_GET_CHANNEL:"Y",SITE_ID:r.message("SITE_ID"),MOBILE:B?"Y":"N",CACHE:F?"N":"Y",PULL_AJAX_CALL:"Y",sessid:r.bitrix_sessid()},onsuccess:r.delegate(function(J){if(H){r.localStorage.set("pgc",F,5)}if(J.ERROR==""){h=J.CHANNEL_ID;A=J.PATH.replace("#DOMAIN#",location.hostname);C=J.PATH_WS.replace("#DOMAIN#",location.hostname);n=J.METHOD;l=parseInt(J.CHANNEL_DT)+parseInt(r.message("SERVER_TZ_OFFSET"))+parseInt(r.message("USER_TZ_OFFSET"));D=n=="PULL"?J.LAST_ID:D;J.TIME_LAST_GET=l;r.PULL.updateState("11");r.PULL.expireConfig();if(i){r.localStorage.set("pset",J,600)}}else{x++;h=null;r.onCustomEvent(j,"onPullStatus",["offline"]);if(J.ERROR=="SESSION_ERROR"){r.message({bitrix_sessid:J.BITRIX_SESSID});clearTimeout(v);v=setTimeout(function(){r.PULL.updateState("12",true)},(x<2?2000:r.PULL.tryConnectTimeout()));r.onCustomEvent(j,"onPullError",[J.ERROR,J.BITRIX_SESSID])}else{if(J.ERROR=="AUTHORIZE_ERROR"){var I=true;if(x>=2&&BXIM&&!BXIM.desktop.ready()){I=false}clearTimeout(v);if(I){v=setTimeout(function(){r.PULL.updateState("13",true)},r.PULL.tryConnectTimeout())}r.onCustomEvent(j,"onPullError",[J.ERROR])}}if(H&&typeof(console)=="object"){var K="\n========= PULL ERROR ===========\nError type: getChannel error\nError: "+J.ERROR+"\n\nData array: "+JSON.stringify(J)+"\n================================\n\n";console.log(K)}}},this),onfailure:r.delegate(function(I){x++;h=null;r.onCustomEvent(j,"onPullStatus",["offline"]);if(I=="timeout"){setTimeout(function(){r.PULL.getChannelID("1")},10000)}else{if(typeof(console)=="object"){var J="\n========= PULL ERROR ===========\nError type: getChannel onfailure\nError: "+I.ERROR+"\n\nData array: "+JSON.stringify(I)+"\n================================\n\n";console.log(J)}}setTimeout(function(){r.PULL.updateState("14",true)},r.PULL.tryConnectTimeout())},this)})};r.PULL.updateState=function(F,G){if(!c||u){return false}F=typeof(F)=="undefined"?"":F;if(h==null||A==null){r.PULL.getChannelID(F.length>0?F:h==null?"2":"3")}else{if(q&&typeof(C)=="string"&&C.length>1&&n!="PULL"){r.PULL.connectWebSocket()}else{r.PULL.connectPull(G)}}};r.PULL.connectWebSocket=function(){if(!q){return false}u=true;k=new WebSocket(C);k.onopen=function(){f=true;a=0;x=0;r.onCustomEvent(j,"onPullStatus",["online"])};k.onclose=function(F){u=false;if(!f){if(a==1){r.PULL.getChannelID("4")}else{if(a<=5){z=setTimeout(function(){r.PULL.getChannelID("5")},10000)}else{z=setTimeout(function(){r.PULL.getChannelID("6")},30000)}}return false}f=false;if(F.wasClean&&(e||F.code==1005)){r.PULL.updateState("15")}else{if(!F.wasClean){r.PULL.updateState("16")}}};k.onmessage=function(J){var G=0;var F=J.data.match(/#!NGINXNMS!#(.*?)#!NGINXNME!#/gm);if(F!=null){for(var H=0;H<F.length;H++){F[H]=F[H].substring(12,F[H].length-12);if(F[H].length<=0){continue}var I=r.parseJSON(F[H]);var K=I.text;if(typeof(K)=="object"){if(K.ERROR==""){if(I.id){I.id=parseInt(I.id);if(!y[""+K.CHANNEL_ID+I.id]){y[""+K.CHANNEL_ID+I.id]=I.id;if(D<I.id){D=I.id}r.PULL.executeMessages(K.MESSAGE)}}}else{r.onCustomEvent(j,"onPullStatus",["offline"]);if(typeof(console)=="object"){var L="\n========= PULL ERROR ===========\nError type: updateState fetch\nError: "+K.ERROR+"\n\nConnect CHANNEL_ID: "+h+"\nConnect WS_PATH: "+C+"\n\nData array: "+JSON.stringify(K)+"\n================================\n\n";console.log(L)}h=null}}s=I.tag;o=I.time;G++}}if(h==null){if(k){k.close()}}};k.onerror=function(){a++}};r.PULL.connectPull=function(F){F=F==true?true:false;clearTimeout(z);z=setTimeout(function(){if(!A||typeof(A)!="string"||A.length<=32){A=null;clearTimeout(z);z=setTimeout(function(){r.PULL.updateState(!A?"17":"18")},10000);return false}r.onCustomEvent(j,"onPullStatus",["online"]);u=true;var G=r.ajax({url:n=="PULL"?A:(A+(s!=null?"&tag="+s:"")+"&rnd="+(+new Date)),method:n=="PULL"?"POST":"GET",dataType:n=="PULL"?"json":"html",timeout:d,headers:[{name:"If-Modified-Since",value:o},{name:"If-None-Match",value:"0"}],data:n=="PULL"?{PULL_UPDATE_STATE:"Y",CHANNEL_ID:h,CHANNEL_LAST_ID:D,SITE_ID:r.message("SITE_ID"),PULL_AJAX_CALL:"Y",sessid:r.bitrix_sessid()}:{},onsuccess:function(N){u=false;if(n=="PULL"&&typeof(N)=="object"){if(N.ERROR==""){x=0;r.PULL.executeMessages(N.MESSAGE);if(i){r.localStorage.set("pus",{TAG:null,TIME:null,MESSAGE:N.MESSAGE},5)}}else{r.onCustomEvent(j,"onPullStatus",["offline"]);if(N.ERROR=="SESSION_ERROR"){r.message({bitrix_sessid:N.BITRIX_SESSID});r.onCustomEvent(j,"onPullError",[N.ERROR,N.BITRIX_SESSID])}else{r.onCustomEvent(j,"onPullError",[N.ERROR])}if(typeof(console)=="object"){var O="\n========= PULL ERROR ===========\nError type: updateState error\nError: "+N.ERROR+"\n\nConnect CHANNEL_ID: "+h+"\nConnect PULL_PATH: "+A+"\n\nData array: "+JSON.stringify(N)+"\n================================\n\n";console.log(O)}h=null}if(h!=null&&i){r.localStorage.set("pset",{CHANNEL_ID:h,LAST_ID:D,PATH:A,PATH_WS:C,TAG:s,TIME:o,TIME_LAST_GET:l,METHOD:n},600)}r.PULL.setUpdateStateStep()}else{if(N.length>0){var I=0;x=0;var H=N.match(/#!NGINXNMS!#(.*?)#!NGINXNME!#/gm);if(H!=null){for(var J=0;J<H.length;J++){H[J]=H[J].substring(12,H[J].length-12);if(H[J].length<=0){continue}var L=r.parseJSON(H[J]);var N=L.text;if(typeof(N)=="object"){if(N.ERROR==""){if(L.id){L.id=parseInt(L.id);if(!y[""+N.CHANNEL_ID+L.id]){y[""+N.CHANNEL_ID+L.id]=L.id;if(D<L.id){D=L.id}r.PULL.executeMessages(N.MESSAGE)}}}else{if(typeof(console)=="object"){var O="\n========= PULL ERROR ===========\nError type: updateState fetch\nError: "+N.ERROR+"\n\nConnect CHANNEL_ID: "+h+"\nConnect PULL_PATH: "+A+"\n\nData array: "+JSON.stringify(N)+"\n================================\n\n";console.log(O)}h=null;r.onCustomEvent(j,"onPullStatus",["offline"])}}else{if(typeof(console)=="object"){var O="\n========= PULL ERROR ===========\nError type: updateState parse\n\nConnect CHANNEL_ID: "+h+"\nConnect PULL_PATH: "+A+"\n\nData string: "+H[J]+"\n================================\n\n";console.log(O)}h=null;r.onCustomEvent(j,"onPullStatus",["offline"])}s=L.tag;o=L.time;I++}}else{if(typeof(console)=="object"){var O="\n========= PULL ERROR ===========\nError type: updateState error getting message\n\nConnect CHANNEL_ID: "+h+"\nConnect PULL_PATH: "+A+"\n\nData string: "+N+"\n================================\n\n";console.log(O)}h=null;r.onCustomEvent(j,"onPullStatus",["offline"])}if(I>0||G&&G.status==0){r.PULL.updateState(I>0?"19":"20")}else{h=null;z=setTimeout(function(){r.PULL.updateState("21")},10000)}}else{if(G&&G.status==304){r.PULL.updateState("22")}else{if(G&&(G.status==502||G.status==500)){r.onCustomEvent(j,"onPullStatus",["offline"]);x++;h=null;z=setTimeout(function(){r.PULL.updateState("23")},r.PULL.tryConnectTimeout())}else{r.onCustomEvent(j,"onPullStatus",["offline"]);if(G&&G.status==0&&e){var M=2000;e=false}else{x++;h=null;var M=r.PULL.tryConnectTimeout()}var K=(G&&G.status?G.status:"NaN");z=setTimeout(function(){r.PULL.updateState("24-"+K+"-"+(M/1000))},M)}}}}},onfailure:function(H){r.onCustomEvent(j,"onPullStatus",["offline"]);u=false;x++;if(H=="timeout"){if(n=="PULL"){r.PULL.setUpdateStateStep()}else{r.PULL.updateState("25")}}else{if(G&&(G.status==403||G.status==404||G.status==400)){h=null;setTimeout(function(){r.PULL.getChannelID("7-"+G.status,G.status==403?true:false)},(x<2?50:r.PULL.tryConnectTimeout()))}else{if(G&&(G.status==500||G.status==502)){h=null;setTimeout(function(){r.PULL.getChannelID("8-"+G.status)},(x<2?50:r.PULL.tryConnectTimeout()))}else{if(typeof(console)=="object"){var I="\n========= PULL ERROR ===========\nError type: updateState onfailure\n\nConnect CHANNEL_ID: "+h+"\nConnect PULL_PATH: "+A+"\n\nData array: "+JSON.stringify(H)+"\n================================\n\n";console.log(I)}if(n=="PULL"){z=setTimeout(r.PULL.setUpdateStateStep,10000)}else{z=setTimeout(function(){r.PULL.updateState("26")},10000)}}}}}})},F?150:(n=="PULL"?t:0.3)*1000)};r.PULL.extendWatch=function(F,G){if(F.length<=0){return false}m[F]=true;if(G===true){r.PULL.updateWatch(true)}};r.PULL.clearWatch=function(F){if(F=="undefined"){m={}}else{if(m[F]){delete m[F]}}};r.PULL.updateWatch=function(F){if(!c){return false}F=F==true?true:false;clearTimeout(E);E=setTimeout(function(){var G=[];for(var H in m){G.push(H)}if(G.length>0){r.ajax({url:"/bitrix/components/bitrix/pull.request/ajax.php?UPDATE_WATCH",method:"POST",dataType:"json",timeout:30,lsId:"PULL_WATCH_"+location.pathname,lsTimeout:5,data:{PULL_UPDATE_WATCH:"Y",WATCH:G,SITE_ID:r.message("SITE_ID"),PULL_AJAX_CALL:"Y",sessid:r.bitrix_sessid()},onsuccess:r.delegate(function(){r.localStorage.set("puw",location.pathname,5)},this)})}r.PULL.updateWatch()},F?5000:1740000)};r.PULL.executeMessages=function(G,H){H=H==false?false:true;for(var F=0;F<G.length;F++){if(G[F].id){G[F].id=parseInt(G[F].id);if(y[""+h+G[F].id]){continue}else{y[""+h+G[F].id]=G[F].id}if(D<G[F].id){D=G[F].id}}if(G[F].module_id=="pull"){if(H){if(G[F].command=="channel_die"){h=null}if(G[F].command=="config_die"){A=null}}}else{if(!(G[F].module_id=="main"&&G[F].command=="user_counter")){r.PULL.setUpdateStateStepCount(1,4)}try{r.onCustomEvent(j,"onPullEvent",[G[F].module_id,G[F].command,G[F].params],true)}catch(I){if(typeof(console)=="object"){var J="\n========= PULL ERROR ===========\nError type: onPullEvent onfailure\nError event: "+JSON.stringify(I)+"\n\nMessage MODULE_ID: "+G[F].module_id+"\nMessage COMMAND: "+G[F].command+"\nMessage PARAMS: "+G[F].params+"\n\nMessage array: "+JSON.stringify(G[F])+"\n================================\n";console.log(J);r.debug(I)}}}}};r.PULL.setUpdateStateStep=function(G){var G=G==false?false:true;var F=60;if(w>0){F=10;w--}else{if(g>0){F=20;g--}}t=parseInt(F);r.PULL.updateState("27");if(G&&i){r.localStorage.set("puss",t,5)}};r.PULL.setUpdateStateStepCount=function(F,G){w=parseInt(F);g=parseInt(G)};r.PULL.storageSet=function(F){if(F.key=="pus"){if(F.value.TAG!=null){s=F.value.TAG}if(F.value.TIME!=null){o=F.value.TIME}r.PULL.executeMessages(F.value.MESSAGE,false)}else{if(F.key=="puss"){t=70;r.PULL.updateState("28")}else{if(F.key=="pgc"){r.PULL.getChannelID("9",F.value,false)}else{if(F.key=="pset"){h=F.value.CHANNEL_ID;D=F.value.LAST_ID;A=F.value.PATH;C=F.value.PATH_WS;n=F.value.METHOD;if(F.value.TIME){o=F.value.TIME}if(F.value.TAG){s=F.value.TAG}if(F.value.TIME_LAST_GET){l=F.value.TIME_LAST_GET}if(h!=null){if(!r.PULL.tryConnect()){r.PULL.updateState("29",true)}}}else{if(F.key=="puw"){if(F.value==location.pathname){r.PULL.updateWatch()}}}}}}};r.PULL.updateChannelID=function(J){if(typeof(J)!="object"){return false}var L=J.METHOD;var G=J.CHANNEL_ID;var I=J.CHANNEL_DT;var K=J.PATH;var H=J.LAST_ID;var F=J.PATH_WS;if(typeof(G)=="undefined"||typeof(K)=="undefined"){return false}if(G==h&&K==A&&F==C){return false}h=G;l=parseInt(I)+parseInt(r.message("SERVER_TZ_OFFSET"))+parseInt(r.message("USER_TZ_OFFSET"));A=K.replace("#DOMAIN#",location.hostname);C=F.replace("#DOMAIN#",location.hostname);D=n=="PULL"&&typeof(H)=="number"?H:D;if(typeof(L)=="string"){n=L}if(i){r.localStorage.set("pset",{CHANNEL_ID:h,LAST_ID:D,PATH:A,PATH:C,TAG:s,TIME:o,TIME_LAST_GET:l,METHOD:n},600)}if(k){k.close()}return true};r.PULL.tryConnectTimeout=function(){var F=0;if(x<=2){F=15000}else{if(x>2&&x<=5){F=45000}else{if(x>5&&x<=10){F=600000}else{if(x>10){c=false;F=3600000}}}}return F};r.PULL.tryConnectSet=function(F,G){if(typeof(F)=="number"){x=parseInt(F)}if(typeof(G)=="boolean"){c=G}};r.PULL.getPullServerStatus=function(){return n=="PULL"?false:true};r.PULL.getDebugInfo=function(){if(!console||!console.log||!JSON||!JSON.stringify){return false}var G=JSON.stringify(m);var F="\n========= PULL DEBUG ===========\nConnect: "+(u?"Y":"N")+"\nWebSocket connect: "+(f?"Y":"N")+"\nLocalStorage status: "+(i?"Y":"N")+"\nWebSocket support: "+(q&&C.length>0?"Y":"N")+"\nQueue Server: "+(n=="PULL"?"N":"Y")+"\nTry connect: "+(c?"Y":"N")+"\nTry number: "+(x)+"\n\nPath: "+A+"\n"+(C.length>0?"WebSocket Path: "+C+"\n":"")+"ChannelID: "+h+"\nChannelDie: "+(parseInt(l))+"\n\nLast message: "+(D>0?D:"-")+"\nTime init connect: "+(p)+"\nTime last connect: "+(o==p?"-":o)+"\nWatch tags: "+(G=="{}"?"-":G)+"\n================================\n";return console.log(F)};r.PULL.clearChannelId=function(F){F=F==false?false:true;h=null;A=null;u=false;clearTimeout(z);if(F){r.PULL.updateState("30")}};r.PULL()})(window);