BX.namespace("BX.Sale.OrderAjaxComponent.Maps");(function(){"use strict";BX.Sale.OrderAjaxComponent.Maps={init:function(t){this.context=t||{};this.pickUpOptions=this.context.options.pickUpMap;this.propsOptions=this.context.options.propertyMap;this.maxWaitTimeExpired=false;return this},initializePickUpMap:function(t){if(!ymaps)return;this.pickUpMap=new ymaps.Map("pickUpMap",{center:!!t?[t.GPS_N,t.GPS_S]:[this.pickUpOptions.defaultMapPosition.lat,this.pickUpOptions.defaultMapPosition.lon],zoom:this.pickUpOptions.defaultMapPosition.zoom});this.pickUpMap.behaviors.disable("scrollZoom");this.pickUpMap.events.add("click",BX.delegate(function(){if(this.pickUpMap.balloon.isOpen()){this.pickUpMap.balloon.close()}},this))},pickUpMapFocusWaiter:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.setPickUpMapFocus()}else{setTimeout(BX.proxy(this.pickUpMapFocusWaiter,this),100)}},setPickUpMapFocus:function(){var t,e,i;t=this.pickUpMap.geoObjects.getBounds();if(t&&t.length){e=t[1][0]-t[0][0];i=t[1][1]-t[0][1];t[0][0]-=e/10;t[0][1]-=i/10;t[1][0]+=e/10;t[1][1]+=i/10;this.pickUpMap.setBounds(t,{checkZoomRange:true})}},showNearestPickups:function(t,e){if(!ymaps)return;var i=this.pickUpOptions.secureGeoLocation&&BX.browser.IsChrome()&&!this.context.isHttps?"yandex":"auto";var s=this.pickUpOptions.geoLocationMaxTime||5e3;ymaps.geolocation.get({provider:i,timeOut:s}).then(BX.delegate(function(e){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;e.geoObjects.options.set("preset","islands#darkGreenCircleDotIcon");this.pickUpMap.geoObjects.add(e.geoObjects);t(e)}},this),BX.delegate(function(){if(!this.maxWaitTimeExpired){this.maxWaitTimeExpired=true;e()}},this))},buildBalloons:function(t){if(!ymaps)return;var e=this;this.pickUpPointsJSON=[];for(var i=0;i<t.length;i++){var s=this.getStoreInfoHtml(t[i]);this.pickUpPointsJSON.push({type:"Feature",geometry:{type:"Point",coordinates:[t[i].GPS_N,t[i].GPS_S]},properties:{storeId:t[i].ID}});var o=new ymaps.Placemark([t[i].GPS_N,t[i].GPS_S],{hintContent:BX.util.htmlspecialchars(t[i].TITLE)+"<br />"+BX.util.htmlspecialchars(t[i].ADDRESS),storeTitle:t[i].TITLE,storeBody:s,id:t[i].ID,text:this.context.params.MESS_SELECT_PICKUP},{balloonContentLayout:ymaps.templateLayoutFactory.createClass("<h3>{{ properties.storeTitle }}</h3>"+"{{ properties.storeBody|raw }}"+'<br /><a class="btn btn-sm btn-primary" data-store="{{ properties.id }}">{{ properties.text }}</a>',{build:function(){this.constructor.superclass.build.call(this);var t=document.querySelector("a[data-store]");if(t)BX.bind(t,"click",this.selectStoreByClick)},clear:function(){var t=document.querySelector("a[data-store]");if(t)BX.unbind(t,"click",this.selectStoreByClick);this.constructor.superclass.clear.call(this)},selectStoreByClick:function(t){var i=t.target||t.srcElement;if(e.pickUpMap.container.isFullscreen()){e.pickUpMap.container.exitFullscreen()}e.context.selectStore(i.getAttribute("data-store"));e.context.clickNextAction(t);e.pickUpMap.balloon.close()}})});if(BX("BUYER_STORE").value===t[i].ID){o.options.set("preset","islands#redDotIcon")}this.pickUpMap.geoObjects.add(o)}},selectBalloon:function(t){if(this.pickUpMap&&this.pickUpMap.geoObjects){this.pickUpMap.geoObjects.each(BX.delegate(function(e){if(e.properties.get("id")){e.options.unset("preset")}if(e.properties.get("id")===t){e.options.set({preset:"islands#redDotIcon"});this.pickUpMap.panTo([e.geometry.getCoordinates()])}},this))}},pickUpFinalAction:function(){if(this.pickUpMap&&this.pickUpMap.geoObjects){var t=BX("BUYER_STORE");this.pickUpMap.geoObjects.each(function(e){if(e.properties.get("id")===t.value){e.options.set({preset:"islands#redDotIcon"})}else if(parseInt(e.properties.get("id"))>0){e.options.unset("preset")}})}},initializePropsMap:function(t){if(!ymaps)return;this.propsMap=new ymaps.Map("propsMap",{center:[t.lat,t.lon],zoom:t.zoom});this.propsMap.behaviors.disable("scrollZoom");this.propsMap.events.add("click",BX.delegate(function(t){var e=t.get("coords"),i;if(this.propsMap.geoObjects.getLength()===0){i=new ymaps.Placemark([e[0],e[1]],{},{draggable:true,preset:"islands#redDotIcon"});i.events.add(["parentchange","geometrychange"],function(){var t=BX("orderDescription"),e=i.geometry.getCoordinates(),s,o,p,a;if(t){s=t.value.indexOf(BX.message("SOA_MAP_COORDS")+":");if(s===-1){t.value=BX.message("SOA_MAP_COORDS")+": "+e[0]+", "+e[1]+"\r\n"+t.value}else{a=BX.message("SOA_MAP_COORDS")+": "+e[0]+", "+e[1];o=t.value.substring(0,s);p=t.value.substring(s+a.length);t.value=o+a+p}}});this.propsMap.geoObjects.add(i)}else{this.propsMap.geoObjects.get(0).geometry.setCoordinates([e[0],e[1]])}},this))},canUseRecommendList:function(){return this.pickUpPointsJSON&&this.pickUpPointsJSON.length},getRecommendedStoreIds:function(t){if(!t)return[];var e=[];var i=this.pickUpPointsJSON.length<this.pickUpOptions.nearestPickUpsToShow?this.pickUpPointsJSON.length:this.pickUpOptions.nearestPickUpsToShow;this.storeQueryResult={};for(var s=0;s<i;s++){var o=ymaps.geoQuery({type:"FeatureCollection",features:this.pickUpPointsJSON});var p=o.getClosestTo(t);var a=p.properties.get("storeId");this.storeQueryResult[a]=p;e.push(a);this.pickUpPointsJSON.splice(o.indexOf(p),1)}return e},getDistance:function(t,e){if(!t||!e)return false;var i=this.storeQueryResult[e];var s=ymaps.coordSystem.geo.getDistance(t.geometry.getCoordinates(),i.geometry.getCoordinates());s=Math.round(s/100)/10;return s},propsMapFocusWaiter:function(){},getStoreInfoHtml:function(t){var e="";if(t.ADDRESS)e+=BX.message("SOA_PICKUP_ADDRESS")+": "+BX.util.htmlspecialchars(t.ADDRESS)+"<br />";if(t.PHONE)e+=BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(t.PHONE)+"<br />";if(t.SCHEDULE)e+=BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(t.SCHEDULE)+"<br />";if(t.DESCRIPTION)e+=BX.message("SOA_PICKUP_DESC")+": "+BX.util.htmlspecialchars(t.DESCRIPTION)+"<br />";return e}}})();