BX.namespace("BX.Sale.component.location.selector");if(typeof BX.Sale.component.location.selector.steps=="undefined"&&typeof BX.ui!="undefined"&&typeof BX.ui.widget!="undefined"){BX.Sale.component.location.selector.steps=function(a,b){this.parentConstruct(BX.Sale.component.location.selector.steps,a);BX.merge(this,{opts:{bindEvents:{"after-select-item":function(c){if(typeof this.opts.callback=="string"&&this.opts.callback.length>0&&this.opts.callback in window){window[this.opts.callback].apply(this,[c,this])}}},disableKeyboardInput:false,dontShowNextChoice:false,pseudoValues:[],provideLinkBy:"id"},vars:{cache:{nodesByCode:{}}},sys:{code:"slst"}});this.handleInitStack(b,BX.Sale.component.location.selector.steps,a)};BX.extend(BX.Sale.component.location.selector.steps,BX.ui.chainedSelectors);BX.merge(BX.Sale.component.location.selector.steps.prototype,{init:function(){this.pushFuncStack("buildUpDOM",BX.Sale.component.location.selector.steps);this.pushFuncStack("bindEvents",BX.Sale.component.location.selector.steps)},buildUpDOM:function(){},bindEvents:function(){var a=this,b=this.opts;if(b.disableKeyboardInput){this.bindEvent("after-control-placed",function(c){var d=c.getControl();BX.unbindAll(d.ctrls.toggle);BX.bind(d.ctrls.scope,"click",function(f){d.toggleDropDown()})})}BX.bindDelegate(this.getControl("quick-locations",true),"click",{tag:"a"},function(){a.setValueByLocationId(BX.data(this,"id"))})},setValueByLocationId:function(a){this.tmpls["selector-scope"]=this.tmpls["selector-scope"].replace("bx-ui-combobox-fake","bx-ui-combobox-fake textinput40");BX.Sale.component.location.selector.steps.superclass.setValue.apply(this,[a])},setValueByLocationCode:function(c){var b=this.vars;if(c==null||c==false||typeof c=="undefined"||c.toString().length==0){this.displayRoute([]);this.setValueVariable("");this.setTargetValue("");this.fireEvent("after-clear-selection");return}this.fireEvent("before-set-value",[c]);var e=new BX.deferred();var a=this;e.done(BX.proxy(function(d){this.displayRoute(d);var f=b.cache.nodesByCode[c].VALUE;b.value=f;this.setTargetValue(this.checkCanSelectItem(f)?f:this.getLastValidValue())},this));e.fail(function(d){if(d=="notfound"){a.displayRoute([]);a.setValueVariable("");a.setTargetValue("");a.showError({errors:[a.opts.messages.nothingFound],type:"server-logic",options:{}})}});this.hideError();this.getRouteToNodeByCode(c,e)},setValue:function(a){if(this.opts.provideLinkBy=="id"){BX.Sale.component.location.selector.steps.superclass.setValue.apply(this,[a])}else{this.setValueByLocationCode(a)}},setTargetValue:function(a){this.setTargetInputValue(this.opts.provideLinkBy=="code"?(a?this.vars.cache.nodes[a].CODE:""):a);this.fireEvent("after-select-item",[a])},getValue:function(){if(this.opts.provideLinkBy=="id"){return this.vars.value===false?"":this.vars.value}else{return this.vars.value?this.vars.cache.nodes[this.vars.value].CODE:""}},getSelectedPath:function(){var b=this.vars,a=[];if(typeof b.value=="undefined"||b.value==false||b.value==""){return a}if(typeof b.cache.nodes[b.value]!="undefined"){var d=b.cache.nodes[b.value];while(typeof d!="undefined"){var c=BX.clone(d);var e=c.PARENT_VALUE;delete (c.PATH);delete (c.PARENT_VALUE);delete (c.IS_PARENT);if(typeof c.TYPE_ID!="undefined"&&typeof this.opts.types!="undefined"){c.TYPE=this.opts.types[c.TYPE_ID].CODE}a.push(c);if(typeof e=="undefined"||typeof b.cache.nodes[e]=="undefined"){break}else{d=b.cache.nodes[e]}}}return a},setInitialValue:function(){if(this.opts.selectedItem!==false){this.setValueByLocationId(this.opts.selectedItem)}else{if(this.ctrls.inputs.origin.value.length>0){if(this.opts.provideLinkBy=="id"){this.setValueByLocationId(this.ctrls.inputs.origin.value)}else{this.setValueByLocationCode(this.ctrls.inputs.origin.value)}}}},getRouteToNodeByCode:function(e,f){var b=this.vars,a=this;if(typeof e!="undefined"&&e!==false&&e.toString().length>0){var c=[];if(typeof b.cache.nodesByCode[e]!="undefined"){c=this.getRouteToNodeFromCache(b.cache.nodesByCode[e].VALUE)}if(c.length==0){a.downloadBundle({request:{CODE:e},callbacks:{onLoad:function(g){for(var d in g){if(typeof b.cache.links[d]=="undefined"){b.cache.incomplete[d]=true}}a.fillCache(g,true);c=[];if(typeof b.cache.nodesByCode[e]!="undefined"){c=this.getRouteToNodeFromCache(b.cache.nodesByCode[e].VALUE)}if(c.length==0){f.reject("notfound")}else{f.resolve(c)}},onError:function(){f.reject("internal")}},options:{}})}else{f.resolve(c)}}else{f.resolve([])}},addItem2Cache:function(a){this.vars.cache.nodes[a.VALUE]=a;this.vars.cache.nodesByCode[a.CODE]=a},controlChangeActions:function(e,d){var b=this,f=this.opts,a=this.vars,g=this.ctrls;this.hideError();if(d.length==0){b.truncateStack(e);a.value=b.getLastValidValue();b.setTargetValue(a.value);this.fireEvent("after-select-real-value")}else{if(BX.util.in_array(d,f.pseudoValues)){b.truncateStack(e);b.setTargetValue(b.getLastValidValue());this.fireEvent("after-select-item",[d]);this.fireEvent("after-select-pseudo-value")}else{var c=a.cache.nodes[d];if(typeof c=="undefined"){throw new Error("Selected node not found in the cache")}b.truncateStack(e);if(f.dontShowNextChoice){if(c.IS_UNCHOOSABLE){b.appendControl(d)}}else{if(typeof a.cache.links[d]!="undefined"||c.IS_PARENT){b.appendControl(d)}}if(b.checkCanSelectItem(d)){a.value=d;b.setTargetValue(d);this.fireEvent("after-select-real-value")}}}},refineRequest:function(c){var b={};var a={VALUE:"ID",DISPLAY:"NAME.NAME","1":"TYPE_ID","2":"CODE"};var d={};if(typeof c.PARENT_VALUE!="undefined"){b["=PARENT_ID"]=c.PARENT_VALUE;a["10"]="IS_PARENT"}if(typeof c.VALUE!="undefined"){b["=ID"]=c.VALUE;d["1"]="PATH"}if(BX.type.isNotEmptyString(c.CODE)){b["=CODE"]=c.CODE;d["1"]="PATH"}if(BX.type.isNotEmptyString(this.opts.query.BEHAVIOUR.LANGUAGE_ID)){b["=NAME.LANGUAGE_ID"]=this.opts.query.BEHAVIOUR.LANGUAGE_ID}if(BX.type.isNotEmptyString(this.opts.query.FILTER.SITE_ID)){if(typeof this.vars.cache.nodes[c.PARENT_VALUE]=="undefined"||this.vars.cache.nodes[c.PARENT_VALUE].IS_UNCHOOSABLE){b["=SITE_ID"]=this.opts.query.FILTER.SITE_ID}}return{select:a,filter:b,additionals:d,version:"2"}},refineResponce:function(b,e){if(b.length==0){return b}if(typeof e.PARENT_VALUE!="undefined"){var d={};d[e.PARENT_VALUE]=b.ITEMS;b=d}else{if(typeof e.VALUE!="undefined"||typeof e.CODE!="undefined"){var f={};if(typeof b.ITEMS[0]!="undefined"&&typeof b.ETC.PATH_ITEMS!="undefined"){var h=0;for(var a=b.ITEMS[0]["PATH"].length-1;a>=0;a--){var g=b.ITEMS[0]["PATH"][a];var c=b.ETC.PATH_ITEMS[g];c.IS_PARENT=true;f[h]=[c];h=c.VALUE}f[h]=[b.ITEMS[0]]}b=f}}return b},showError:function(a){if(a.type!="server-logic"){a.errors=[this.opts.messages.error]}this.setCSSState("error",this.ctrls.scope);this.ctrls.errorMessage.innerHTML='<p><font class="errortext">'+BX.util.htmlspecialchars(a.errors.join(", "))+"</font></p>";BX.debug(a)}})};