JCCatalogSection=function(a){this.productType=0;this.showQuantity=true;this.showAbsent=true;this.secondPict=false;this.showOldPrice=false;this.showPercent=false;this.showSkuProps=false;this.visual={ID:"",PICT_ID:"",SECOND_PICT_ID:"",QUANTITY_ID:"",QUANTITY_UP_ID:"",QUANTITY_DOWN_ID:"",PRICE_ID:"",DSC_PERC:"",SECOND_DSC_PERC:"",DISPLAY_PROP_DIV:""};this.product={checkQuantity:false,maxQuantity:0,stepQuantity:1,isDblQuantity:false,canBuy:true,canSubscription:true,name:"",pict:{},id:0};this.defaultPict={pict:null,secondPict:null};this.ajaxPath="";this.checkQuantity=false;this.maxQuantity=0;this.stepQuantity=1;this.isDblQuantity=false;this.canBuy=true;this.canSubscription=true;this.offers=[];this.offerNum=0;this.treeProps=[];this.obTreeRows=[];this.showCount=[];this.showStart=[];this.selectedValues={};this.obProduct=null;this.obQuantity=null;this.obQuantityUp=null;this.obQuantityDown=null;this.obPict=null;this.obSecondPict=null;this.obPrice=null;this.obTree=null;this.obBuyBtn=null;this.obDscPerc=null;this.obSecondDscPerc=null;this.obSkuProps=null;this.obMeasure=null;this.errorCode=0;if("object"==typeof(a)){this.productType=parseInt(a.PRODUCT_TYPE);this.showQuantity=a.SHOW_QUANTITY;this.showAbsent=a.SHOW_ABSENT;if(!!a.SECOND_PICT){this.secondPict=true}if(!!a.SHOW_OLD_PRICE){this.showOldPrice=true}if(!!a.SHOW_DISCOUNT_PERCENT){this.showPercent=true}if(!!a.SHOW_SKU_PROPS){this.showSkuProps=true}this.visual=a.VISUAL;this.ajaxPath=a.AJAX_PATH;switch(this.productType){case 1:case 2:if(!!a.PRODUCT&&"object"==typeof(a.PRODUCT)){if(this.showQuantity){this.product.checkQuantity=a.PRODUCT.CHECK_QUANTITY;this.product.isDblQuantity=a.PRODUCT.QUANTITY_FLOAT;if(this.product.checkQuantity){this.product.maxQuantity=(this.product.isDblQuantity?parseFloat(a.PRODUCT.MAX_QUANTITY):parseInt(a.PRODUCT.MAX_QUANTITY))}this.product.stepQuantity=(this.product.isDblQuantity?parseFloat(a.PRODUCT.STEP_QUANTITY):parseInt(a.PRODUCT.STEP_QUANTITY));this.checkQuantity=this.product.checkQuantity;this.isDblQuantity=this.product.isDblQuantity;this.maxQuantity=this.product.maxQuantity;this.stepQuantity=this.product.stepQuantity}this.product.canBuy=a.PRODUCT.CAN_BUY;this.product.canSubscription=a.PRODUCT.SUBSCRIPTION;this.canBuy=this.product.canBuy;this.canSubscription=this.product.canSubscription;this.product.name=a.PRODUCT.NAME;this.product.pict=a.PRODUCT.PICT;this.product.id=a.PRODUCT.ID}else{this.errorCode=-1}break;case 3:if(!!a.OFFERS&&BX.type.isArray(a.OFFERS)){this.offers=a.OFFERS;this.offerNum=0;if(!!a.OFFER_SELECTED){this.offerNum=parseInt(a.OFFER_SELECTED)}if(isNaN(this.offerNum)){this.offerNum=0}if(!!a.TREE_PROPS){this.treeProps=a.TREE_PROPS}if(!!a.DEFAULT_PICTURE){this.defaultPict.pict=a.DEFAULT_PICTURE.PICTURE;this.defaultPict.secondPict=a.DEFAULT_PICTURE.PICTURE_SECOND}}else{this.errorCode=-1}break;default:this.errorCode=-1}}if(0==this.errorCode){BX.ready(BX.delegate(this.Init,this))}};JCCatalogSection.prototype.Init=function(){var a=0;this.obProduct=BX(this.visual.ID);if(!this.obProduct){this.errorCode=-1}this.obPict=BX(this.visual.PICT_ID);if(!this.obPict){this.errorCode=-2}if(this.secondPict&&!!this.visual.SECOND_PICT_ID){this.obSecondPict=BX(this.visual.SECOND_PICT_ID)}this.obPrice=BX(this.visual.PRICE_ID);if(!this.obPrice){this.errorCode=-16}if(this.showQuantity&&!!this.visual.QUANTITY_ID){this.obQuantity=BX(this.visual.QUANTITY_ID);if(!this.obQuantity){this.errorCode=-32}if(!!this.visual.QUANTITY_UP_ID){this.obQuantityUp=BX(this.visual.QUANTITY_UP_ID);if(!this.obQuantityUp){this.errorCode=-64}}if(!!this.visual.QUANTITY_DOWN_ID){this.obQuantityDown=BX(this.visual.QUANTITY_DOWN_ID);if(!this.obQuantityDown){this.errorCode=-128}}}if(3==this.productType){if(!!this.visual.TREE_ID){this.obTree=BX(this.visual.TREE_ID);if(!this.obTree){this.errorCode=-256}var c=this.visual.TREE_ITEM_ID;for(a=0;a<this.treeProps.length;a++){this.obTreeRows[a]={LEFT:BX(c+this.treeProps[a].ID+"_left"),RIGHT:BX(c+this.treeProps[a].ID+"_right"),LIST:BX(c+this.treeProps[a].ID+"_list"),CONT:BX(c+this.treeProps[a].ID+"_cont")};if(!this.obTreeRows[a].LEFT||!this.obTreeRows[a].RIGHT||!this.obTreeRows[a].LIST||!this.obTreeRows[a].CONT){this.errorCode=-512;break}}}if(!!this.visual.QUANTITY_MEASURE){this.obMeasure=BX(this.visual.QUANTITY_MEASURE)}}if(!!this.visual.BUY_ID){this.obBuyBtn=BX(this.visual.BUY_ID);if(!this.obBuyBtn){}}if(this.showPercent){if(!!this.visual.DSC_PERC){this.obDscPerc=BX(this.visual.DSC_PERC)}if(this.secondPict&&!!this.visual.SECOND_DSC_PERC){this.obSecondDscPerc=BX(this.visual.SECOND_DSC_PERC)}}if(this.showSkuProps){if(!!this.visual.DISPLAY_PROP_DIV){this.obSkuProps=BX(this.visual.DISPLAY_PROP_DIV)}}if(0==this.errorCode){if(this.showQuantity){BX.bind(this.obQuantityUp,"click",BX.delegate(this.QuantityUp,this));BX.bind(this.obQuantityDown,"click",BX.delegate(this.QuantityDown,this));BX.bind(this.obQuantity,"change",BX.delegate(this.QuantityChange,this))}switch(this.productType){case 1:break;case 3:var b=BX.findChildren(this.obTree,{tagName:"li"},true);if(!!b&&0<b.length){for(a=0;a<b.length;a++){BX.bind(b[a],"click",BX.delegate(function(d){this.SelectOfferProp(d)},this))}}for(a=0;a<this.obTreeRows.length;a++){BX.bind(this.obTreeRows[a].LEFT,"click",BX.delegate(function(d){this.RowLeft(d)},this));BX.bind(this.obTreeRows[a].RIGHT,"click",BX.delegate(function(d){this.RowRight(d)},this))}this.SetCurrent();break}if(!!this.obBuyBtn){BX.bind(this.obBuyBtn,"click",BX.delegate(this.Basket,this))}}};JCCatalogSection.prototype.QuantityUp=function(){var b=0;var a=true;if(0==this.errorCode&&this.showQuantity){b=(this.isDblQuantity?parseFloat(this.obQuantity.value):parseInt(this.obQuantity.value));if(!isNaN(b)){b+=this.stepQuantity;if(this.checkQuantity){if(b>this.maxQuantity){a=false}}if(a){this.obQuantity.value=b}}}};JCCatalogSection.prototype.QuantityDown=function(){var b=0;var a=true;if(0==this.errorCode&&this.showQuantity){b=(this.isDblQuantity?parseFloat(this.obQuantity.value):parseInt(this.obQuantity.value));if(!isNaN(b)){b-=this.stepQuantity;if(b<this.stepQuantity){a=false}if(a){this.obQuantity.value=b}}}};JCCatalogSection.prototype.QuantityChange=function(){var b=0;var a=true;if(0==this.errorCode&&this.showQuantity){b=(this.isDblQuantity?parseFloat(this.obQuantity.value):parseInt(this.obQuantity.value));if(!isNaN(b)){if(this.checkQuantity){if(b>this.maxQuantity){a=false;b=this.maxQuantity}else{if(b<this.stepQuantity){a=false;b=this.stepQuantity}}}if(!a){this.obQuantity.value=b}}else{this.obQuantity.value=this.stepQuantity}}};JCCatalogSection.prototype.QuantitySet=function(a){if(0==this.errorCode){this.canBuy=this.offers[a].CAN_BUY;if(this.showQuantity){this.isDblQuantity=this.offers[a].QUANTITY_FLOAT;this.checkQuantity=this.offers[a].CHECK_QUANTITY;this.maxQuantity=(this.isDblQuantity?parseFloat(this.offers[a].MAX_QUANTITY):parseInt(this.offers[a].MAX_QUANTITY));this.stepQuantity=(this.isDblQuantity?parseFloat(this.offers[a].STEP_QUANTITY):parseInt(this.offers[a].STEP_QUANTITY));this.obQuantity.value=this.stepQuantity;if(!!this.obMeasure){if(!!this.offers[a].MEASURE){BX.adjust(this.obMeasure,{html:this.offers[a].MEASURE})}else{BX.adjust(this.obMeasure,{html:""})}}}}};JCCatalogSection.prototype.SelectOfferProp=function(c){if(!c){c=window.event}var b=BX.proxy_context;if(!!b&&b.hasAttribute("data-treevalue")){var a=b.getAttribute("data-treevalue");var d=a.split("_");if(this.SearchOfferPropIndex(d[0],d[1])){var f=BX.findChildren(b.parentNode,{tagName:"li"},false);if(!!f&&0<f.length){for(i=0;i<f.length;i++){value=f[i].getAttribute("data-onevalue");if(value==d[1]){BX.addClass(f[i],"bx_active")}else{BX.removeClass(f[i],"bx_active")}}}}}};JCCatalogSection.prototype.SearchOfferPropIndex=function(b,k){var d=-1;for(var c=0;c<this.treeProps.length;c++){if(this.treeProps[c].ID==b){d=c;break}}if(-1<d){var f={};for(c=0;c<d;c++){var e="PROP_"+this.treeProps[c].ID;f[e]=this.selectedValues[e]}var e="PROP_"+this.treeProps[d].ID;var l=this.GetRowValues(f,e);if(!l){return false}if(!BX.util.in_array(k,l)){return false}f[e]=k;for(c=d+1;c<this.treeProps.length;c++){e="PROP_"+this.treeProps[c].ID;var l=this.GetRowValues(f,e);if(!l){return false}if(this.showAbsent){var g=[];var h=[];h=BX.clone(f,true);for(var a=0;a<l.length;a++){h[e]=l[a];if(this.GetCanBuy(h)){g[g.length]=l[a]}}}else{var g=l}if(!!this.selectedValues[e]&&BX.util.in_array(this.selectedValues[e],g)){f[e]=this.selectedValues[e]}else{f[e]=g[0]}this.UpdateRow(c,f[e],l,g)}this.selectedValues=f;this.ChangeInfo()}return true};JCCatalogSection.prototype.RowLeft=function(f){if(!f){f=window.event}var d=BX.proxy_context;if(!!d&&d.hasAttribute("data-treevalue")){var c=d.getAttribute("data-treevalue");var a=-1;for(var b=0;b<this.treeProps.length;b++){if(this.treeProps[b].ID==c){a=b;break}}if(-1<a&&5<this.showCount[a]){if((5-this.showStart[a])<this.showCount[a]){this.showStart[a]--;BX.adjust(this.obTreeRows[a].LIST,{style:{marginLeft:this.showStart[a]*20+"%"}})}}}};JCCatalogSection.prototype.RowRight=function(f){if(!f){f=window.event}var d=BX.proxy_context;if(!!d&&d.hasAttribute("data-treevalue")){var c=d.getAttribute("data-treevalue");var a=-1;for(var b=0;b<this.treeProps.length;b++){if(this.treeProps[b].ID==c){a=b;break}}if(-1<a&&5<this.showCount[a]){if(0>this.showStart[a]){this.showStart[a]++;BX.adjust(this.obTreeRows[a].LIST,{style:{marginLeft:this.showStart[a]*20+"%"}})}}}};JCCatalogSection.prototype.UpdateRow=function(j,f,g,a){var d=0;var h;var b=0;var c="";if(-1<j&&j<this.obTreeRows.length){var e=BX.findChildren(this.obTreeRows[j].LIST,{tagName:"li"},false);if(!!e&&0<e.length){b=g.length;c=(5<b?(100/b)+"%":"20%");obData={props:{className:""},style:{width:c}};if("E"==this.treeProps[j].TYPE){obData.style.paddingTop=c}for(d=0;d<e.length;d++){h=e[d].getAttribute("data-onevalue");if(BX.util.in_array(h,a)){if(h==f){obData.props.className="bx_active"}else{obData.props.className=""}}else{if(h==f){obData.props.className="bx_active bx_missing"}else{obData.props.className="bx_missing"}}if(BX.util.in_array(h,g)){obData.style.display=""}else{obData.style.display="none"}BX.adjust(e[d],obData)}obData={style:{width:(5<b?20*b:100)+"%",marginLeft:"0%"}};BX.adjust(this.obTreeRows[j].LIST,obData);if("E"==this.treeProps[j].TYPE){BX.adjust(this.obTreeRows[j].CONT,{props:{className:(5<b?"bx_item_detail_scu full":"bx_item_detail_scu")}})}else{BX.adjust(this.obTreeRows[j].CONT,{props:{className:(5<b?"bx_item_detail_size full":"bx_item_detail_size")}})}if(5<b){BX.adjust(this.obTreeRows[j].LEFT,{style:{display:""}});BX.adjust(this.obTreeRows[j].RIGHT,{style:{display:""}})}else{BX.adjust(this.obTreeRows[j].LEFT,{style:{display:"none"}});BX.adjust(this.obTreeRows[j].RIGHT,{style:{display:"none"}})}this.showCount[j]=b;this.showStart[j]=0}}};JCCatalogSection.prototype.GetRowValues=function(b,d){var a=[];var f=false;if(0==b.length){for(var e=0;e<this.offers.length;e++){if(!BX.util.in_array(this.offers[e].TREE[d],a)){a[a.length]=this.offers[e].TREE[d]}}f=true}else{for(var e=0;e<this.offers.length;e++){var g=true;for(var c in b){if(b[c]!=this.offers[e].TREE[c]){g=false;break}}if(g){if(!BX.util.in_array(this.offers[e].TREE[d],a)){a[a.length]=this.offers[e].TREE[d]}f=true}}}return(f?a:false)};JCCatalogSection.prototype.GetCanBuy=function(a){var d=false;for(var c=0;c<this.offers.length;c++){var e=true;for(var b in a){if(a[b]!=this.offers[c].TREE[b]){e=false;break}}if(e){if(this.offers[c].CAN_BUY){d=true;break}}}return d};JCCatalogSection.prototype.SetCurrent=function(){var c={};var h=this.offers[this.offerNum].TREE;for(var f=0;f<this.treeProps.length;f++){var g="PROP_"+this.treeProps[f].ID;var e=this.GetRowValues(c,g);if(!e){break}if(BX.util.in_array(h[g],e)){c[g]=h[g]}else{c[g]=e[0];this.offerNum=0}if(this.showAbsent){var a=[];var b=[];b=BX.clone(c,true);for(var d=0;d<e.length;d++){b[g]=e[d];if(this.GetCanBuy(b)){a[a.length]=e[d]}}}else{var a=e}this.UpdateRow(f,c[g],e,a)}this.selectedValues=c;this.ChangeInfo()};JCCatalogSection.prototype.ChangeInfo=function(){var b=-1;for(var c=0;c<this.offers.length;c++){var d=true;for(var a in this.selectedValues){if(this.selectedValues[a]!=this.offers[c].TREE[a]){d=false;break}}if(d){b=c;break}}if(-1<b){if(!!this.obPict){if(!!this.offers[b].PREVIEW_PICTURE){BX.adjust(this.obPict,{style:{backgroundImage:"url("+this.offers[b].PREVIEW_PICTURE.SRC+")"}})}else{BX.adjust(this.obPict,{style:{backgroundImage:"url("+this.defaultPict.pict.SRC+")"}})}}if(this.secondPict&&!!this.obSecondPict){if(!!this.offers[b].PREVIEW_PICTURE_SECOND){BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.offers[b].PREVIEW_PICTURE_SECOND.SRC+")"}})}else{if(!!this.offers[b].PREVIEW_PICTURE.SRC){BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.offers[b].PREVIEW_PICTURE.SRC+")"}})}else{if(!!this.defaultPict.secondPict){BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.defaultPict.secondPict.SRC+")"}})}else{BX.adjust(this.obSecondPict,{style:{backgroundImage:"url("+this.defaultPict.pict.SRC+")"}})}}}}if(this.showSkuProps&&!!this.obSkuProps){if(0==this.offers[b].DISPLAY_PROPERTIES.length){BX.adjust(this.obSkuProps,{style:{display:"none"},html:""})}else{BX.adjust(this.obSkuProps,{style:{display:""},html:this.offers[b].DISPLAY_PROPERTIES})}}if(!!this.obPrice){var e=this.offers[b].PRICE.PRINT_DISCOUNT_VALUE;if(this.showOldPrice&&(this.offers[b].PRICE.DISCOUNT_VALUE!=this.offers[b].PRICE.VALUE)){e+=" <span>"+this.offers[b].PRICE.PRINT_VALUE+"</span>"}BX.adjust(this.obPrice,{html:e});if(this.showPercent){if(this.offers[b].PRICE.DISCOUNT_VALUE!=this.offers[b].PRICE.VALUE){var f={style:{display:""},html:this.offers[b].PRICE.DISCOUNT_DIFF_PERCENT}}else{var f={style:{display:"none"},html:""}}if(!!this.obDscPerc){BX.adjust(this.obDscPerc,f)}if(!!this.obSecondDscPerc){BX.adjust(this.obSecondDscPerc,f)}}}this.offerNum=b;if(this.showQuantity){this.QuantitySet(this.offerNum)}}};JCCatalogSection.prototype.Basket=function(){if(!this.canBuy){return}var a={sessid:BX.bitrix_sessid(),action:"ADD2BASKET",ajax_basket:"Y"};switch(this.productType){case 1:case 2:a.id=this.product.id;if(this.showQuantity){a.quantity=this.obQuantity.value}break;case 3:a.id=this.offers[this.offerNum].ID;if(this.showQuantity){a.quantity=this.obQuantity.value}break;default:return}BX.ajax.loadJSON(this.ajaxPath,a,BX.delegate(this.ShowBasketPopup,this))};JCCatalogSection.prototype.ShowBasketPopup=function(c){var b="";if("object"==typeof(c)){if("OK"==c.STATUS){strName="";strPict="";switch(this.productType){case 1:case 2:strName=this.product.name;strPict=this.product.pict.SRC;break;case 3:strName=this.offers[this.offerNum].NAME;strPict=this.offers[this.offerNum].PREVIEW_PICTURE.SRC;break}b="<p>"+BX.message("ADD_TO_BASKET_OK")+"</p>";b+='<img src="'+strPict+'" height="130"><p>'+strName+"</p>"}else{}}else{}var a=BX.PopupWindowManager.create("CatalogSectionBasket"+this.visual.ID,null,{autoHide:false,offsetLeft:0,offsetTop:0,overlay:true,draggable:{restrict:true},closeByEsc:true,closeIcon:{right:"12px",top:"10px"},content:'<div style="width:300px;text-align: center;padding-top:5px; margin-bottom: 10px;">'+b+'<a class="bx_bt_blue bx_medium" href="'+BX.message("setButtonBuyUrl")+'"><span class="bx_icon_cart"></span><span>'+BX.message("setButtonBuyName")+"</span></a></div>"});a.show()};