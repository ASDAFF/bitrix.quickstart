<? $GLOBALS['_2026840564_']=Array('intva' .'l','int' .'v' .'a' .'l','s' .'trval','' .'abs','flo' .'atval','abs','floatva' .'l','intval','intval','in_' .'ar' .'r' .'ay','is_nu' .'meric','' .'is_numer' .'ic','i' .'n' .'tval','intv' .'al','' .'i' .'n_a' .'rr' .'a' .'y','' .'in_arr' .'ay','preg_repl' .'ac' .'e','in' .'t' .'val','intv' .'al','in' .'tval','int' .'val','in' .'tval','' .'int' .'val','intval','in' .'t' .'val','' .'i' .'nt' .'va' .'l','intval','intval','in' .'_array','is_arr' .'ay','is_array','da' .'te','time','i' .'n' .'_array','is' .'_array','i' .'s' .'_a' .'rray','' .'is_array','is_a' .'r' .'ra' .'y','in' .'tval','i' .'n' .'_array','in_' .'a' .'rray','preg_repla' .'ce','array_keys','i' .'ntval'); ?><? function _866243488($i){$a=Array('NAME','NAME','QUANTITY','QUANTITY','PRICE','PRICE','NAME','QUANTITY','PRICE',"NAME",'NAME',"QUANTITY",'QUANTITY',"PRICE",'PRICE','NAME','QUANTITY','PRICE','NAME','NAME','NAME','QUANTITY','QUANTITY','QUANTITY','QUANTITY','PRICE','PRICE','PRICE','PRICE','/^(>=|<=|=|!|>|<)/','','ORDER','ITEM','NAME','QUANTITY','PRICE','SID','SID','VALUE','PROPERTY','VALUE','DELIVERY','DELIVERY','DELIVERY','DELIVERY','PAYMENT','PAYMENT','PAYMENT','PAYMENT','STATUS','STATUS','STATUS','STATUS','CURRENCY','CURRENCY','CURRENCY',"",'CURRENCY',"",'ITEMS','PROPERTIES','USER','USER','DATE_CREATE','Y-m-d H:i:s','PROPERTIES','SID','SID','SID','SID','SID','SID','USER','USER','USER','DELIVERY','DELIVERY','DELIVERY','PAYMENT','PAYMENT','PAYMENT','STATUS','STATUS','STATUS','CURRENCY','CURRENCY','CURRENCY','SID','DATE_CREATE','DATE_CREATE','/^(>=|<=|=|!|>|<)/','','ITEMS','ID','ORDER','ITEMS','ITEM',"ITEM",'ITEM',"NAME",'NAME',"QUANTITY",'QUANTITY',"PRICE",'PRICE','ORDER','PROPERTIES','PROPERTY','VALUE','DELIVERY','ITEMS','PRICE','QUANTITY','PRICE','CURRENCY','AMOUNT');return $a[$i];} ?><? class CStartShopOrder extends CStartShop implements CStartShopInterface{private static $arFieldsEditable=array('USER','SID','DELIVERY','PAYMENT','STATUS','CURRENCY','PAYED');public static function getArFieldsEditable(){return static::$arFieldsEditable;}private static $arFieldsFiltering=array('ID','USER','SID','DELIVERY','PAYMENT','STATUS','CURRENCY','PAYED','DATE_CREATE');public static function getArFieldsFiltering(){return static::$arFieldsFiltering;}public static function AddItem($_0,$_1,$_2){$_0=$GLOBALS['_2026840564_'][0]($_0);$_1=$GLOBALS['_2026840564_'][1]($_1);$_2[_866243488(0)]=$GLOBALS['_2026840564_'][2]($_2[_866243488(1)]);$_2[_866243488(2)]=$GLOBALS['_2026840564_'][3]($GLOBALS['_2026840564_'][4]($_2[_866243488(3)]));$_2[_866243488(4)]=$GLOBALS['_2026840564_'][5]($GLOBALS['_2026840564_'][6]($_2[_866243488(5)]));if(!empty($_2[_866243488(6)])&&!empty($_2[_866243488(7)])&&!empty($_2[_866243488(8)])){CStartShopDBQueryBX::Insert()->Into('startshop_order_items')->Values(array('ORDER'=> $_0,'ITEM'=> $_1,'NAME'=> $_2['NAME'],'QUANTITY'=> $_2['QUANTITY'],'PRICE'=> $_2['PRICE']))->Execute();return true;}return false;}public static function UpdateItem($_0,$_1,$_2){$_0=$GLOBALS['_2026840564_'][7]($_0);$_1=$GLOBALS['_2026840564_'][8]($_1);$_2=array(_866243488(9)=> $_2[_866243488(10)],_866243488(11)=> $_2[_866243488(12)],_866243488(13)=> $_2[_866243488(14)],);$_2=CStartShopUtil::ArrayFilter($_2,function($_3){return $GLOBALS['_2026840564_'][9]($_3,array(_866243488(15),_866243488(16),_866243488(17)));},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);if(isset($_2[_866243488(18)])&& empty($_2[_866243488(19)]))unset($_2[_866243488(20)]);if(isset($_2[_866243488(21)])&&(!$GLOBALS['_2026840564_'][10]($_2[_866243488(22)])|| $_2[_866243488(23)]<round(0)))unset($_2[_866243488(24)]);if(isset($_2[_866243488(25)])&&(!$GLOBALS['_2026840564_'][11]($_2[_866243488(26)])|| $_2[_866243488(27)]<round(0)))unset($_2[_866243488(28)]);if(!empty($_2)){CStartShopDBQueryBX::Update()->Tables('startshop_order_items')->Values($_2)->Where(array('ORDER'=> $_0,'ITEM'=> $_1))->Execute();}else{return false;}return true;}public static function GetItem($_0,$_1){$_0=$GLOBALS['_2026840564_'][12]($_0);$_1=$GLOBALS['_2026840564_'][13]($_1);return CStartShopDBQueryBX::Select()->From('startshop_order_items')->Where(array('ORDER'=> $_0,'ITEM'=> $_1))->Execute();}public static function GetItemsList($_4=array(),$_5=array()){$_4=CStartShopUtil::ArrayFilter($_4,function($_3){return $GLOBALS['_2026840564_'][14]($_3,array('ORDER','ITEM','NAME','QUANTITY','PRICE'));},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);$_5=CStartShopUtil::ArrayFilter($_5,function($_3){return $GLOBALS['_2026840564_'][15]($GLOBALS['_2026840564_'][16](_866243488(29),_866243488(30),$_3),array(_866243488(31),_866243488(32),_866243488(33),_866243488(34),_866243488(35)));},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);return CStartShopDBQueryBX::Select()->From('startshop_order_items')->Where($_5)->OrderBy($_4)->Execute();}public static function DeleteItem($_0,$_1){$_0=$GLOBALS['_2026840564_'][17]($_0);$_1=$GLOBALS['_2026840564_'][18]($_1);CStartShopDBQueryBX::Delete()->From('startshop_order_items')->Where(array('ORDER'=> $_0,'ITEM'=> $_1))->Execute();return true;}public static function DeleteItems($_0){$_0=$GLOBALS['_2026840564_'][19]($_0);CStartShopDBQueryBX::Delete()->From('startshop_order_items')->Where(array('ORDER'=> $_0))->Execute();return true;}public static function DeleteItemsAll(){CStartShopDBQueryBX::Delete()->From('startshop_order_items')->Execute();return true;}public static function SetProperty($_0,$_6,$_7){$_0=$GLOBALS['_2026840564_'][20]($_0);$_6=$GLOBALS['_2026840564_'][21]($_6);$_8=CStartShopOrder::GetByID($_0)->Fetch();$_9=CStartShopOrderProperty::GetByID($_6)->Fetch();if(!empty($_8)&&!empty($_9)&& $_8[_866243488(36)]== $_9[_866243488(37)]){$_10=(bool)CStartShopDBQueryBX::Select()->From('startshop_order_properties_values')->Where(array('ORDER'=> $_0,'PROPERTY'=> $_6))->Execute()->Fetch();if($_10){CStartShopDBQueryBX::Update()->Tables('startshop_order_properties_values')->Values(array('VALUE'=> $_7))->Execute();}else{CStartShopDBQueryBX::Insert()->Into('startshop_order_properties_values')->Values(array('ORDER'=> $_0,'PROPERTY'=> $_6,'VALUE'=> $_7))->Execute();}return true;}return false;}public static function GetProperty($_0,$_6){$_0=$GLOBALS['_2026840564_'][22]($_0);$_6=$GLOBALS['_2026840564_'][23]($_6);$_11=CStartShopDBQueryBX::Select()->From('startshop_order_properties_values')->Where(array('ORDER'=> $_0,'PROPERTY'=> $_6))->Execute()->Fetch();return $_11[_866243488(38)];}public static function GetProperties($_0){$_0=$GLOBALS['_2026840564_'][24]($_0);$_12=array();$_13=CStartShopDBQueryBX::Select()->From('startshop_order_properties_values')->Where(array('ORDER'=> $_0))->Execute();while($_11=$_13->Fetch())$_12[$_11[_866243488(39)]]=$_11[_866243488(40)];return $_12;}public static function DeleteProperty($_0,$_6){$_0=$GLOBALS['_2026840564_'][25]($_0);$_6=$GLOBALS['_2026840564_'][26]($_6);CStartShopDBQueryBX::Delete()->From('startshop_order_properties_values')->Where(array('ORDER'=> $_0,'PROPERTY'=> $_6))->Execute();return true;}public static function DeleteProperties($_0){$_0=$GLOBALS['_2026840564_'][27]($_0);CStartShopDBQueryBX::Delete()->From('startshop_order_properties_values')->Where(array('ORDER'=> $_0))->Execute();return true;}public static function DeletePropertiesAll(){CStartShopDBQueryBX::Delete()->From('startshop_order_properties_values')->Execute();return true;}private static function CheckFields($_14,$_15){$_16=array();if(!empty($_15)){$_16=CSite::GetByID($_15)->Fetch();if(empty($_16))return false;}if(isset($_14[_866243488(41)]))if(!empty($_14[_866243488(42)])){if(!CStartShopDelivery::GetList(array(),array('ID'=> $_14['DELIVERY'],'SID'=> $_16['ID']))->Fetch())$_14[_866243488(43)]=round(0);}else{$_14[_866243488(44)]=round(0);}if(isset($_14[_866243488(45)]))if(!empty($_14[_866243488(46)])){if(!CStartShopPayment::GetList(array(),array('ID'=> $_14['PAYMENT']))->Fetch())$_14[_866243488(47)]=round(0);}else{$_14[_866243488(48)]=round(0);}if(isset($_14[_866243488(49)]))if(!empty($_14[_866243488(50)])){if(!CStartShopOrderStatus::GetList(array(),array('ID'=> $_14['STATUS'],'SID'=> $_16['ID']))->Fetch())$_14[_866243488(51)]=round(0);}else{$_14[_866243488(52)]=round(0);}if(isset($_14[_866243488(53)]))if(!empty($_14[_866243488(54)])){if(!CStartShopCurrency::GetList(array(),array("CODE"=> $_14['CURRENCY']))->Fetch())$_14[_866243488(55)]=_866243488(56);}else{$_14[_866243488(57)]=_866243488(58);}return $_14;}public static function Add($_14){if(empty($_14['SID']))return false;$_17=$_14[_866243488(59)];$_18=$_14[_866243488(60)];$_14=CStartShopUtil::ArrayFilter($_14,function($_3){return $GLOBALS['_2026840564_'][28]($_3,CStartShopOrder::getArFieldsEditable());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);if(!$GLOBALS['_2026840564_'][29]($_17))$_17=array();if(!$GLOBALS['_2026840564_'][30]($_18))$_18=array();if(!isset($_14[_866243488(61)]))$_14[_866243488(62)]=null;$_14=static::CheckFields($_14,$_14['SID']);if($_14 === false)return false;$_14[_866243488(63)]=$GLOBALS['_2026840564_'][31](_866243488(64),$GLOBALS['_2026840564_'][32]());$_19=CStartShopDBQueryBX::Insert()->Into('startshop_order')->Values($_14)->Execute();if($_19){foreach($_17 as $_1 => $_2)static::AddItem($_19,$_1,$_2);foreach($_18 as $_6 => $_20)static::SetProperty($_19,$_6,$_20);CStartShopToolsIBlock::UpdatePropertiesAll();return $_19;}return false;}public static function Update($_0,$_14=array()){$_17=$_14['ITEMS'];$_18=$_14[_866243488(65)];$_8=static::GetByID($_0)->Fetch();if(empty($_8))return false;$_14=CStartShopUtil::ArrayFilter($_14,function($_3){return $GLOBALS['_2026840564_'][33]($_3,CStartShopOrder::getArFieldsEditable());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);if(!$GLOBALS['_2026840564_'][34]($_17))$_17=false;if(!$GLOBALS['_2026840564_'][35]($_18))$_18=false;if(isset($_14[_866243488(66)])&& empty($_14[_866243488(67)]))unset($_14[_866243488(68)]);if(!empty($_14[_866243488(69)])&& $_14[_866243488(70)]!= $_8[_866243488(71)])self::DeleteProperties($_0);if(isset($_14[_866243488(72)])&& empty($_14[_866243488(73)]))$_14[_866243488(74)]=null;if(!isset($_14[_866243488(75)]))$_14[_866243488(76)]=$_8[_866243488(77)];if(!isset($_14[_866243488(78)]))$_14[_866243488(79)]=$_8[_866243488(80)];if(!isset($_14[_866243488(81)]))$_14[_866243488(82)]=$_8[_866243488(83)];if(!isset($_14[_866243488(84)]))$_14[_866243488(85)]=$_8[_866243488(86)];$_14=static::CheckFields($_14,!empty($_14['SID'])?$_14['SID']:$_8[_866243488(87)]);if($_14 === false)return false;if(!empty($_14)){$_14[_866243488(88)]=$_8[_866243488(89)];CStartShopDBQueryBX::Update()->Tables('startshop_order')->Values($_14)->Where(array('ID'=> $_0))->Execute();}if($GLOBALS['_2026840564_'][36]($_17)){static::DeleteItems($_0);foreach($_17 as $_1 => $_2)static::AddItem($_0,$_1,$_2);}if($GLOBALS['_2026840564_'][37]($_18)){static::DeleteProperties($_0);foreach($_18 as $_6 => $_20)static::SetProperty($_0,$_6,$_20);}return true;}public static function Delete($_0){$_0=$GLOBALS['_2026840564_'][38]($_0);CStartShopDBQueryBX::Delete()->From('startshop_order')->Where(array('ID'=> $_0))->Execute();static::DeleteItems($_0);static::DeleteProperties($_0);return true;}public static function DeleteAll(){CStartShopDBQueryBX::Delete()->From('startshop_order')->Execute();static::DeleteItemsAll();static::DeletePropertiesAll();return true;}public static function GetList($_4=array(),$_5=array()){$_21=array();$_4=CStartShopUtil::ArrayFilter($_4,function($_3){return $GLOBALS['_2026840564_'][39]($_3,CStartShopOrder::getArFieldsFiltering());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);$_5=CStartShopUtil::ArrayFilter($_5,function($_3){return $GLOBALS['_2026840564_'][40]($GLOBALS['_2026840564_'][41](_866243488(90),_866243488(91),$_3),CStartShopOrder::getArFieldsFiltering());},STARTSHOP_UTIL_ARRAY_FILTER_USE_KEY);$_22=CStartShopDBQueryBX::Select()->From('startshop_order')->Where($_5)->OrderBy($_4)->Execute();while($_8=$_22->Fetch()){$_8[_866243488(92)]=array();$_21[$_8[_866243488(93)]]=$_8;}unset($_8);if(!empty($_21)){$_23=$GLOBALS['_2026840564_'][42]($_21);$_24=CStartShopDBQueryBX::Select()->From('startshop_order_items')->Where(array('ORDER'=> $_23))->Execute();$_25=CStartShopDBQueryBX::Select()->From('startshop_order_properties_values')->Where(array('ORDER'=> $_23))->Execute();while($_2=$_24->Fetch())$_21[$_2[_866243488(94)]][_866243488(95)][$_2[_866243488(96)]]=array(_866243488(97)=> $_2[_866243488(98)],_866243488(99)=> $_2[_866243488(100)],_866243488(101)=> $_2[_866243488(102)],_866243488(103)=> $_2[_866243488(104)],);while($_9=$_25->Fetch())$_21[$_9[_866243488(105)]][_866243488(106)][$_9[_866243488(107)]]=$_9[_866243488(108)];}foreach($_21 as $_0 => $_8){$_26=array();if(!empty($_8[_866243488(109)]))$_26=CStartShopDelivery::GetByID($_8['DELIVERY'])->Fetch();$_27=round(0);foreach($_8[_866243488(110)]as $_2){$_27 += $_2[_866243488(111)]*$_2[_866243488(112)];}if(!empty($_26))if(!empty($_26[_866243488(113)]))$_27 += CStartShopCurrency::Convert($_26['PRICE'],null,$_8[_866243488(114)]);$_21[$_0][_866243488(115)]=$_27;}return CStartShopUtil::ArrayToDBResult($_21);}public static function GetByID($_0){$_0=$GLOBALS['_2026840564_'][43]($_0);return static::GetList(array(),array('ID'=> $_0));}} ?>
