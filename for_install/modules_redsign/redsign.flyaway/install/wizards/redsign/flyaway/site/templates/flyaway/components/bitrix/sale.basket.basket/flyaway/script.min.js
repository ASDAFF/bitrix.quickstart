function updateBasketTable(Q,M){var w=BX("basket_items"),ab,V,q,D,b,B,U=false,J=false,ac=false,C=false,m,F,T,aa,h,x,R,u,d,y,Z,H,r,f,O,ad,E,l,t,I,p,W,o,s,Y,S,A,c,z,X,a,N,n,v,g,L;if(!w||typeof M!=="object"){return}ab=w.rows;D=ab[ab.length-1];m=(M.PARAMS.QUANTITY_FLOAT==="Y");if(Q!==null&&!!M.BASKET_DATA){V=M.BASKET_ID;q=M.BASKET_DATA.GRID.ROWS[V];var P=$("tr[id="+q.ID+"]");if(q.SKU_DATA){$.each(q.PROPS,function(ae,j){var i=undefined;$.each(q.SKU_DATA,function(af,ag){if(ag.C0DE=j.CODE){$.each(ag.VALUES,function(ah,ai){if(ai.NAME==j.VALUE){i=ai}})}});if(i){var k=$("tr[id="+q.ID+"] .js-sku-prop__"+j.CODE);if(k.data("sku-prop-type")=="image"){k.find(".js-sku_prop").removeClass("active");k.find(".js-sku_prop[data-value-id="+i.XML_ID+"]").addClass("active")}else{k.find(".js-sku_prop-value").html(i.NAME)}}})}P.find(".js-item_name").html(q.NAME);var x=undefined;if(q.PREVIEW_PICTURE_SRC.length>0){x=q.PREVIEW_PICTURE_SRC}else{if(q.DETAIL_PICTURE_SRC.length>0){x=q.DETAIL_PICTURE_SRC}}if(x){P.find(".js-item_picture").css("background-image","url("+x+")")}}if(!!M.BASKET_DATA){for(N in M.BASKET_DATA.GRID.ROWS){if(M.BASKET_DATA.GRID.ROWS.hasOwnProperty(N)){var K=M.BASKET_DATA.GRID.ROWS[N];var e=$("tr.js-element[id="+N+"]");e.find(".js-item-price").html(K.PRICE_FORMATED);e.find(".js-item-sum").html(K.SUM);if(BX("QUANTITY_"+N)){BX("QUANTITY_INPUT_"+N).value=K.QUANTITY;BX("QUANTITY_INPUT_"+N).defaultValue=K.QUANTITY;BX("QUANTITY_"+N).value=K.QUANTITY;e.find(".js-quantity-select").each(function(j,k){var i=$(k);if(i.data("redsign.select")&&i.data("redsign.select").getValue()!=K.QUANTITY){console.log(N);i.data("redsign.select").setValue(K.QUANTITY,K.QUANTITY+" "+K.MEASURE_TEXT)}})}}}}if(!!M.BASKET_DATA){couponListUpdate(M.BASKET_DATA)}if(M.hasOwnProperty("WARNING_MESSAGE")){var G="";for(aa=M.WARNING_MESSAGE.length-1;aa>=0;aa--){G+=M.WARNING_MESSAGE[aa]+"<br/>"}BX("warning_message").innerHTML=G}if(!!M.BASKET_DATA){if(BX("allWeight_FORMATED")){BX("allWeight_FORMATED").innerHTML=M.BASKET_DATA["allWeight_FORMATED"].replace(/\s/g,"&nbsp;")}if(BX("allSum_wVAT_FORMATED")){BX("allSum_wVAT_FORMATED").innerHTML=M.BASKET_DATA["allSum_wVAT_FORMATED"].replace(/\s/g,"&nbsp;")}if(BX("allVATSum_FORMATED")){BX("allVATSum_FORMATED").innerHTML=M.BASKET_DATA["allVATSum_FORMATED"].replace(/\s/g,"&nbsp;")}if(BX("allSum_FORMATED")){BX("allSum_FORMATED").innerHTML=M.BASKET_DATA["allSum_FORMATED"].replace(/\s/g,"&nbsp;")}if(BX("PRICE_WITHOUT_DISCOUNT")){BX("PRICE_WITHOUT_DISCOUNT").innerHTML=(M.BASKET_DATA["PRICE_WITHOUT_DISCOUNT"]!=M.BASKET_DATA["allSum_FORMATED"])?M.BASKET_DATA["PRICE_WITHOUT_DISCOUNT"].replace(/\s/g,"&nbsp;"):""}BX.onCustomEvent("OnBasketChange")}}function couponCreate(a,b){var c="";if(!BX.type.isElementNode(a)){return}if(b.JS_STATUS==="BAD"){c="red"}else{if(b.JS_STATUS==="APPLYED"){c="green"}}var d=$(a);d.find("tbody").append($("<tr></tr>").append($("<td></td>").addClass("personal-panel__coupons-icon").html('<i class="fa fa-tags"></i')).append($("<td></td>").addClass("personal-panel__coupons-value").append($("<input>").attr("type","hidden").attr("name","OLD_COUPON[]").attr("value",b.COUPON)).append(b.COUPON)).append($("<td></td>").addClass("personal-panel__coupons-text").append($("<span></span>").css("color",c).html(b.JS_CHECK_CODE))).append($("<td></td>").addClass("personal-panel__coupons-remove").append($("<a></a>").attr("href","javascript:void(0)").attr("data-coupon",b.COUPON).html('<i class="fa fa-times"></i>'))))}function couponListUpdate(g){var d,a,c,b,l,k,f,e,h;if(!!g&&typeof g!=="object"){return}d=BX("coupons_block");if(!!d){if(!!g.COUPON_LIST&&BX.type.isArray(g.COUPON_LIST)){b=BX("coupon");if(!!b){b.value=""}l=BX.findChildren(d,{tagName:"input",property:{name:"OLD_COUPON[]"}},true);if(!!l){if(BX.type.isElementNode(l)){l=[l]}for(f=0;f<g.COUPON_LIST.length;f++){k=false;h=-1;for(e=0;e<l.length;e++){if(l[e].value===g.COUPON_LIST[f].COUPON){k=true;h=e;l[e].couponUpdate=true;break}}if(k){c="";if(g.COUPON_LIST[f].JS_STATUS==="BAD"){a="red"}else{if(g.COUPON_LIST[f].JS_STATUS==="APPLYED"){a="green"}}BX.adjust(l[h],{props:{className:a}});BX.adjust(l[h].parentNode.nextElementSibling.children,{props:{style:"color: "+c}});BX.adjust(l[h].parentNode.nextElementSibling.children,{html:g.COUPON_LIST[f].JS_CHECK_CODE})}else{couponCreate(d,g.COUPON_LIST[f])}}for(e=0;e<l.length;e++){if(typeof(l[e].couponUpdate)==="undefined"||!l[e].couponUpdate){BX.remove(l[e].parentNode.parentNode);l[e]=null}else{l[e].couponUpdate=null}}}else{for(f=0;f<g.COUPON_LIST.length;f++){couponCreate(d,g.COUPON_LIST[f])}}}}d=null}function checkOut(){if(!!BX("coupon")){BX("coupon").disabled=true}BX("basket_form").submit();return true}function enterCoupon(){var a=BX("coupon");if(!!a&&!!a.value){recalcBasketAjax({coupon:a.value})}}function updateQuantity(l,d,j,c){var k=BX(l).defaultValue,b=parseFloat(BX(l).value)||0,h=false;if(j===0||j==1){h=true}else{var e=b*10000,f=j*10000,i=e%f,a=parseInt(b);if(i===0){h=true}}var g=false;if(parseInt(b)!=parseFloat(b)){g=true}b=(c===false&&g===false)?parseInt(b):parseFloat(b).toFixed(2);if(h){BX(l).defaultValue=b;BX("QUANTITY_INPUT_"+d).value=b;BX("QUANTITY_"+d).value=b;recalcBasketAjax({})}else{b=getCorrectRatioQuantity(b,j,c);if(b!=k){BX("QUANTITY_INPUT_"+d).value=b;BX("QUANTITY_"+d).value=b;recalcBasketAjax({})}else{BX(l).value=k}}}function getCorrectRatioQuantity(d,h,a){var b=d*10000,c=h*10000,g=b%c,j=d,e=false,f;h=parseFloat(h);if(g===0){return j}if(h!==0&&h!=1){for(f=h,max=parseFloat(d)+parseFloat(h);f<=max;f=parseFloat(parseFloat(f)+parseFloat(h)).toFixed(2)){j=f}}else{if(h===1){j=d|0}}if(parseInt(j,10)!=parseFloat(j)){e=true}j=(a===false&&e===false)?parseInt(j,10):parseFloat(j).toFixed(2);return j}function recalcBasketAjax(h){var g=$("#basket_items");if(h.coupon||h.delete_coupon){g=$(".js-personal-panel")}rsFlyaway.darken(g);var e={},d=BX("action_var").value,b=BX("basket_items"),f=BX("delayed_items"),a,c;a={sessid:BX.bitrix_sessid(),site_id:BX.message("SITE_ID"),props:e,action_var:d,select_props:BX("column_headers").value,offers_props:BX("offers_props").value,quantity_float:BX("quantity_float").value,count_discount_4_all_quantity:BX("count_discount_4_all_quantity").value,price_vat_show_value:BX("price_vat_show_value").value,hide_coupon:BX("hide_coupon").value,use_prepayment:BX("use_prepayment").value};a[d]="recalculate";if(!!h&&typeof h==="object"){for(c in h){if(h.hasOwnProperty(c)){a[c]=h[c]}}}if(!!b&&b.rows.length>0){for(c=0;b.rows.length>c;c++){if(!b.rows[c].id){continue}a["QUANTITY_"+b.rows[c].id]=BX("QUANTITY_"+b.rows[c].id).value}}if(!!f&&f.rows.length>0){for(c=1;f.rows.length>c;c++){a["DELAY_"+f.rows[c].id]="Y"}}BX.ajax({url:"/bitrix/components/bitrix/sale.basket.basket/ajax.php",method:"POST",data:a,dataType:"json",onsuccess:function(i){rsFlyaway.darken(g);updateBasketTable(null,i)}})}function clearBasket(){var e={},d=BX("action_var").value,b=BX("basket_items"),f=BX("delayed_items"),a,c;a={sessid:BX.bitrix_sessid(),site_id:BX.message("SITE_ID"),props:e,action_var:d,select_props:BX("column_headers").value,offers_props:BX("offers_props").value,quantity_float:BX("quantity_float").value,count_discount_4_all_quantity:BX("count_discount_4_all_quantity").value,price_vat_show_value:BX("price_vat_show_value").value,hide_coupon:BX("hide_coupon").value,use_prepayment:BX("use_prepayment").value};a[d]="recalculate";if(!!b&&b.rows.length>0){for(c=0;b.rows.length>c;c++){if(!b.rows[c].id){continue}a["DELETE_"+b.rows[c].id]="Y"}}BX.ajax({url:"/bitrix/components/bitrix/sale.basket.basket/ajax.php",method:"POST",data:a,dataType:"json",onsuccess:function(g){$("[name=BasketRefresh]").click();BX.onCustomEvent("OnBasketChange")}})}function deleteCoupon(c){var b=BX.proxy_context,a;if(!!b&&b.hasAttribute("data-coupon")){a=b.getAttribute("data-coupon");if(!!a&&a.length>0){recalcBasketAjax({delete_coupon:a})}}}function skuPropClickHandler(h){if(!h){h=window.event}var j=BX.proxy_context,l,n,k={},b={},f,a,g,c,d;if(!!j&&j.hasAttribute("data-value-id")){rsFlyaway.darken($("#basket_items"));l=j.getAttribute("data-element");n=j.getAttribute("data-property");f=BX("action_var").value;k[n]=j.getAttribute("data-value-id");if(BX.hasClass(j,"bx_active")){BX.closeWait();return}a=BX.findChildren(BX(l),{tagName:"ul",className:"sku_prop_list"},true);if(!!a&&a.length>0){for(g=0;a.length>g;g++){if(a[g].id!=="prop_"+n+"_"+l){c=BX.findChildren(BX(a[g].id),{tagName:"li",className:"bx_active"},true);if(!!c&&c.length>0){for(d=0;c.length>d;d++){if(c[d].hasAttribute("data-value-id")){k[c[d].getAttribute("data-property")]=c[d].getAttribute("data-value-id")}}}}}}b={basketItemId:l,sessid:BX.bitrix_sessid(),site_id:BX.message("SITE_ID"),props:k,action_var:f,select_props:BX("column_headers").value,offers_props:BX("offers_props").value,quantity_float:BX("quantity_float").value,count_discount_4_all_quantity:BX("count_discount_4_all_quantity").value,price_vat_show_value:BX("price_vat_show_value").value,hide_coupon:BX("hide_coupon").value,use_prepayment:BX("use_prepayment").value};b[f]="select_item";BX.ajax({url:"/bitrix/components/bitrix/sale.basket.basket/ajax.php",method:"POST",data:b,dataType:"json",onsuccess:function(e){rsFlyaway.darken($("#basket_items"));updateBasketTable(l,e)}})}}BX.ready(function(){var b=BX.findChildren(BX("basket_items"),{tagName:"li",className:"sku_prop"},true),c,a;if(!!b&&b.length>0){for(c=0;b.length>c;c++){BX.bind(b[c],"click",BX.delegate(function(d){skuPropClickHandler(d)},this))}}a=BX("coupons_block");if(!!a){BX.bindDelegate(a,"click",{attribute:"data-coupon"},BX.delegate(function(d){deleteCoupon(d)},this))}});if(BX){BX.oldShowWait=BX.showWait;BX.showWait=function(b){if(!b){BX.oldShowWait(b);return}var a=b.ownerDocument?$(b):$("#"+b);if(a.length){rsFlyaway.darken(a)}else{BX.oldShowWait(b)}};BX.oldCloseWait=BX.closeWait;BX.closeWait=function(b){if(!b){rsFlyaway.darken($(".area2darken"));initSelect();BX.oldCloseWait();return}var a=b.ownerDocument?$(b):$("#"+b);if(a.length){rsFlyaway.darken(a);initSelect()}else{BX.oldCloseWait(b)}BX.onCustomEvent("OnBasketChange")}}$(document).ready(function(){$(document).on("change",".js-quantity-basket-mobile",function(){var a=$(this);a.parents("tr").find("[id^=QUANTITY_INPUT_]").val(a.val()).change()});BX.addCustomEvent("onAjaxSuccess",function(){})});