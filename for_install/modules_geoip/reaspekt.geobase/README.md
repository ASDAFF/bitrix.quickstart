# Определение города по IP адресу пользователя
https://marketplace.1c-bitrix.ru/solutions/reaspekt.geobase/

**Описание** 

Модуль «Определение города по IP адресу пользователя» определяет город посетителя вашего сайта по его IP-адресу.

Модуль «Определение города по IP адресу пользователя» может использовать:
1. Локальные базы
- база онлайн-сервиса ipgeobase.ru загружается в Highload-блоки
2. Онлайн-сервисы
- ipgeobase.ru
- geoip.elib.ru

Особенности модуля:
2. Применяются локальные базы
Преимущество локальной базы данных IP-адресов в том, что сайт не зависит от внешних сервисов геопозиционирования, и их функционирование не влияет на работу модуля. Недостаток — эти БД нужно периодически обновлять, для чего в настройках предусмотрен специальный интерфейс и напоминания.
Локальные базы хранятся в Highload-блоках, что позволяет гибко настраивать города и привязку к ним.

3. Автоматическое определение местоположения
Решение автоматически определит город посетителя и может выводить окна с подтверждением города либо выбором другого, из списка или в строке поиска.

6. Поставляются готовые компоненты
В модуле присутствует компонент, необходимый для отображения выбранного местоположения и возможности его изменения пользователем. Работу компонентов Вы увидите в публичке сразу после установки решения.

7. Встроенное API
Имеется API для определения города по IP и необходимые события в методах, если функционала компонентов будет недостаточно.

Модуль «Определение города по IP адресу пользователя» работает на любой редакции «1С-Битрикс: Управление сайтом». 

***Установка***

Стандартная установка через систему обновления сайта.

Модуль работает только с версии 1С-Битрикс: Управление сайтом 14.0.0 и выше.

На этапе установки модуля будет предложено "Создать таблицы и загрузить данные геопозиционирования с сайта ipgeobase.ru" в Highload-блоки. Оставьте галочку включенной, если вы хотите пользоваться этой базой.

Если галочка установлена, модуль автоматически скачает базу местоположений с сайта.

После установки необходимо на страницу добавить компонент "Определение города по IP"

```php
<?$APPLICATION->IncludeComponent(
   "reaspekt:reaspekt.geoip",
   "",
   Array(
       "CHANGE_CITY_MANUAL" => "Y"
   )
);?>
```


Может кому пригодится. Как побороть нижеописанные баги.

1. Не загружаются базы при установке. 
Нужно переименовать функцию CArchiver в __construct
Функция находится в файле bitrix/modules/reaspekt.geobase/admin/reaspekt_geobase_update_ipgeobase.php

2. Не закрывается окно выбора города, при нажатии на "Да". 
В файле bitrix/modules/reaspekt.geobase/classes/general/geoip.php вместо
$APPLICATION->set_cookie("REASPEKT_GEOBASE_SAVE", "Y", time() + 86400); // 60*60*24
пишем:
setcookie("BITRIX_SM_REASPEKT_GEOBASE_SAVE", "Y", time() + 31104000, "/");

3. Не пропадает иконка загрузки. 
Комментируем $.fn.ReaspektModalBox('rePosition'); на строке 122 в файле local/components/reaspekt/reaspekt.geoip/templates/.default/script.js