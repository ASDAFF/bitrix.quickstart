function JsSuggest(oHandler,sParams,sParser){var t=this;t.oObj=oHandler;t.sParams=sParams;if(sParser){t.sExp=new RegExp("["+sParser+"]+","i")}else{t.sExp=new RegExp(",")}t.oLast={str:false,arr:false};t.oThis={str:false,arr:false};t.oEl={start:false,end:false};t.oUnfinedWords={};t.bReady=true;t.eFocus=true;t.aDiv=null;t.oDiv=null;t.oActive=null;t.oPointer=[];t.oPointer_default=[];t.oPointer_this="input_field";t.oObj.onblur=function(){t.eFocus=false};t.oObj.onfocus=function(){if(!t.eFocus){t.eFocus=true;setTimeout(function(){t.CheckModif("focus")},500)}};t.oLast.arr=t.oObj.value.split(t.sExp);t.oLast.str=t.oLast.arr.join(":");setTimeout(function(){t.CheckModif("this")},500);this.CheckModif=function(__data){var sThis=false,tmp=0,bUnfined=false,word="",cursor={};if(!t.eFocus){return}if(t.bReady&&t.oObj.value.length>0){t.oThis.arr=t.oObj.value.split(t.sExp);t.oThis.str=t.oThis.arr.join(":");if(t.oThis.str&&(t.oThis.str!=t.oLast.str)){cursor.position=TCJsUtils.getCursorPosition(t.oObj);if(cursor.position["end"]>0&&!t.sExp.test(t.oObj.value.substr(cursor.position["end"]-1,1))){cursor.arr=t.oObj.value.substr(0,cursor.position["end"]).split(t.sExp);sThis=t.oThis.arr[cursor.arr.length-1];t.oEl.start=cursor.position["end"]-cursor.arr[cursor.arr.length-1].length;t.oEl.end=t.oEl.start+sThis.length;t.oEl.content=sThis;t.oLast.arr=t.oThis.arr;t.oLast.str=t.oThis.str}}if(sThis){for(tmp=2;tmp<=sThis.length;tmp++){word=sThis.substr(0,tmp);if(t.oUnfinedWords[word]=="!fined"){bUnfined=true;break}}if(!bUnfined){t.Send(sThis)}}}setTimeout(function(){t.CheckModif("this")},500)};t.Send=function(sSearch){if(!sSearch){return false}var oError=[];t.bReady=false;if(BX("wait_container")){BX("wait_container").innerHTML=BX.message("JS_CORE_LOADING");BX.show(BX("wait_container"))}BX.ajax.post("/bitrix/components/bitrix/search.suggest.input/search.php",{search:sSearch,params:t.sParams},function(data){var result={};t.bReady=true;try{eval("result = "+data+";")}catch(e){oError.result_unval=e}if(TCJsUtils.empty(result)){oError.result_empty="Empty result"}try{if(TCJsUtils.empty(oError)&&(typeof result=="object")){if(!(result.length==1&&result[0]["NAME"]==t.oEl.content)){t.Show(result);return}}else{t.oUnfinedWords[t.oEl.content]="!fined"}}catch(e){oError.unknown_error=e}if(BX("wait_container")){BX.hide(BX("wait_container"))}})};t.Show=function(result){t.Destroy();t.oDiv=document.body.appendChild(document.createElement("DIV"));t.oDiv.id=t.oObj.id+"_div";t.oDiv.className="search-popup";t.oDiv.style.position="absolute";t.aDiv=t.Print(result);var pos=TCJsUtils.GetRealPos(t.oObj);t.oDiv.style.width=parseInt(pos.width)+"px";TCJsUtils.show(t.oDiv,pos.left,pos.bottom);TCJsUtils.addEvent(document,"click",t.CheckMouse);TCJsUtils.addEvent(document,"keydown",t.CheckKeyword)};t.Print=function(aArr){var aEl=null;var aResult={};var iCnt=0;var oDiv=null;var oSpan=null;var sPrefix=t.oDiv.id;for(var tmp_ in aArr){if(aArr.hasOwnProperty(tmp_)){aEl=aArr[tmp_];var aRes={};aRes.ID=(aEl.ID&&aEl.ID.length>0)?aEl.ID:iCnt++;aRes.GID=sPrefix+"_"+aRes.ID;aRes.NAME=TCJsUtils.htmlspecialcharsEx(aEl.NAME);aRes.CNT=aEl.CNT;aResult[aRes.GID]=aRes;t.oPointer.push(aRes.GID);oDiv=t.oDiv.appendChild(document.createElement("DIV"));oDiv.id=aRes.GID;oDiv.name=sPrefix+"_div";oDiv.className="search-popup-row";oDiv.onmouseover=function(){t.Init();this.className="search-popup-row-active"};oDiv.onmouseout=function(){t.Init();this.className="search-popup-row"};oDiv.onclick=function(){t.oActive=this.id};oSpan=oDiv.appendChild(document.createElement("DIV"));oSpan.id=oDiv.id+"_NAME";oSpan.className="search-popup-el search-popup-el-cnt";oSpan.innerHTML=aRes.CNT;oSpan=oDiv.appendChild(document.createElement("DIV"));oSpan.id=oDiv.id+"_NAME";oSpan.className="search-popup-el search-popup-el-name";oSpan.innerHTML=aRes.NAME}}t.oPointer.push("input_field");t.oPointer_default=t.oPointer;return aResult};t.Destroy=function(){try{TCJsUtils.hide(t.oDiv);t.oDiv.parentNode.removeChild(t.oDiv)}catch(e){}t.aDiv=[];t.oPointer=[];t.oPointer_default=[];t.oPointer_this="input_field";t.bReady=true;t.eFocus=true;t.oActive=null;TCJsUtils.removeEvent(document,"click",t.CheckMouse);TCJsUtils.removeEvent(document,"keydown",t.CheckKeyword)};t.Replace=function(){if(typeof t.oActive=="string"){var tmp=t.aDiv[t.oActive];var tmp1="";if(typeof tmp=="object"){var elEntities=document.createElement("span");elEntities.innerHTML=tmp.NAME.replace(/&quot;/g,'"').replace(/&amp;/g,"&");tmp1=elEntities.innerHTML}var start=t.oEl.start;while(start<t.oObj.value.length&&t.oObj.value.substring(start,start+1)==" "){start++}t.oObj.value=t.oObj.value.substring(0,start)+tmp1.replace(/&lt;/g,"<").replace(/&gt;/g,">")+t.oObj.value.substr(t.oEl.end);TCJsUtils.setCursorPosition(t.oObj,start+tmp1.length)}};t.Init=function(){t.oActive=false;t.oPointer=t.oPointer_default;t.Clear();t.oPointer_this="input_pointer"};t.Clear=function(){var oEl=t.oDiv.getElementsByTagName("div");if(oEl.length>0&&typeof oEl=="object"){for(var ii in oEl){if(oEl.hasOwnProperty(ii)){var oE=oEl[ii];if(oE&&(typeof oE=="object")&&(oE.name==t.oDiv.id+"_div")){oE.className="search-popup-row"}}}}};t.CheckMouse=function(){t.Replace();t.Destroy()};t.CheckKeyword=function(e){if(!e){e=window.event}var oP=null;var oEl=null;if((37<e.keyCode&&e.keyCode<41)||(e.keyCode==13)){t.Clear();switch(e.keyCode){case 38:oP=t.oPointer.pop();if(t.oPointer_this==oP){t.oPointer.unshift(oP);oP=t.oPointer.pop()}if(oP!="input_field"){t.oActive=oP;oEl=document.getElementById(oP);if(typeof oEl=="object"){oEl.className="search-popup-row-active"}}t.oPointer.unshift(oP);break;case 40:oP=t.oPointer.shift();if(t.oPointer_this==oP){t.oPointer.push(oP);oP=t.oPointer.shift()}if(oP!="input_field"){t.oActive=oP;oEl=document.getElementById(oP);if(typeof oEl=="object"){oEl.className="search-popup-row-active"}}t.oPointer.push(oP);break;case 39:t.Replace();t.Destroy();break;case 13:t.Replace();t.Destroy();break}t.oPointer_this=oP}else{t.Destroy()}}}var TCJsUtils={arEvents:[],addEvent:function(a,c,b){if(a.attachEvent){a.attachEvent("on"+c,b)}else{if(a.addEventListener){a.addEventListener(c,b,false)}else{a["on"+c]=b}}this.arEvents[this.arEvents.length]={element:a,event:c,fn:b}},removeEvent:function(a,c,b){if(a.detachEvent){a.detachEvent("on"+c,b)}else{if(a.removeEventListener){a.removeEventListener(c,b,false)}else{a["on"+c]=null}}},getCursorPosition:function(f){var j={start:0,end:0};if(!f||(typeof f!="object")){return j}try{if(document.selection!=null&&f.selectionStart==null){f.focus();var c=document.selection.createRange();var a=c.parentElement();var d=c.getBookmark();var h=f.value;var b=f.value;var i="__"+Math.random()+"__";while(h.indexOf(i)!=-1){i="__"+Math.random()+"__"}if(!a||a==null||(a.type!="textarea"&&a.type!="text")){return j}c.text=i+c.text+i;h=f.value;j.start=h.indexOf(i);h=h.replace(i,"");j.end=h.indexOf(i);f.value=b;c.moveToBookmark(d);c.select();return j}else{return{start:f.selectionStart,end:f.selectionEnd}}}catch(g){}return j},setCursorPosition:function(a,b){if(typeof a!="object"){return false}a.focus();try{if(document.selection!=null&&a.selectionStart==null){var d=document.selection.createRange();d.select()}else{a.selectionStart=b;a.selectionEnd=b}return true}catch(c){return false}},printArray:function(c,f,b){try{var a="";var h="";if(b==undefined){b=0}if(!f){f="\n"}for(var d=0;d<=b;d++){h+="  "}for(var g in c){if(c.hasOwnProperty(g)){if(typeof c[g]=="object"){a+=h+g+" = {"+f+TCJsUtils.printArray(c[g],f,b+1)+", "+f+"}"+f}else{a+=h+g+" = "+c[g]+"; "+f}}}return a}catch(k){}},empty:function(b){var a=true;if(b){for(var c in b){if(b.hasOwnProperty(c)){a=false;break}}}return a},show:function(a,c,b){if(typeof a!="object"){return}var d=parseInt(a.style.zIndex);if(d<=0||isNaN(d)){d=100}a.style.zIndex=d;a.style.left=c+"px";a.style.top=b+"px";return a},hide:function(a){if(a){a.style.display="none"}},GetRealPos:function(c){if(!c||!c.offsetParent){return false}var b={};var a=c.offsetParent;b.left=c.offsetLeft;b.top=c.offsetTop;while(a&&a.tagName!="BODY"){b.left+=a.offsetLeft;b.top+=a.offsetTop;a=a.offsetParent}b.right=b.left+c.offsetWidth;b.bottom=b.top+c.offsetHeight;b.width=c.offsetWidth;b.height=c.offsetHeight;return b},htmlspecialcharsEx:function(a){return a.replace(/&amp;/g,"&amp;amp;").replace(/&lt;/g,"&amp;lt;").replace(/&gt;/g,"&amp;gt;").replace(/&quot;/g,"&amp;quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},htmlspecialcharsback:function(a){return a.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}};