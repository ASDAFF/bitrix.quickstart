const FC_AJAXGATE=location.href;const FC_ORDERFORM=".theform";const SF_DIVPREFIX=".orderform-";const SF_SCRIPTPOSTFIX=".php";const SF_NOTREADY_HTML="";var critical=(function(){var d={};var c=[];function b(e){if(typeof e.id!=="string"){return false}if(typeof e.criticalFunction!=="function"){return false}return true}function a(f){for(var e=0;e<c.length;e++){if(c[e]==f){return true}}return false}return{enterCritical:function(e){function f(){delete d[e.id]}if(!b(e)){throw {message:"bad arguments"}}if(typeof d[e.id]!=="undefined"){return}else{d[e.id]=1;c.push(e.id);e.criticalFunction(f)}},once:function(e){if(!b(e)){throw {message:"bad arguments"}}if(a(e.id)){if(typeof e.elseFunction=="function"){e.elseFunction()}return}else{c.push(e.id);e.criticalFunction()}}}})();function FormController(a){a=a?a:{};this.ajaxgate=a.ajaxgate?a.ajaxgate:location.href;this.selReadyField=a.readyField?a.readyField:"#orderfield_READY";this.selErrorDiv=a.errorDiv?a.errorDiv:".order-errors";this.post=null;this.forms=[]}FormController.prototype.equalData=function(b,a){if($.toJSON(b)==$.toJSON(a)){return true}else{return false}};FormController.prototype.addForm=function(a){try{var b=new StepForm(a)}catch(c){throw c}b.controller=this;this.forms.push(b);return b};FormController.prototype.findForm=function(b){for(var a=0;a<this.forms.length;a++){if(this.forms[a].name==b){return this.forms[a]}}return null};FormController.prototype.makeQuery=function(a){var b=[];$.each($(a).find("input"),function(){if(this.type=="radio"){if($(this)[0].checked){b.push($(this)[0].name+"="+$(this)[0].value)}}else{b.push($(this)[0].name+"="+$(this)[0].value)}});return b.join("&")};FormController.prototype.getData=function(b){var a=this;var c=a.makeQuery(FC_ORDERFORM);$.ajax({url:FC_AJAXGATE,type:"POST",data:c,dataType:"json",success:function(d){a.post=d;if(typeof(b)=="function"){b(d)}},error:function(d){console.log("AJAX ERROR");console.log(d)}})};FormController.prototype.run=function(a){if(typeof a=="function"){a()}this.refresh()};FormController.prototype.refresh=function(){var b=this;function a(d){for(var c=0;c<d.requires.length;c++){var e=b.findForm(d.requires[c]);if(!e.isReady){return false}}return true}this.getData(function(e){b.changed=false;for(var c=0;c<b.forms.length;c++){var d=b.forms[c];if(a(d)){if(d.isBuilt){d.update(d.requiredData(e))}}}for(var c=0;c<b.forms.length;c++){var d=b.forms[c];if(a(d)){if(!d.isBuilt){d.loadView(d.requiredData(e))}}else{d.destroy()}}})};FormController.prototype.submitForm=function(){var a=this;var f=[];for(var b=0;b<this.forms.length;b++){var c=this.forms[b].validate();f=f.concat(c)}console.log(f);if(f.length>0){d(f);return false}else{$(a.selReadyField).val("ready");var e=a.makeQuery(FC_ORDERFORM);e+="&confirmorder=Y&SUBMIT_FORM=Y";$.ajax({url:FC_AJAXGATE,type:"POST",data:e,dataType:"json",success:function(g){if(typeof g.redirect=="string"){window.top.location=g.redirect}else{if(g.error.length>=1){$(a.selReadyField).val("");d(g.error)}}},error:function(g){console.log("AJAX ERROR");console.log(g)}})}function d(j){window.scrollTo(0,0);$(a.selErrorDiv).removeClass("hidden");var g="";for(var h=0;h<j.length;h++){g+='<span class="order-error">'+(j[h])+"</span>"}$(a.selErrorDiv).html(g)}};function StepForm(a){this.isReady=false;this.isBuilt=false;this.controller=null;this._fieldRules=[];if(typeof a.name=="string"){this.name=a.name}else{throw {message:"invalid name"}}if(typeof a.div=="string"){this.div=a.div}else{this.div=SF_DIVPREFIX+a.name}if(typeof a.script=="string"){this.script=a.script}else{this.script=a.name+SF_SCRIPTPOSTFIX}if(a.requires instanceof Array){this.requires=a.requires}else{this.requires=[]}if(typeof a.requiredData=="function"){this.requiredData=a.requiredData}if(typeof a.onChange=="function"){this.onChange=a.onChange}if(typeof a.onBuild=="function"){this.onBuild=a.onBuild}if(typeof a.update=="function"){this.update=a.update}if(typeof a.validate=="function"){this.validate=a.validate}}StepForm.prototype.ready=function(){this.isReady=true};StepForm.prototype.notReady=function(){this.isReady=false};StepForm.prototype.loadView=function(c,b){var a=this;if(typeof(c)=="object"){sData=$.toJSON(c)}sData=encodeURI(sData);$.ajax({url:FC_AJAXGATE,type:"POST",data:"AJAX_QUERY=Y&LOAD_STEP="+a.script+"&DATA="+sData+"&SUBMIT_FORM=N",dataType:"text",success:function(d){$(a.div).html(d);a.isBuilt=true;if(typeof a.onBuild=="function"){a.onBuild(c)}},error:function(d){console.log(a.name+".loadView: ajax error");console.log(d)},complete:function(){if(typeof(b)=="function"){b()}}})};StepForm.prototype.reload=function(c){var b=this;var a=this.controller;a.getData(function(d){b.build(b.requiredData(d),function(){if(typeof c=="function"){c()}})})};StepForm.prototype.destroy=function(){$(this.div).html(SF_NOTREADY_HTML);this.isBuilt=false};StepForm.prototype.onChange=function(){};StepForm.prototype.requiredData=function(a){return a};StepForm.prototype.update=function(){};StepForm.prototype.addFieldRule=function(a){if(typeof a.fieldname!=="string"){throw {message:"bad arguments"}}if(typeof a.regexp!=="string"){throw {message:"bad arguments"}}if(typeof a.message!=="string"){throw {message:"bad arguments"}}this._fieldRules.push({fieldname:a.fieldname,regexp:a.regexp,message:a.message});return this};StepForm.prototype.validate=function(){var e=[];console.log(this._fieldRules);for(var b=0;b<this._fieldRules.length;b++){var a="input[name="+this._fieldRules[b].fieldname+"]";if($(a).length==0||$(a).parent().is(":hidden")){continue}var c=new RegExp(this._fieldRules[b].regexp);var d=$(a).val();if(!c.test(d)){e.push(this._fieldRules[b].message)}}return e};var controller;$(document).ready(function(){controller=new FormController();controller.addForm({name:"persontype",requires:[],requiredData:function(a){return{PERSON_TYPE:a.PERSON_TYPE}}});controller.addForm({name:"properties",requires:[],requiredData:function(a){return{ORDER_PROP:a.ORDER_PROP,DELIVERY:a.DELIVERY,FIELDS:a.FIELDS}},onBuild:function(f){var n=this;function o(r,q){r=r.toLowerCase();for(var j=0;j<q.length;j++){if(q[j].CITY_NAME!=null){if(r==q[j].CITY_NAME.toLowerCase()){return q[j]}}}return null}var k=[];for(var g in f.ORDER_PROP.USER_PROPS_N){var l=f.ORDER_PROP.USER_PROPS_N[g];if(l.TYPE=="LOCATION"){k.push(l)}}for(var g=0;g<k.length;g++){var p=k[g];var h=p.VARIANTS;var a=[];for(var d=0;d<h.length;d++){a[d]={};if(h[d].CITY_NAME!==null){a[d].label=h[d].CITY_NAME;a[d].value=h[d].NAME}}var c="#"+p.FIELD_ID;var m="#"+p.FIELD_ID+"_VAL";function b(){var q=o($(m).val(),h);if(q!=null){$(m).val(q.NAME);$(c).val(q.ID);n.ready();n.onChange()}else{$(m).val("");$(c).val(0);var r=n.controller.findForm("delivery");var j=n.controller.findForm("paysystem");r.destroy();j.destroy()}}$(m).autocomplete({source:a,change:function(q,j){b()},select:function(q,j){b()}})}var e=f.FIELDS.required;for(var g=0;g<e.length;g++){$("#"+e[g]).removeClass("hidden")}},update:function(d){var a=this;function b(g,e){function f(h){for(i=0;i<this.length;i++){if(this[i]==h){return true}}return false}g.inArray=f;e.inArray=f;console.log(g);$.each($(a.div).find("tr"),function(){if(!e.inArray(this.id)){if(g.inArray(this.id)){$(this).removeClass("hidden")}else{if(!$(this).hasClass("hidden")){$(this).addClass("hidden")}}}})}var c=controller.findForm("delivery");console.log(a.controller.post.FIELDS[c.deliveryValue]);if(a.controller.post.FIELDS[c.deliveryValue] instanceof Array){b(a.controller.post.FIELDS[c.deliveryValue],a.controller.post.FIELDS.required)}},onChange:function(){var a=this;critical.enterCritical({id:"properties_onchange",criticalFunction:function(b){var c=a.controller.findForm("delivery");a.controller.getData(function(d){c.loadView(c.requiredData(d),function(){b()})})}})}}).addFieldRule({fieldname:"ORDER_PROP_2",regexp:"^[a-zA-Z0-9_.-]+@[\\w\\W]+$",message:"Некорректный e-mail адрес"}).addFieldRule({fieldname:"ORDER_PROP_3",regexp:"^[0-9а-яА-Я.,\\s]+$",message:"Введите адрес"}).addFieldRule({fieldname:"ORDER_PROP_4",regexp:"^[0-9()+]+$",message:"Введите телефон"}).addFieldRule({fieldname:"ORDER_PROP_5",regexp:"^[a-zA-Zа-яА-Я]+$",message:"Введите имя"}).addFieldRule({fieldname:"ORDER_PROP_6",regexp:"^[a-zA-Zа-яА-Я]+$",message:"Введите фамилию"}).addFieldRule({fieldname:"ORDER_PROP_7",regexp:"^[0-9]{6}$",message:"Введите индекс в формате 123456"});controller.addForm({name:"delivery",requires:["properties"],requiredData:function(a){return a.DELIVERY},onBuild:function(e){var a=this;a.notReady();a.deliveryValue="required";function b(){$.each($(a.div).find("input"),function(){if(this.type=="radio"){if($(this)[0].checked==true){$(this)[0].checked=false}}})}var d=a.controller.findForm("paysystem");d.destroy();var c=a.controller.findForm("properties");c.update();b();$(".delivery-radio").click(function(){a.ready();a.deliveryValue=this.value;a.onChange()})},update:function(a){},onChange:function(){var a=this;critical.enterCritical({id:"delivery_onchange",criticalFunction:function(d){var c=a.controller.findForm("properties");var b=a.controller.findForm("paysystem");var e=a.controller.findForm("summary");c.update();a.controller.getData(function(f){b.loadView(b.requiredData(f),function(){e.loadView(e.requiredData(f),function(){d()})})})}})}}).addFieldRule({fieldname:"PP_SMS_PHONE",regexp:"^[0-9]{11}$",message:"Заполните номер телефона для PickPoint"}).addFieldRule({fieldname:"PP_ID",regexp:"^[0-9-]+$",message:"Выберите постамат"});controller.addForm({name:"paysystem",requires:["properties","delivery"],requiredData:function(a){return{PAY_SYSTEM:a.PAY_SYSTEM,PAY_FROM_ACCOUNT:a.PAY_FROM_ACCOUNT}},onBuild:function(a){},update:function(a){},onChange:function(){critical.enterCritical({id:"paysystem_onchange",criticalFunction:function(a){var b=self.controller.findForm("summary");self.controller.getData(function(c){b.loadView(b.requiredData(c),function(){a()})})}})}});controller.addForm({name:"summary",requires:[],requiredData:function(a){return{BASKET_ITEMS:a.BASKET_ITEMS,DISCOUNT_PRICE:a.DISCOUNT_PRICE,DISCOUNT_PERCENT_FORMATED:a.DISCOUNT_PERCENT_FORMATED,DISCOUNT_PRICE_FORMATED:a.DISCOUNT_PRICE_FORMATED,DELIVERY_PRICE:a.DELIVERY_PRICE,ORDER_TOTAL_PRICE_FORMATED:a.ORDER_TOTAL_PRICE_FORMATED,DELIVERY_PRICE_FORMATED:a.DELIVERY_PRICE_FORMATED,ORDER_PRICE_FORMATED:a.ORDER_PRICE_FORMATED,ORDER_WEIGHT_FORMATED:a.ORDER_WEIGHT_FORMATED}},onBuild:function(a){},update:function(a){this.build(a)},onChange:function(){}});controller.run()});function submitForm(){controller.submitForm()};